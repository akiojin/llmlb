# マルチモデル自動起動 ExecPlan (2025-11-17)

このプランはコーディネーター／エージェントで「対応モデルを全自動で起動・同期し、OpenAI互換口はエージェント経由のみ」を実現するための実行計画です。完了条件と検証方法を明示し、進捗を逐次更新します。

## 目的 (Purpose)
- 対応モデルセット（gpt-oss:20b, gpt-oss:120b, gpt-safeguard:20b, glm4:6b-chat, qwen3-coder:32b）をコーディネーターが正として提示し、/v1/models でも同一内容を返す。
- エージェントは登録後ただちに全対応モデルを自動ダウンロードし、モデルごとに独立した Ollama プロセスを起動（ポート衝突なし、同一ホストで複数進行可）。
- コーディネーターはエージェント経由の OpenAI互換API だけを利用し、エージェントがすべての対応モデルを ready にするまでリクエストを待機（上限1024、超過は503）。
- 登録時ヘルスチェック: エージェントAPI /v1/models が応答し、少なくとも1モデルが起動済みでないと登録を拒否し「起動中」を示す。
- UI: 手動配布UIを残さず、ロード済みモデルは「全エージェント合算」表示のみ。エージェント表からモデル列を除去。

## 作業計画 (Plan of Work)
1. **対応モデルセット確定と仕様反映**
   - common/coordinator で定数化し、/api/models/available と /v1/models を同一ソースで返す。
   - モデルごとの必要VRAMと推奨を表示。サイズは実測／公式情報を取得して反映。
2. **エージェント: マルチ Ollama オーケストレーター**
   - モデルごとにポートを割り当てて `ollama serve` を子プロセス起動（同時複数、既存進行を検出して再利用）。
   - OpenAI互換 `/v1/*` を受け、モデル名→内部 Ollama インスタンスへルーティング。未起動なら起動完了まで 503(準備中)を返す。
   - ハートビートに per-model ready/total を載せ、`initializing`/`ready_models` を正しく計上。
3. **コーディネーター: 登録・待機制御の強化**
   - 登録時にエージェントの `/v1/models` を叩き、起動中なら登録を拒否し「initializing中」表示で再試行させる。
   - 既存 wait_for_ready キューを流用し、ready_models=(total) になるまで待機。上限1024超は503。
   - エージェント選択は loaded_models ではなく「reported ready_models=full」とオンライン状態を必須にする。
4. **テスト (TDD)**
   - unit: オーケストレーターのポート割当（衝突しない）、起動済み再利用、失敗時リトライ。
   - integration: 登録→全モデル起動完了→/v1/completions が成功するハッピー経路（Wiremock でオラマ代替可）。
   - integration: 全エージェント初期化中で wait→ready 通知で再開、キュー満杯で503。
   - UIスナップショット: モデル管理タブが定義された5モデルのみを表示し、手動配布要素が無いこと。
5. **ドキュメント/運用**
   - README.ja.md / specs/SPEC-8ae67d67/spec.md にアーキ図と起動フロー（エージェントが Ollama を多重起動、コーディネーターはエージェントAPIのみ叩く）を追記。
   - 起動手順（macOS M4 Max 向け）とデフォルトポート表を更新。

## 進捗 (Progress)
- [x] 2025-11-17T15:10Z  ready待機キューの挙動テストを追加し、clippy/test/markdownlint/タスクチェックを通過。
- [ ] specs 未完了タスク (自動継承)
  - SPEC-ee2aa3ef: **T025 ホットフィックスフロー確認／統合テスト(T023–T025)実行**
  - SPEC-5cd7b614: **PRマージ後の動作確認（メンテナ作業）**
- [ ] 4/5 以降: 上記手順に沿って実装・検証を進める。

## Surprises & Discoveries
- まだ無し。進行中に記載する。

## Decision Log
- 2025-11-17: キュー上限1024固定・タイムアウト無し・503で返す方針を維持。
- 2025-11-17: GPU自動選択ロジックは一旦無効化（feature フラグ付きテストに退避）し、対応モデルは固定リストで扱う。

## Outcomes & Retrospective
- 着手後に更新。
