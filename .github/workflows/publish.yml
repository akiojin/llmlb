name: publish

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to publish (defaults to latest tag)"
        required: false

permissions:
  contents: write

jobs:
  detect-release:
    name: Resolve release tag
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || startsWith(github.event.head_commit.message, 'chore(release):')
    outputs:
      release_tag: ${{ steps.resolve.outputs.release_tag }}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Resolve tag
        id: resolve
        env:
          INPUT_TAG: ${{ github.event.inputs.release_tag || '' }}
        run: |
          set -euo pipefail
          if [[ -n "$INPUT_TAG" ]]; then
            tag="$INPUT_TAG"
          else
            git fetch --tags --force
            tag=$(git describe --tags --abbrev=0 || true)
          fi

          if [[ -z "$tag" ]]; then
            echo "No release tag detected; skipping publish run"
            echo "release_tag=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Resolved release tag: $tag"
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"

  publish-binaries:
    name: Build and attach binaries
    needs: detect-release
    if: needs.detect-release.result == 'success' && needs.detect-release.outputs.release_tag != ''
    uses: ./.github/workflows/release-binaries.yml
    with:
      target_branch: main
      release_tag: ${{ needs.detect-release.outputs.release_tag }}
    secrets: inherit
