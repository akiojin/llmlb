# Test Workflow
# æ©Ÿèƒ½ID: SPEC-47c6f44c (quality-checks.ymlã‹ã‚‰åˆ†é›¢)
# ç›®çš„: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ã‚¿ã‚¹ã‚¯å®Œäº†ãƒã‚§ãƒƒã‚¯
# è¦ä»¶: FR-002 (tasks.md check), FR-003 (Rust tests), OpenAI API tests

name: Test

on:
  workflow_dispatch:
  pull_request:
    branches:
      - develop

jobs:
  # ãƒ‘ã‚¹å¤‰æ›´æ¤œå‡ºï¼ˆC++/Rustã‚¸ãƒ§ãƒ–ã®æ¡ä»¶ä»˜ãå®Ÿè¡Œç”¨ï¼‰
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
      e2e: ${{ steps.filter.outputs.e2e }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - 'llmlb/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - '.github/workflows/test.yml'
            e2e:
              - 'llmlb/tests/e2e-playwright/**'
              - 'llmlb/src/dashboard/**'
              - '.github/workflows/test.yml'

  tasks-check:
    # è¦ä»¶: FR-002
    # ç›®çš„: tasks.mdã®å…¨ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’ãƒã‚§ãƒƒã‚¯
    name: Tasks Completion Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check tasks.md completion
        run: |
          echo "ðŸ” Checking tasks.md completion..."
          chmod +x .specify/scripts/checks/check-tasks.sh
          .specify/scripts/checks/check-tasks.sh
        env:
          CI: true

  rust-test:
    # è¦ä»¶: FR-003
    # ç›®çš„: Rustãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆè¤‡æ•°OSï¼‰
    name: Rust Tests (${{ matrix.os }})
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        rust: [stable]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}

      - name: Bootstrap pest_generator
        run: cargo build --manifest-path vendor/pest_generator/bootstrap/Cargo.toml
        shell: bash

      - name: Run Rust tests
        run: |
          echo "ðŸ§ª Running Rust tests on ${{ matrix.os }}..."
          cargo test --all-features --workspace -- --test-threads=1

  openai-proxy-tests:
    # è¦ä»¶: OpenAIäº’æ›APIã®å›žå¸°ãƒ†ã‚¹ãƒˆ
    # ç›®çš„: OpenAI APIã¨ã®äº’æ›æ€§ã‚’ç¢ºèª
    name: OpenAI API Compatibility Tests
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Bootstrap pest_generator
        run: cargo build --manifest-path vendor/pest_generator/bootstrap/Cargo.toml

      - name: Run OpenAI proxy tests
        run: |
          echo "ðŸ¤– Running OpenAI-compatible API tests..."
          make openai-tests

  playwright-e2e:
    # è¦ä»¶: E2Eãƒ†ã‚¹ãƒˆï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»Playgroundï¼‰
    # ç›®çš„: Playwright ã«ã‚ˆã‚‹ãƒ–ãƒ©ã‚¦ã‚¶E2Eãƒ†ã‚¹ãƒˆ
    name: Playwright E2E Tests
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Bootstrap pest_generator
        run: cargo build --manifest-path vendor/pest_generator/bootstrap/Cargo.toml

      - name: Build llmlb
        # Use debug build to enable sk_debug API key for E2E tests
        run: cargo build -p llmlb

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Install Playwright dependencies
        working-directory: llmlb/tests/e2e-playwright
        run: |
          pnpm install
          pnpm exec playwright install --with-deps chromium

      - name: Start llmlb server
        run: |
          mkdir -p llmlb/tests/e2e-playwright/.llmlb/logs
          LLMLB_DATABASE_URL=sqlite:llmlb/tests/e2e-playwright/.llmlb/router.db \
          LLMLB_LOG_DIR=llmlb/tests/e2e-playwright/.llmlb/logs \
          ADMIN_USERNAME=admin \
          ADMIN_PASSWORD=test \
          ./target/debug/llmlb &
          # Wait for server to be ready
          for i in {1..30}; do
            if curl -s http://127.0.0.1:32768/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            echo "Waiting for server... ($i/30)"
            sleep 2
          done

      - name: Run Playwright tests
        working-directory: llmlb/tests/e2e-playwright
        run: pnpm exec playwright test --reporter=list
        env:
          SKIP_SERVER: '1'
          BASE_URL: 'http://127.0.0.1:32768'
          CI: 'true'

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: llmlb/tests/e2e-playwright/reports/
          retention-days: 7
