name: Verify Models

on:
  workflow_dispatch:
    inputs:
      model_repo:
        description: 'HuggingFace repo (e.g., bartowski/phi-4-GGUF)'
        required: true
      model_filename:
        description: 'Model filename (e.g., phi-4-Q4_K_M.gguf)'
        required: true
      model_id:
        description: 'Model ID for registration (e.g., phi4-14b)'
        required: true
      format:
        description: 'Model format'
        required: true
        default: 'safetensors'
        type: choice
        options:
          - safetensors
          - gguf
      platform:
        description: 'Target platform'
        required: true
        default: 'macos-metal'
        type: choice
        options:
          - macos-metal
          - linux-cuda
          - windows-directml
      capability:
        description: 'Model capability'
        required: true
        default: 'TextGeneration'
        type: choice
        options:
          - TextGeneration
          - Vision
          - Audio
          - Embedding
          - Reranker

jobs:
  verify:
    name: Verify ${{ inputs.model_id }} on ${{ inputs.platform }}
    runs-on: >-
      ${{
        inputs.platform == 'macos-metal' && fromJSON('["self-hosted", "macOS", "ARM64"]') ||
        inputs.platform == 'linux-cuda' && fromJSON('["self-hosted", "Linux", "CUDA"]') ||
        fromJSON('["self-hosted", "Windows"]')
      }}
    permissions:
      contents: write
      pull-requests: write
    env:
      MODEL_REPO: ${{ inputs.model_repo }}
      MODEL_FILENAME: ${{ inputs.model_filename }}
      MODEL_ID: ${{ inputs.model_id }}
      MODEL_FORMAT: ${{ inputs.format }}
      MODEL_PLATFORM: ${{ inputs.platform }}
      MODEL_CAPABILITY: ${{ inputs.capability }}
      MODEL_DIR: ./models
      BUILD_DIR: ./allm/build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup environment (macOS)
        if: inputs.platform == 'macos-metal'
        run: |
          command -v huggingface-cli || brew install huggingface-cli

      - name: Setup environment (Linux)
        if: inputs.platform == 'linux-cuda'
        run: |
          pip install huggingface_hub[cli] || true

      - name: Build llm-node
        run: |
          CMAKE_ARGS=""
          if [[ "$MODEL_PLATFORM" == "macos-metal" ]]; then
            CMAKE_ARGS="-DBUILD_WITH_METAL=ON"
          elif [[ "$MODEL_PLATFORM" == "linux-cuda" ]]; then
            CMAKE_ARGS="-DBUILD_WITH_CUDA=ON"
          fi
          cmake -S allm -B "$BUILD_DIR" $CMAKE_ARGS -DBUILD_TESTS=OFF
          cmake --build "$BUILD_DIR" --config Release

      - name: Download model
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          mkdir -p "$MODEL_DIR"
          huggingface-cli download "$MODEL_REPO" "$MODEL_FILENAME" --local-dir "$MODEL_DIR"

      - name: Run verification tests
        run: |
          .specify/scripts/model-verification/run-verification.sh \
            --model "$MODEL_DIR/$MODEL_FILENAME" \
            --format "$MODEL_FORMAT" \
            --capability "$MODEL_CAPABILITY" \
            --platform "$MODEL_PLATFORM"

      - name: Add to supported models
        if: success()
        run: |
          .specify/scripts/add-supported-model.sh \
            --model-id "$MODEL_ID" \
            --repo "$MODEL_REPO" \
            --filename "$MODEL_FILENAME" \
            --format "$MODEL_FORMAT" \
            --capability "$MODEL_CAPABILITY" \
            --platform "$MODEL_PLATFORM"

      - name: Create PR
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH="verify/${MODEL_ID}-${MODEL_PLATFORM}"
          git checkout -b "$BRANCH"
          git add router/src/supported_models.json
          git commit -m "feat(models): add ${MODEL_ID} (${MODEL_PLATFORM})"
          git push origin "$BRANCH"
          gh pr create \
            --base develop \
            --head "$BRANCH" \
            --title "feat(models): Add ${MODEL_ID} to supported models (${MODEL_PLATFORM})" \
            --body "## Model Verification Results

          - **Model ID**: ${MODEL_ID}
          - **Repository**: ${MODEL_REPO}
          - **Filename**: ${MODEL_FILENAME}
          - **Format**: ${MODEL_FORMAT}
          - **Capability**: ${MODEL_CAPABILITY}
          - **Platform**: ${MODEL_PLATFORM}

          Automated verification passed.

          ---
          Generated by [Claude Code](https://claude.com/claude-code)"

      - name: Upload verification results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-results-${{ inputs.model_id }}-${{ inputs.platform }}
          path: .specify/scripts/model-verification/results/
          retention-days: 30
