# 実装計画: 推論中ノードへの多重リクエストキューイング

**機能ID**: `SPEC-05098000` | **日付**: 2025-12-26 | **仕様**: [spec.md](./spec.md)
**入力**: `/specs/SPEC-05098000/spec.md` の機能仕様

## 実行フロー (/speckit.plan コマンドのスコープ)

```text
1. 入力パスから機能仕様を読み込み
2. 技術コンテキストを記入 (要明確化をスキャン)
3. 憲章チェックセクションを評価
4. Phase 0: 既存実装と類似機能の確認
5. Phase 1: 設計方針とインターフェース定義
6. Phase 2: タスク分解 (/speckit.tasks)
```

## 概要

ロードバランサー側で推論リクエストの待機キューを管理し、各ノードは単発リクエストのみを処理する。
キューの最大サイズ・待機タイムアウトは設定可能とし、キュー満杯時は429、待機タイムアウト時は504を返す。

## 技術コンテキスト

- **言語/バージョン**: Rust 1.75+, C++17
- **対象コンポーネント**:
  - Load Balancer (Rust): キュー制御、選択ロジック、APIレスポンス
  - Node (C++): 推論中の同時リクエスト拒否 (429)
  - Dashboard (React/Vite): 待機数/処理中数の可視化
- **ストレージ**: 既存SQLite (リクエスト履歴)
- **テスト**: cargo test, Google Test, 既存テスト基盤
- **設定**: 環境変数でキューサイズ/タイムアウトを指定

## 憲章チェック

- **シンプルさ**: ロードバランサーの待機カウンタと通知を活用し、専用キュー実装は最小限
- **テスト**: Contract/Integration/Unit の順で追加、TDDを維持
- **可観測性**: 既存のリクエスト履歴/ダッシュボードに待機数を追加
- **後方互換**: 既存APIの入力/出力は維持、ヘッダ追加のみ

## 設計方針

- ロードバランサーは「オンラインかつ初期化完了」のノードのみを対象に選択する
- ノードの同時処理数は1に固定し、空きがない場合はキューで待機
- キュー待機中は待機数カウンタを増加し、完了/キャンセルで減少
- キュー満杯時は即時429とRetry-Afterヘッダを返す
- タイムアウト時は504で終了し、待機カウンタを減少
- エンドポイント側は推論中の追加リクエストを429で拒否する
- ダッシュボードには「処理中」「待機中」の数を表示

## 設定項目

- **最大待機数**: デフォルト100
- **待機タイムアウト**: デフォルト60秒
- **Retry-After**: タイムアウト値に基づく秒数を返却

## 影響範囲

- Load Balancer: `AppState` にキュー設定を追加、ロードマネージャの待機制御強化
- API: OpenAI互換エンドポイントで待機・タイムアウト・429処理を追加
- Node: OpenAI互換エンドポイントで単発リクエスト制限
- Dashboard: stats APIとUIに待機数を追加
- Tests: ロードバランサーの待機制御とノード単発制限のユニット/統合テスト

## プロジェクト構造

```text
specs/SPEC-05098000/
├── plan.md              # このファイル
└── tasks.md             # 実装タスク (/speckit.tasks)

llmlb/src/
├── balancer/mod.rs      # 待機制御・通知
├── api/openai.rs        # キュー待機/429/504/ヘッダ
├── api/proxy.rs         # ノード選択補助
├── api/dashboard.rs     # 待機数の集計
└── lib.rs               # AppState拡張

node/src/
├── api/openai_endpoints.cpp  # 単発リクエスト制限
├── api/audio_endpoints.cpp   # 共有リソースの制限
└── runtime/state.*           # アクティブ要求の管理

llmlb/src/web/dashboard/src/
├── lib/api.ts                # stats型拡張
└── components/dashboard/StatsCards.tsx  # 待機数表示
```

