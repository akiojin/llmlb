# 機能仕様書: 推論中ノードへの多重リクエストキューイング

**機能ID**: `SPEC-05098000`
**作成日**: 2025-12-24
**ステータス**: 下書き
**入力**: ユーザー説明: "推論中ノードへの多重リクエストキューイング機能。LLM推論中のノードに対して複数のリクエストが到着した場合のキューイング・待機・拒否の仕組みを定義する。"
**依存SPEC**: SPEC-589f2df1（ロードバランシングシステム）、SPEC-63acef08（統一APIプロキシ）

## 概要

LLM推論は計算コストが高く、1つのリクエストの処理に数秒から数十秒かかる場合がある。
複数のリクエストが同時に到着した場合、ノードの処理能力を超えるとシステム全体のパフォーマンスが低下する。
本機能は、**ルーター側でリクエストキューを管理**し、各ノードには**単発リクエストのみ**を送信することで、
システム全体の安定性とユーザー体験を維持する。ノードは推論処理に専念し、キュー管理の複雑さはルーターに集約される。

## ユーザーシナリオ＆テスト

### ユーザーストーリー1 - 単一ノード環境での連続リクエスト処理 (優先度: P1)

ユーザーが単一ノード環境でLLM Routerを使用している場合、
連続してリクエストを送信しても、システムがクラッシュせず順番に処理されることを期待する。

**この優先度の理由**: 単一ノード環境は最も一般的な利用形態であり、この環境での安定動作は必須。

**独立テスト**: 単一ノードに対して連続して5つのリクエストを送信し、
すべてのリクエストが順番に処理され、レスポンスが返されることで価値を提供する。

**受け入れシナリオ**:

1. **前提** 1台のノードが登録されている、**実行** 連続して3つのリクエストを送信する、
   **結果** すべてのリクエストがキューに追加され、順番に処理される
2. **前提** 1台のノードが推論中、**実行** 新しいリクエストを送信する、
   **結果** リクエストはキューに追加され、先行リクエスト完了後に処理される
3. **前提** 1台のノードが推論中でキューが空、**実行** 新しいリクエストを送信する、
   **結果** キュー待機中であることを示すレスポンスヘッダーが返される

---

### ユーザーストーリー2 - キュー溢れ時の適切なエラー通知 (優先度: P1)

ユーザーがシステムの処理能力を超える大量のリクエストを送信した場合、
明確なエラーメッセージとともにリクエストが拒否され、システムが過負荷状態にならないことを期待する。

**この優先度の理由**: システムの安定性を維持し、ユーザーに適切なフィードバックを提供することは必須。

**独立テスト**: キューが最大サイズに達した状態で追加のリクエストを送信し、
429エラーと適切なメッセージが返されることで価値を提供する。

**受け入れシナリオ**:

1. **前提** キューが最大サイズ（デフォルト: 100）に達している、**実行** 新しいリクエストを送信する、
   **結果** HTTP 429 Too Many Requests と「キューが満杯です」メッセージが返される
2. **前提** キューが最大サイズに達している、**実行** 新しいリクエストを送信する、
   **結果** Retry-Afterヘッダーで推奨待機時間が通知される

---

### ユーザーストーリー3 - タイムアウトによる長時間待機の防止 (優先度: P2)

ユーザーがリクエストを送信後、キュー内で長時間待機している場合、
適切なタイムアウトでリクエストがキャンセルされ、ユーザーに通知されることを期待する。

**この優先度の理由**: ユーザー体験の向上。無限待機を防ぎ、ユーザーが状況を把握できるようにする。

**独立テスト**: キュー待機タイムアウトを短く設定し、タイムアウト後にエラーが返されることで価値を提供する。

**受け入れシナリオ**:

1. **前提** キュー待機タイムアウトが30秒に設定、**実行** リクエストを送信し30秒以上キューで待機する、
   **結果** HTTP 504 Gateway Timeout と「キュー待機タイムアウト」メッセージが返される
2. **前提** リクエストがキュー内で待機中、**実行** クライアントが接続を切断する、
   **結果** キューからリクエストが削除される

---

### ユーザーストーリー4 - 単発リクエスト制限の動作確認 (優先度: P2)

管理者として、各ノードが単発リクエストのみを処理し、
推論中のノードには新規リクエストが送信されないことを確認できることを期待する。

**この優先度の理由**: GPUメモリの効率的な使用とシステム安定性の維持に重要。

**独立テスト**: ノードが推論中に新しいリクエストを送信し、そのリクエストがルーターのキューで待機することで価値を提供する。

**受け入れシナリオ**:

1. **前提** 1台のノードが推論中、**実行** 同時に2つのリクエストを送信する、
   **結果** 1つはキューで待機し、ノードが空くと処理開始される
2. **前提** ノードが推論中、**実行** ダッシュボードを確認する、
   **結果** 「処理中: 1」「キュー待機: 2」のように状態が表示される

---

### ユーザーストーリー5 - 複数ノード環境での効率的な分散 (優先度: P3)

複数ノード環境では、1つのノードが推論中でも、
他のアイドル状態のノードにリクエストが自動的にルーティングされることを期待する。

**この優先度の理由**: 複数ノード環境での効率的なリソース活用。

**独立テスト**: 2台のノードのうち1台が推論中の状態で、
リクエストがアイドル状態のノードにルーティングされることで価値を提供する。

**受け入れシナリオ**:

1. **前提** 2台のノードが登録され、ノードAが推論中、ノードBはアイドル、
   **実行** 新しいリクエストを送信する、**結果** リクエストはノードBにルーティングされる
2. **前提** すべてのノードが推論中かつルーターのキューが満杯、**実行** 新しいリクエストを送信する、
   **結果** HTTP 429とすべてのノードが過負荷であることを示すメッセージが返される

---

### エッジケース

- ルーターのキュー内のリクエストがタイムアウト前にノードがアイドルになった場合、リクエストは正常に処理される
- ノードがオフラインになった場合、そのノードで処理中だったリクエストはエラーを返し、キュー内のリクエストは
  他のアイドルノードに割り当てられる
- ストリーミングリクエストの場合、最初のチャンクが返されるまでキュー待機タイムアウトが適用される

## 要件

### 機能要件

- **FR-001**: ルーターはグローバルなリクエストキューを維持する必要がある（ノード側ではなくルーター側で管理）
- **FR-002**: システムはキューの最大サイズを設定可能にする必要がある（デフォルト: 100リクエスト）
- **FR-003**: システムはキュー待機タイムアウトを設定可能にする必要がある（デフォルト: 60秒）
- **FR-004**: 各ノードへのリクエストは単発のみとする（ノードが推論中の場合、新規リクエストはキューで待機）
- **FR-005**: キューが満杯の場合、システムはHTTP 429とRetry-Afterヘッダーを返す必要がある
- **FR-006**: キュー待機タイムアウトの場合、システムはHTTP 504を返す必要がある
- **FR-007**: システムはキュー状態（待機数、処理中数）をダッシュボードで表示する必要がある
- **FR-008**: 複数ノード環境では、アイドル状態のノードを優先的に選択する必要がある（すべて推論中の場合はキューで待機）
- **FR-009**: クライアント切断時、対応するキュー内リクエストはキャンセルされる必要がある
- **FR-010**: ノードは推論中に新規リクエストを受信した場合、即座にHTTP 429を返す必要がある（ノード側キューイング禁止）

### 主要エンティティ

- **リクエストキュー**: ルーター側で管理するグローバルな待機列。最大サイズ、現在の待機数を持つ
- **キューエントリ**: キュー内の個別リクエスト。到着時刻、タイムアウト期限、クライアント接続状態、対象モデルを持つ
- **ノード状態**: 各ノードの処理状態（アイドル/推論中）。単発リクエストのみなので、処理中は新規リクエストを受け付けない

## スコープ外

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- リクエストの優先度制御（VIPユーザー優先など）
- キュー内リクエストの並び替え
- リクエストのバッチ処理（複数リクエストを1回の推論でまとめて処理）

## 前提条件

この機能は以下を前提とします:

- SPEC-589f2df1（ロードバランシングシステム）が実装済みであること
- SPEC-63acef08（統一APIプロキシ）が実装済みであること
- ノードの状態（オンライン/オフライン/推論中）が正確に追跡されていること

## 依存関係

この機能は以下に依存します:

- SPEC-589f2df1: ノード選択アルゴリズムとの連携
- SPEC-63acef08: リクエスト転送機構との連携
- SPEC-712c20cf: ダッシュボードでのキュー状態表示

## 成功基準

1. 単一ノード環境で連続10リクエストを送信しても、すべてのリクエストが処理される
2. キュー満杯時、追加リクエストに対して1秒以内にHTTP 429が返される
3. キュー待機タイムアウト時、設定値の誤差5秒以内にHTTP 504が返される
4. 複数ノード環境で、アイドルノードへの即時ルーティング成功率が95%以上
5. ダッシュボードでキュー状態がリアルタイム（5秒以内の遅延）で表示される
