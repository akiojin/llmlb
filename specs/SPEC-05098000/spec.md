# 機能仕様書: 推論中ノードへの多重リクエストキューイング

**機能ID**: `SPEC-05098000`
**作成日**: 2025-12-24
**ステータス**: 下書き
**入力**: ユーザー説明: "推論中ノードへの多重リクエストキューイング機能。LLM推論中のノードに対して複数のリクエストが到着した場合のキューイング・待機・拒否の仕組みを定義する。"
**依存SPEC**: SPEC-589f2df1（ロードバランシングシステム）、SPEC-63acef08（統一APIプロキシ）

## 概要

LLM推論は計算コストが高く、1つのリクエストの処理に数秒から数十秒かかる場合がある。
複数のリクエストが同時に到着した場合、ノードの処理能力を超えるとシステム全体のパフォーマンスが低下する。
本機能は、**ルーター側でリクエストキューを管理**し、各ノードには**単発リクエストのみ**を送信することで、
システム全体の安定性とユーザー体験を維持する。ノードは推論処理に専念し、キュー管理の複雑さはルーターに集約される。

## ユーザーシナリオ＆テスト

### ユーザーストーリー1 - 単一ノード環境での連続リクエスト処理 (優先度: P1)

ユーザーが単一ノード環境でLLM Routerを使用している場合、
連続してリクエストを送信しても、システムがクラッシュせず順番に処理されることを期待する。

**この優先度の理由**: 単一ノード環境は最も一般的な利用形態であり、この環境での安定動作は必須。

**独立テスト**: 単一ノードに対して連続して5つのリクエストを送信し、
すべてのリクエストが順番に処理され、レスポンスが返されることで価値を提供する。

**受け入れシナリオ**:

1. **前提** 1台のノードが登録されている、**実行** 連続して3つのリクエストを送信する、
   **結果** すべてのリクエストがキューに追加され、順番に処理される
2. **前提** 1台のノードが推論中、**実行** 新しいリクエストを送信する、
   **結果** リクエストはキューに追加され、先行リクエスト完了後に処理される
3. **前提** 1台のノードが推論中でキューが空、**実行** 新しいリクエストを送信する、
   **結果** キュー待機中であることを示すレスポンスヘッダーが返される

---

### ユーザーストーリー2 - キュー溢れ時の適切なエラー通知 (優先度: P1)

ユーザーがシステムの処理能力を超える大量のリクエストを送信した場合、
明確なエラーメッセージとともにリクエストが拒否され、システムが過負荷状態にならないことを期待する。

**この優先度の理由**: システムの安定性を維持し、ユーザーに適切なフィードバックを提供することは必須。

**独立テスト**: キューが最大サイズに達した状態で追加のリクエストを送信し、
429エラーと適切なメッセージが返されることで価値を提供する。

**受け入れシナリオ**:

1. **前提** キューが最大サイズ（デフォルト: 100）に達している、**実行** 新しいリクエストを送信する、
   **結果** HTTP 429 Too Many Requests と「キューが満杯です」メッセージが返される
2. **前提** キューが最大サイズに達している、**実行** 新しいリクエストを送信する、
   **結果** Retry-Afterヘッダーで推奨待機時間が通知される

---

### ユーザーストーリー3 - タイムアウトによる長時間待機の防止 (優先度: P2)

ユーザーがリクエストを送信後、キュー内で長時間待機している場合、
適切なタイムアウトでリクエストがキャンセルされ、ユーザーに通知されることを期待する。

**この優先度の理由**: ユーザー体験の向上。無限待機を防ぎ、ユーザーが状況を把握できるようにする。

**独立テスト**: キュー待機タイムアウトを短く設定し、タイムアウト後にエラーが返されることで価値を提供する。

**受け入れシナリオ**:

1. **前提** キュー待機タイムアウトが30秒に設定、**実行** リクエストを送信し30秒以上キューで待機する、
   **結果** HTTP 504 Gateway Timeout と「キュー待機タイムアウト」メッセージが返される
2. **前提** リクエストがキュー内で待機中、**実行** クライアントが接続を切断する、
   **結果** キューからリクエストが削除される

---

### ユーザーストーリー4 - 単発リクエスト制限の動作確認 (優先度: P2)

管理者として、各ノードが単発リクエストのみを処理し、
推論中のノードには新規リクエストが送信されないことを確認できることを期待する。

**この優先度の理由**: GPUメモリの効率的な使用とシステム安定性の維持に重要。

**独立テスト**: ノードが推論中に新しいリクエストを送信し、そのリクエストがルーターのキューで待機することで価値を提供する。

**受け入れシナリオ**:

1. **前提** 1台のノードが推論中、**実行** 同時に2つのリクエストを送信する、
   **結果** 1つはキューで待機し、ノードが空くと処理開始される
2. **前提** ノードが推論中、**実行** ダッシュボードを確認する、
   **結果** 「処理中: 1」「キュー待機: 2」のように状態が表示される

---

### ユーザーストーリー5 - 複数ノード環境での効率的な分散 (優先度: P3)

複数ノード環境では、1つのノードが推論中でも、
他のアイドル状態のノードにリクエストが自動的にルーティングされることを期待する。

**この優先度の理由**: 複数ノード環境での効率的なリソース活用。

**独立テスト**: 2台のノードのうち1台が推論中の状態で、
リクエストがアイドル状態のノードにルーティングされることで価値を提供する。

**受け入れシナリオ**:

1. **前提** 2台のノードが登録され、ノードAが推論中、ノードBはアイドル、
   **実行** 新しいリクエストを送信する、**結果** リクエストはノードBにルーティングされる
2. **前提** すべてのノードが推論中かつルーターのキューが満杯、**実行** 新しいリクエストを送信する、
   **結果** HTTP 429とすべてのノードが過負荷であることを示すメッセージが返される

---

### ユーザーストーリー6 - 動的推定待ち時間の表示 (優先度: P2)

ユーザーがリクエストを送信した際、キュー待機中に「推定待ち時間」が通知され、
どのくらい待てば処理されるかを把握できることを期待する。

**この優先度の理由**: ユーザー体験の向上。待機状況の透明性を提供する。

**独立テスト**: キュー待機中のリクエストに対して、レスポンスヘッダーで推定待ち時間が返されることを確認する。

**受け入れシナリオ**:

1. **前提** キューに3件のリクエストが待機中で、過去の平均処理時間が10秒、
   **実行** 新しいリクエストを送信する、
   **結果** `X-Estimated-Wait: 30` のようなヘッダーで推定待ち時間（秒）が返される
2. **前提** キューが空の状態、**実行** 新しいリクエストを送信する、
   **結果** 推定待ち時間は0または省略される

---

### ユーザーストーリー7 - ユーザー間公平性の確保 (優先度: P2)

複数ユーザーが同時にリクエストを送信する環境で、特定ユーザーの大量リクエストにより
他ユーザーが長時間待たされることなく、公平にリソースが分配されることを期待する。

**この優先度の理由**: マルチテナント環境でのユーザー体験とリソース公平性。

**独立テスト**: 2ユーザーがそれぞれ複数リクエストを送信し、交互に処理されることを確認する。

**受け入れシナリオ**:

1. **前提** ユーザーAが5件、ユーザーBが2件のリクエストをほぼ同時に送信、
   **実行** キューが順次処理される、
   **結果** A→B→A→B→A→A→Aのようにラウンドロビンで処理される

---

### エッジケース

- ルーターのキュー内のリクエストがタイムアウト前にノードがアイドルになった場合、リクエストは正常に処理される
- ノードがオフラインになった場合、そのノードで処理中だったリクエストはエラーを返し、キュー内のリクエストは
  他のアイドルノードに割り当てられる
- ストリーミングリクエストの場合、最初のチャンクが返されるまでキュー待機タイムアウトが適用される

## 要件

### 機能要件

- **FR-001**: ルーターはグローバルなリクエストキューを維持する必要がある（ノード側ではなくルーター側で管理）
- **FR-002**: システムはキューの最大サイズを設定可能にする必要がある（デフォルト: 100リクエスト）
- **FR-003**: システムはキュー待機タイムアウトを設定可能にする必要がある（デフォルト: 60秒）
- **FR-004**: 各ノードへのリクエストは単発のみとする（ノードが推論中の場合、新規リクエストはキューで待機）
- **FR-005**: キューが満杯の場合、システムはHTTP 429とRetry-Afterヘッダーを返す必要がある
- **FR-006**: キュー待機タイムアウトの場合、システムはHTTP 504を返す必要がある
- **FR-007**: システムはキュー状態（待機数、処理中数）をダッシュボードで表示する必要がある
- **FR-008**: 複数ノード環境では、アイドル状態のノードを優先的に選択する必要がある（すべて推論中の場合はキューで待機）
- **FR-009**: クライアント切断時、対応するキュー内リクエストはキャンセルされる必要がある
- **FR-010**: ノードは推論中に新規リクエストを受信した場合、即座にHTTP 429を返す必要がある（ノード側キューイング禁止）
- **FR-011**: システムは過去の処理時間統計から動的に推定待ち時間を計算し、レスポンスヘッダー（`X-Estimated-Wait`）で通知する必要がある
- **FR-012**: システムはユーザー間でラウンドロビン方式の公平なキュー処理を行う必要がある（同一ユーザーの連続処理を避ける）
- **FR-013**: ストリーミング応答中にノードがクラッシュした場合、リクエストは完全リトライ（最初から再生成）とする（部分的コンテキスト引継ぎは行わない）
- **FR-014**: ダッシュボードでのキュー状態表示は集計情報のみ（待機数・処理中数・平均待機時間）とし、ユーザー別内訳やリクエスト詳細は表示しない

### 主要エンティティ

- **リクエストキュー**: ルーター側で管理するグローバルな待機列。最大サイズ、現在の待機数を持つ
- **キューエントリ**: キュー内の個別リクエスト。到着時刻、タイムアウト期限、クライアント接続状態、対象モデルを持つ
- **ノード状態**: 各ノードの処理状態（アイドル/推論中）。単発リクエストのみなので、処理中は新規リクエストを受け付けない

## Clarifications

### Session 2025-12-30

インタビューにより以下が確定:

- **待ち時間通知**: 動的推定（過去の処理時間統計×キュー位置で計算）
- **障害復旧**: 完全リトライ（部分的コンテキスト引継ぎは行わない）
- **公平性制御**: ラウンドロビン方式（ユーザー間で交互に処理）
- **キュー分離**: グローバル単一キュー（モデル別・capability別の分離は行わない）
- **同時処理**: 単発固定（GPUメモリ完全予約、同時処理オプションなし）
- **ダッシュボード表示**: 集計のみ（待機数・処理中数・平均待機時間）

### Session 2025-12-30 (追加)

インタビューにより以下が追加確定:

- **GPU排他制御時のルーティング**: 推論中ノードへのリクエストは別ノードへ自動ルーティング、
  利用可能なノードがなければキュー入り待機（タイムアウト付き）
- **ロードバランシング統合**: 複合スコア計算（GPU負荷×0.3 + キュー長×0.7）でノード選択、
  キュー長を優先してリクエスト分散
- **ノード障害時**: 自動リトライ（別ノード）を実施、進行中リクエストも別ノードで再実行
- **モデルロード中リクエスト**: 503 Service Unavailable を即座に返却
  （GPUメモリへのモデル展開中は推論不可）
- **ストリーミング中断**: 全体をエラーとして破棄（部分結果は返却しない）

---

## スコープ外

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- リクエストの優先度制御（VIPユーザー優先など）
- キュー内リクエストの並び替え
- リクエストのバッチ処理（複数リクエストを1回の推論でまとめて処理）
- モデル別・capability別のキュー分離
- ノード単位での同時処理許可設定

## 前提条件

この機能は以下を前提とします:

- SPEC-589f2df1（ロードバランシングシステム）が実装済みであること
- SPEC-63acef08（統一APIプロキシ）が実装済みであること
- ノードの状態（オンライン/オフライン/推論中）が正確に追跡されていること

## 依存関係 *(該当する場合)*

### 前提条件（このSPECが依存するもの）

- **SPEC-589f2df1**: ロードバランシングシステム ✅ 実装済み
- **SPEC-63acef08**: 統一APIプロキシ ✅ 実装済み

### 依存元（このSPECに依存するもの）

- なし

## 成功基準

1. 単一ノード環境で連続10リクエストを送信しても、すべてのリクエストが処理される
2. キュー満杯時、追加リクエストに対して1秒以内にHTTP 429が返される
3. キュー待機タイムアウト時、設定値の誤差5秒以内にHTTP 504が返される
4. 複数ノード環境で、アイドルノードへの即時ルーティング成功率が95%以上
5. ダッシュボードでキュー状態がリアルタイム（5秒以内の遅延）で表示される
