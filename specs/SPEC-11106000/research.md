# 技術リサーチ: SPEC-11106000 Hugging Face URL 登録（形式選択）

## リサーチ課題
1. HF API へのアクセス方法と認証要否（GGUF一覧取得）。
2. 対応モデルIDの命名規則（repo / ファイル名の組み立て）。
3. 形式選択（safetensors/GGUF）の判定とバリデーション方針。
4. レートリミットとキャッシュ戦略。

## 調査結果と決定

### 1) HF API アクセス / 認証
- HF Hub 公開モデルは匿名でも取得可能だが、レートリミットが厳しいためトークン指定（`Authorization: Bearer <HF_TOKEN>`）を許可する。
- GGUF一覧取得は `GET https://huggingface.co/api/models?library=gguf&search=<query>&limit=<n>&offset=<m>` を利用する方針。
- トークン未設定時は匿名で試行し、429/401 時に「トークン設定を推奨」メッセージを返す。

### 2) モデルID命名規則
- 対応モデルIDは衝突回避と一意性を優先し、`hf/<repo>/<filename>` を基本形とする（例: `hf/TheBloke/Llama-2-7B-GGUF/llama-2-7b.Q4_K_M.gguf`）。
- 表示名は repo と量子化レベルを含めた短縮形を併記（UI/CLIはラベルで短縮、IDはフルパスで保持）。
- 将来のバージョン違いも同一IDで区別できるよう、ファイル名を必須要素とする。

### 3) 形式選択の判定とバリデーション
- 方針: HF上に safetensors/GGUF が両方存在する場合のみ `format` を必須にし、選択した形式で登録する。
- `format=gguf` で該当GGUFが存在しない場合はエラー（自動変換は行わない）。
- `format=safetensors` は `config.json` / `tokenizer.json` を必須とする。

### 4) レートリミットとキャッシュ
- HF API 呼び出しは 1 回の操作で 1 リクエスト程度だが、一覧再取得はキャッシュ前提とする（メモリキャッシュ + TTL 5分を推奨）。
- HF 障害時や 429 時はキャッシュ結果を返し、最新でないことを明示。

## 検討した代替案
- **モデルIDを repo:tag 形式にする**: ファイル名が落ちると量子化違いを区別できないため却下。
- **常時匿名アクセスのみ**: レートリミット回避の余地がなく運用で詰まるため、トークン可にする。

## 未決事項（要明確化）
- 内部ストレージの具体実装（S3 / GCS / ローカルHTTP）とURLスキーム。
