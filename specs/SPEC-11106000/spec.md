# 機能仕様書: Hugging Face URL 登録（形式選択・明示登録）

**機能ID**: `SPEC-11106000`  
**作成日**: 2025-12-01  
**ステータス**: 実装中（要件確定済み）  
**入力**: ユーザー説明: "Hugging FaceのモデルURLを直接入力して登録したい。safetensors/GGUFの両方がある場合は登録時に必ず選択する。GGUFは既存ファイルから選ぶ（無ければエラー）。/v1/models には実体があるものだけを返す。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - URL入力で明示的に形式選択して登録 (P1)
運用管理者として、HFのリポジトリURLまたはファイルURLを1行テキストエリアに貼り付けて登録したい。safetensors/GGUFの両方が存在する場合は `format` を必須にし、選択した形式で登録できることを期待する。HFカタログ一覧は不要。

**独立テスト**: `https://huggingface.co/org/repo` または `org/repo` を `format` 未指定で登録→400エラー（形式選択が必須）。`format=safetensors`/`format=gguf` を指定→登録成功バナー、重複時は理由つきバナー。

### ユーザーストーリー2 - GGUFが無い場合はエラーにしたい (P1)
運用管理者として、`format=gguf` を指定したのにHF側にGGUFが存在しない場合は、変換キューに入れず明確なエラーが欲しい。

**独立テスト**: `format=gguf` で登録→GGUFが存在しない→400エラー（該当GGUFが無い旨）。

### ユーザーストーリー3 - 実体があるものだけ /v1/models に出す (P1)
クライアントとして、モデルファイル（safetensors/GGUF）がまだ存在しない状態で /v1/models に出てこないことを期待する。実体があるモデルだけを返し、ソースコードに埋め込みのデフォルトモデルは不要。登録済みモデルの削除は即時反映される。

**独立テスト**: 新規登録直後（未ダウンロード）のモデルで /v1/models を叩く→含まれない。ダウンロード完了後に再度叩く→含まれる。削除後に再取得→含まれない。

### エッジケース
- HF APIがダウン/429時はキャッシュから返し、「最新でない」旨を示す。
- 選択したファイルが実際には存在しない場合、登録は失敗として詳細メッセージを返す。
- 巨大モデル（>50GB）を登録した場合、ノードの推奨メモリ超過を警告する。
- `format=safetensors` で `.safetensors` が複数あるのに `.safetensors.index.json` が無い場合、曖昧として 400 エラー。

### 要明確化
- HF APIへのアクセスは匿名で十分か、HF_TOKEN必須か。
- 対応モデルIDの命名規則（repo/file からどう組み立てるか）の統一。

## 要件 *(必須)*

### 機能要件
- **FR-001**: テキストエリアにHFリポジトリURLまたはファイルURL、もしくは `org/repo` 形式の文字列を入力して登録できる。
- **FR-002**: リポジトリに safetensors と GGUF の両方が存在する場合、`format` は必須とする。片方のみの場合は `format` 省略を許可し、その形式を採用する。
- **FR-003**: `format=gguf` かつ `filename` 未指定の場合、`gguf_policy` を必須とし、siblings から最適なGGUFを選択する（見つからない場合は 400）。
- **FR-004**: `format=safetensors` の登録では `config.json` と `tokenizer.json` を必須とし、不足時は 400 エラーとする。
- **FR-005**: /v1/models とダッシュボード登録済み一覧には、ルーター上に実体（safetensors/GGUF）が存在するものだけを含める（ソースコード埋め込みのプリセットモデルは返さない）。
- **FR-006**: 重複登録はバリデーションエラーとして即時に返し、既存登録を上書きしない。
- **FR-007**: HFカタログ検索/一覧UI/APIは本仕様の範囲外とし、画面からも削除または非表示にする。
- **FR-008**: 成功/失敗バナーは自動消去しない（×で閉じる）か、少なくとも4秒以上表示する。
- **FR-009**: 登録済みモデルをUI/APIから削除できる。削除後は /v1/models とダッシュボード一覧から即時消え、ローカルキャッシュも削除する。
- **FR-010**: `format=safetensors` で `.safetensors` が複数あるのに `.safetensors.index.json` が無い場合、曖昧として 400 エラーにする。

### 主要エンティティ
- **Hugging Face モデル**: リポジトリとそのファイル（safetensors/GGUF）。属性: repo, filename, size, quant, updated_at, direct URL。
- **対応モデル**: 配布対象モデル。属性: model_id, source(hf_safetensors/hf_gguf), format, gguf_policy?, status, size。

## スコープ外
- HFプライベートモデル（認証が必要なもの）の対応。
- 自動変換（非GGUF → GGUF）および自動量子化生成。
- 推論エンジンの選択/実装（SPEC-d7feaa2c / SPEC-2c0e5a9b）。

## 技術制約
- HF 公開APIのレートリミット内で動作すること。
- 登録フローは自動変換に依存しない。

## 前提条件
- ルーターとノード間の既存配布・登録フローが動作していること。
- 管理者はHF公開モデルへ到達できること。

## 依存関係
- `SPEC-08d2b908`（モデル管理統合）
- `SPEC-a61b24f2`（登録時の形式選択とGGUFポリシー）
- `SPEC-dcaeaec4`（LLM-Router独自モデルストレージ：モデル配布/取得フロー）
- Node が `/v1/models` および `/v1/models/blob/:model_name` の情報を利用できる仕組み

## Clarifications

### Session 2025-12-24

仕様を精査した結果、「要明確化」セクションに既に記載された事項があります。

**確認済み事項**:

- 入力形式: HF URL、org/repo形式、ファイルURL（FR-001で明記）
- 形式選択: 両形式が存在する場合は `format` 必須（FR-002で明記）
- GGUF選択: `gguf_policy` による siblings 選択、該当無しはエラー（FR-003で明記）
- 重複処理: バリデーションエラー、上書きしない（FR-006で明記）
- 削除動作: 即時反映、ローカルキャッシュ削除（FR-009で明記）

**要明確化事項への回答（実装時判断）**:

- HF APIアクセス: 匿名でも可、HF_TOKENがあれば利用（推奨: 環境変数で設定）
- モデルID命名: `{repo}_{filename_stem}` 形式（推奨）

---

## 成功基準 *(必須)*
1. 両形式が存在する場合、`format` 未指定は 400 になり、指定時に登録が成功する。
2. `format=gguf` で該当GGUFが無い場合は 400 になり、明確な理由が返る。
3. `format=safetensors` で必須メタデータ不足時は 400 になり、不足ファイル名が返る。
4. ダウンロード未完了のモデルが /v1/models に含まれない。
5. 重複登録時に意味のあるエラーバナーが表示される。
6. `format=safetensors` で index が無い複数 shard は 400 になる。
