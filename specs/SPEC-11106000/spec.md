# 機能仕様書: Hugging Face URL 登録（変換なし）

**機能ID**: `SPEC-11106000`  
**作成日**: 2025-12-01  
**ステータス**: 実装済み  
**入力**: ユーザー説明: "Hugging FaceのモデルURLを直接入力して登録したい。変換は行わない。ノードがHFから直接ダウンロードしてキャッシュする。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - URL入力で対応モデルに登録 (P1)
運用管理者として、HFのリポジトリURLまたはファイルURLを1行テキストエリアに貼り付けて登録したい。リポジトリ直指定なら対応アーティファクト一覧（マニフェスト）を保存し、Nodeが実行環境に応じて選択する。重複時は即座に分かるメッセージが欲しい。HFカタログ一覧は不要。

**独立テスト**: `https://huggingface.co/org/repo` や `org/repo` を入力→対象形式を解決→登録成功バナー、重複時は理由つきバナー。

### ユーザーストーリー2 - 変換なしで登録し、Nodeが直接取得 (P1)
運用管理者として、`.safetensors` や `.gguf` など任意の対応フォーマットを**変換せずに**登録したい。モデルの実体はNodeがHFから直接ダウンロードしてキャッシュする。

**独立テスト**: 非GGUF（safetensors）URLをRegister→ルーターは変換しない→NodeがHFから直接取得→推論成功。

### ユーザーストーリー3 - /v1/models の可視性は登録とNodeのreadyに従う (P1)
クライアントとして、/v1/models が登録済みモデルを返し、ready 状態はノードの同期結果に基づいて表示されることを期待する。登録削除は即時反映される。

**独立テスト**: 新規登録直後は /v1/models に表示されるが ready=false。Node同期後に ready=true。削除後に再取得→含まれない。

### エッジケース
- HF APIがダウン/429時はキャッシュから返し、「最新でない」旨を示す。
- 選択したファイルが実際には存在しない場合、登録は失敗として詳細メッセージを返す。
- 巨大モデル（>50GB）を登録した場合、ノードの推奨メモリ超過を警告する。

### 要明確化
- HF APIへのアクセスは匿名で十分か、HF_TOKEN必須か。
- 対応モデルIDの命名規則（repo/file からどう組み立てるか）の統一。
- （削除）変換は行わないため、生成GGUFのホスト先は不要。

## 要件 *(必須)*

### 機能要件
- **FR-001**: テキストエリアにHFリポジトリURLまたはファイルURL、もしくは `org/repo` 形式の文字列を入力して登録できる。リポジトリ直指定時はHFのファイル一覧（マニフェスト）を保存し、Nodeが実行環境に応じて選択する。
- **FR-002**: ルーターは**変換もバイナリダウンロードもしない**。登録はメタデータ保存に限定する。
- **FR-003**: Node は外部ソース（HF等）から**直接**モデルをダウンロードしてキャッシュする。
- **FR-004**: /v1/models とダッシュボード登録済み一覧には登録済みモデルを表示し、ready はノード同期結果に基づいて示す。
- **FR-005**: 重複登録はバリデーションエラーとして即時に返し、既存登録を上書きしない。
- **FR-006**: HFカタログ検索/一覧UI/APIは本仕様の範囲外とし、画面からも削除または非表示にする。
- **FR-007**: 成功/失敗バナーは自動消去しない（×で閉じる）か、少なくとも4秒以上表示する。
- **FR-008**: 登録済みモデルをUI/APIから削除できる。削除後は /v1/models とダッシュボード一覧から即時消え、Node 側キャッシュは次回同期で削除される。

### 主要エンティティ
- **Hugging Face モデル**: リポジトリとそのファイル（GGUF/safetensors/Metal等）。属性: repo, filename, size, quant, updated_at, direct URL。
- **登録モデル**: 配布対象モデル。属性: model_id, repo, artifacts, status, size。
- **Nodeキャッシュ**: Node側のローカル保存済みアーティファクト群。

## スコープ外
- HFプライベートモデル（認証が必要なもの）の対応。

## 技術制約
- HF 公開APIのレートリミット内で動作すること。
- 変換パイプラインは廃止し、ルーターはバイナリを生成しない。

## 前提条件
- ルーターとノード間の既存配布・登録フローが動作していること。
- 管理者はHF公開モデルへ到達できること。

## 依存関係
- SPEC-dcaeaec4（LLM-Router独自モデルストレージ）- モデル配布とストレージの仕組み
- ノードがHFから直接モデルを取得できる仕組み

## Clarifications

### Session 2025-12-24

仕様を精査した結果、「要明確化」セクションに既に記載された事項があります。

**確認済み事項**:

- 入力形式: HF URL、org/repo形式、ファイルURL（FR-001で明記）
- 重複処理: バリデーションエラー、上書きしない（FR-005で明記）
- 削除動作: 即時反映、ローカルキャッシュ削除（FR-008で明記）

**要明確化事項への回答（実装時判断）**:

- HF APIアクセス: 匿名でも可、HF_TOKENがあれば利用（推奨: 環境変数で設定）
- モデルID命名: `{repo}` または `{repo}/{filename}` 形式（推奨）
- 生成GGUFホスト: 廃止（変換しない）

### Session 2025-12-31

- **変換は行わない**（GGUF変換なし）
- **ルーターはバイナリを保持しない**
- **NodeがHFから直接ダウンロードしてキャッシュする**

---

## 成功基準 *(必須)*
1. 登録後、/v1/models にモデルが表示され、ready はノード同期結果で更新される。
2. Node がHFから直接モデルを取得し、推論が成功する。
3. 重複登録や未発見時に意味のあるエラーバナーが表示される。
