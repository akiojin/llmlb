# 機能仕様書: Hugging Face GGUFモデル対応登録

**機能ID**: `SPEC-11106000`
**作成日**: 2025-12-01
**ステータス**: 下書き
**入力**: ユーザー説明: "Hugging FaceのモデルURLを直接入力して登録したい。GGUF以外なら自動でGGUFへ変換キューに入れてほしい。HFカタログ表示は不要。/v1/models にはダウンロード完了済みだけを返してほしい。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - URL入力で対応モデルに登録する (優先度: P1)
運用管理者として、HFのリポジトリURLまたはファイルURLを1行テキストエリアに貼り付けて登録したい。リポジトリ直指定なら最初のGGUFを自動で選んで登録し、重複時は即座にわかるメッセージが欲しい。

**独立テスト**: `https://huggingface.co/org/repo` を入力→最初のGGUFを解決→登録成功メッセージが表示され、重複登録時はバナーで理由が表示されること。

**受け入れシナリオ**:
1. **前提** HFリポジトリにGGUFが1つ以上ある、**実行** リポジトリURLをRegister、**結果** 最初のGGUFが登録される。
2. **前提** 同一モデルを再度登録、**実行** Register、**結果** 「重複登録されています」が表示される。

### ユーザーストーリー2 - 非GGUF入力は自動で変換キューに入れる (優先度: P1)
運用管理者として、`.safetensors` など非GGUFファイルのURLを入力したとき、自動でConvertタスクに投入されることを期待する。成功/失敗はダッシュボードのバナーとタスク一覧で確認したい。

**独立テスト**: 非GGUFファイルURLをRegister→convertキューにタスク追加→タスク一覧に status=pending で現れる→失敗時はエラーバナーが残る。

### ユーザーストーリー3 - ダウンロード完了済みだけを /v1/models で返す (優先度: P1)
クライアントとして、モデルファイルがまだ存在しない状態で /v1/models に出てこないことを期待する。実体があるモデルだけを返し、ソースコードに埋め込みのデフォルトモデルは不要。

**独立テスト**: 新規登録直後（未ダウンロード）のモデルで /v1/models を叩く→結果に含まれない。ダウンロード完了後に再度叩く→結果に含まれ、`path` が返る。

---

### エッジケース
- HF APIが一時的にダウンまたはレートリミットされた場合、一覧はキャッシュから返し、最新でない旨を表示する。
- 選択したGGUFファイルが実際には存在しない／削除されていた場合、登録を失敗として詳細メッセージを返す。
- 巨大モデル（>50GB）が登録された場合、ノード側の容量不足を事前警告として返す。

### 要明確化
- HF APIへのアクセスは匿名で十分か、それともアクセストークン必須か（レートリミットと運用責任の所在を決める必要がある）。
- 対応モデルIDの命名規則を HF リポジトリ／ファイル名からどう組み立てるか（例: `TheBloke/Llama-2-7B-GGUF:Q4_K_M` など）を統一する必要がある。
- 将来の非GGUF変換で生成したGGUFをどこにホストし、ノードに配布するか（HF直リンクか社内ミラー/オブジェクトストレージか）を決める必要がある。
- 将来、非GGUF（safetensors/PyTorch）モデルを扱う場合は「ルーター側で一度だけ変換・量子化し、GGUFをホスティングしてノードはダウンロードのみとする」か、「各ノードが個別にダウンロード・変換する」かの方針を決める必要がある（負荷・帯域・再現性に大きく影響）。

## 要件 *(必須)*

### 機能要件
- **FR-001**: テキストエリアにHFリポジトリURLまたはファイルURLを入力して登録できる。リポジトリ直指定時は最初のGGUFを自動解決し、見つからない場合はバナーで理由を返す。
- **FR-002**: 入力URLがGGUF以外の拡張子の場合、自動でConvertタスクに投入し、タスク一覧に残す。成功・失敗はバナーとタスク状態で確認できる。
- **FR-003**: /v1/models とダッシュボードの登録済みモデル一覧には、実体のGGUFファイルがルーター上に存在するものだけを含める（ソースコード埋め込みのプリセットモデルは返さない）。
- **FR-004**: 重複登録はバリデーションエラーとして即時に返し、既存登録を上書きしない。
- **FR-005**: HFカタログ検索/一覧UI/APIは本仕様の範囲外とし、デフォルト無効にする。
- **FR-006**: 成功/失敗バナーは自動消去しない（×で閉じる）か、少なくとも4秒以上表示する。

### 主要エンティティ
- **Hugging Face モデル**: HF上のリポジトリとそのファイル（特にGGUFファイル）。属性: リポジトリ名、ファイル名、サイズ、量子化、更新日時、直リンク。
- **対応モデル**: ルーターが配布・推論対象として認識するモデル。属性: モデルID、ソース種別（hf_gguf / hf_pending_convert）、ステータス（登録済み／変換待ち／無効）、サイズ目安。
- **変換タスク（将来）**: 非GGUFからGGUFへの変換要求。属性: 入力モデル、状態（待機/進行/失敗/完了）、出力先。

## スコープ外 *(オプション)*
- 非GGUF→GGUF の変換処理そのものと配布までの自動パイプライン実行。
- HF 認証が必要なプライベートモデル対応（今回は公開モデル前提）。

## 技術制約 *(該当する場合)*
- HF 公開APIのレートリミット内で動作すること。
- GGUF以外の形式は本スコープでは配布不可（将来拡張を前提にUI/APIのみ予約）。

## 前提条件 *(該当する場合)*
- ルーターとノード間の既存配布・登録フローが動作していること。
- 管理者はHF公開モデルへのアクセス権（ネットワーク到達性）があること。

## 依存関係 *(該当する場合)*
- 既存のモデル自動配布機能（SPEC-8ae67d67）とモデル一覧API。
- ノード側が /v1/models に基づき manifest/ファイルを取得できる既存仕組み。

## 成功基準 *(必須)*
1. URL入力から登録したモデルが（GGUFの場合）1分以内にダウンロード完了し、/v1/models に現れる。
2. 非GGUF URL入力時に必ず convert タスクが作成され、タスク一覧に状態が残る。
3. ダウンロード未完了のモデルが /v1/models に含まれないことを確認できる。
4. 重複登録やGGUF未発見時に100%で意味のあるエラーバナーが表示される。
