# 機能仕様書: Hugging Face URL 登録（GGUF優先・自動変換つき）

**機能ID**: `SPEC-11106000`  
**作成日**: 2025-12-01  
**ステータス**: 実装中（要件確定済み）  
**入力**: ユーザー説明: "Hugging FaceのモデルURLを直接入力して登録したい。GGUF以外なら自動でGGUFへ変換キューに入れてほしい。HFカタログ表示は不要。/v1/models にはダウンロード完了済みだけを返してほしい。失敗した変換はUIから再実行（Restore）できるようにしたい。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - URL入力で対応モデルに登録 (P1)
運用管理者として、HFのリポジトリURLまたはファイルURLを1行テキストエリアに貼り付けて登録したい。リポジトリ直指定なら最初のGGUFを自動で選び、無ければ変換可能ファイルを選び、重複時は即座に分かるメッセージが欲しい。HFカタログ一覧は不要。

**独立テスト**: `https://huggingface.co/org/repo` や `org/repo` を入力→最初のGGUF/互換chat_templateを解決→登録成功バナー、重複時は理由つきバナー。

### ユーザーストーリー2 - 非GGUFは自動で変換キューへ (P1)
運用管理者として、`.safetensors` など非GGUFファイルURLまたはリポジトリURLを入力したとき、自動でConvertタスクに投入されることを期待する。成功/失敗はダッシュボードのバナーとタスク一覧で確認し、失敗した場合はUIから再実行（Restore）したい。

**独立テスト**: 非GGUF URLをRegister→convertタスク追加→一覧に status=pending →失敗時エラーバナーが残る→Restoreボタンで再キューできる。

### ユーザーストーリー3 - 実体があるものだけ /v1/models に出す (P1)
クライアントとして、モデルファイルがまだ存在しない状態で /v1/models に出てこないことを期待する。実体があるモデルだけを返し、ソースコードに埋め込みのデフォルトモデルは不要。登録済みモデルの削除は即時反映される。

**独立テスト**: 新規登録直後（未ダウンロード）のモデルで /v1/models を叩く→含まれない。ダウンロード完了後に再度叩く→含まれる。削除後に再取得→含まれない。

### エッジケース
- HF APIがダウン/429時はキャッシュから返し、「最新でない」旨を示す。
- 選択したファイルが実際には存在しない場合、登録は失敗として詳細メッセージを返す。
- 巨大モデル（>50GB）を登録した場合、ノードの推奨メモリ超過を警告する。

### 要明確化
- HF APIへのアクセスは匿名で十分か、HF_TOKEN必須か。
- 対応モデルIDの命名規則（repo/file からどう組み立てるか）の統一。
- 生成したGGUFをどこにホストするか（HF直リンクか社内ミラーか）。

## 要件 *(必須)*

### 機能要件
- **FR-001**: テキストエリアにHFリポジトリURLまたはファイルURL、もしくは `org/repo` 形式の文字列を入力して登録できる。リポジトリ直指定時はGGUFを優先し、chat_template 差分がある場合はチャット用テンプレート付きのものを優先する。GGUFがなければ変換可能拡張子（.safetensors/.bin/.pt/.pth 等）を優先し、それも無ければ最初のファイルを選んで変換キューに入れる。
- **FR-002**: 入力URLがGGUF以外の場合、自動でConvertタスクに投入し、タスク一覧に残す。成功・失敗はバナーとタスク状態で確認できる。
- **FR-003**: 変換/ダウンロードが失敗したタスクにはUIで「Restore」ボタンを表示し、同じパラメータで再キューできる。
- **FR-004**: /v1/models とダッシュボード登録済み一覧には、ルーター上に実体GGUFが存在するものだけを含める（ソースコード埋め込みのプリセットモデルは返さない）。
- **FR-005**: 重複登録はバリデーションエラーとして即時に返し、既存登録を上書きしない。
- **FR-006**: HFカタログ検索/一覧UI/APIは本仕様の範囲外とし、画面からも削除または非表示にする。
- **FR-007**: 成功/失敗バナーは自動消去しない（×で閉じる）か、少なくとも4秒以上表示する。
- **FR-008**: 登録済みモデルをUI/APIから削除できる。削除後は /v1/models とダッシュボード一覧から即時消え、ローカルキャッシュも削除する。
- **FR-009**: ルーター再起動後も pending_conversion の登録があれば自動的に変換キューへ再投入される。失敗したタスクは UI の Restore で再実行できる。

### 主要エンティティ
- **Hugging Face モデル**: リポジトリとそのファイル（GGUF/非GGUF）。属性: repo, filename, size, quant, updated_at, direct URL。
- **対応モデル**: 配布対象モデル。属性: model_id, source(hf_gguf/hf_pending_convert), status, size。
- **変換タスク**: 非GGUF→GGUF要求。属性: repo, filename, status(queued/in_progress/completed/failed), error, output_path。

## スコープ外
- HFプライベートモデル（認証が必要なもの）の対応。

## 技術制約
- HF 公開APIのレートリミット内で動作すること。
- 非GGUF入力時は llama.cpp の `convert_hf_to_gguf.py` でルーター側1回のみ変換し、生成GGUFを /v1/models で返す。Python依存は環境で準備する（開発用のダミー変換フラグは廃止）。

## 前提条件
- ルーターとノード間の既存配布・登録フローが動作していること。
- 管理者はHF公開モデルへ到達できること。

## 依存関係
- 既存モデル自動配布（SPEC-8ae67d67）とモデル一覧API。
- ノードが /v1/models に基づいて manifest/ファイルを取得できる仕組み。

## Clarifications

### Session 2025-12-24

仕様を精査した結果、「要明確化」セクションに既に記載された事項があります。

**確認済み事項**:

- 入力形式: HF URL、org/repo形式、ファイルURL（FR-001で明記）
- GGUF優先: chat_template付きを優先選択（FR-001で明記）
- 変換対応: .safetensors/.bin/.pt/.pth等（FR-001で明記）
- 重複処理: バリデーションエラー、上書きしない（FR-005で明記）
- 削除動作: 即時反映、ローカルキャッシュ削除（FR-008で明記）

**要明確化事項への回答（実装時判断）**:

- HF APIアクセス: 匿名でも可、HF_TOKENがあれば利用（推奨: 環境変数で設定）
- モデルID命名: `{repo}_{filename_stem}` 形式（推奨）
- 生成GGUFホスト: ルーターローカル（~/.llm-router/models/）

---

## 成功基準 *(必須)*
1. GGUF入力は1分以内にダウンロード完了し /v1/models に現れる。
2. 非GGUF入力は必ず convert タスクが作成され、成功時は生成GGUFが /v1/models に反映され、失敗時はバナー＋タスクで理由が分かり、Restoreで再実行できる。
3. ダウンロード未完了のモデルが /v1/models に含まれない。
4. 重複登録やGGUF未発見時に意味のあるエラーバナーが表示される。
