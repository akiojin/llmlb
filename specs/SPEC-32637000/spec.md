# 機能仕様書: モデル capabilities に基づくルーティング検証

**機能ID**: `SPEC-32637000`
**作成日**: 2025-12-19
**ステータス**: 下書き
**入力**: ユーザー説明: "モデル capabilities に基づくルーティング検証 - OpenAI互換APIでモデルを指定して呼び出した際、そのモデルが要求されたAPI（TTS、ASR、画像生成など）に対応しているかをルーターで検証し、非対応の場合はエラーを返す"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 非対応モデルでのAPI呼び出し時にエラーを受け取る (優先度: P1)

開発者として、音声合成に対応していないモデル（例: LLaMA）を指定して音声合成APIを呼び出した場合、明確なエラーメッセージを受け取りたい。これにより、間違ったモデルを使用していることにすぐ気づき、正しいモデルに変更できる。

**この優先度の理由**: ユーザーが間違ったモデルを使用した場合に、黙って失敗したり不正な結果を返したりするのではなく、即座に明確なフィードバックを提供することが最も重要。

**独立テスト**: 音声合成APIに非対応モデルを指定してリクエストを送信し、エラーレスポンスが返ることを確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** LLaMA（テキスト生成のみ対応）がルーターに登録されている、**実行** `/v1/audio/speech` に `model: "llama-3.1-8b"` を指定してリクエスト、**結果** エラーレスポンス「Model 'llama-3.1-8b' does not support text-to-speech」が返る
2. **前提** Whisper（音声認識のみ対応）がルーターに登録されている、**実行** `/v1/chat/completions` に `model: "whisper-large-v3"` を指定してリクエスト、**結果** エラーレスポンス「Model 'whisper-large-v3' does not support text generation」が返る
3. **前提** VibeVoice（音声合成のみ対応）がルーターに登録されている、**実行** `/v1/images/generations` に `model: "vibevoice"` を指定してリクエスト、**結果** エラーレスポンス「Model 'vibevoice' does not support image generation」が返る

---

### ユーザーストーリー2 - 対応モデルでのAPI呼び出しが成功する (優先度: P1)

開発者として、正しい能力を持つモデルを指定してAPIを呼び出した場合、リクエストが正常に処理されることを期待する。

**この優先度の理由**: 正常系の動作保証は機能の根幹であり、エラーチェックと同等に重要。

**独立テスト**: 対応モデルを指定してAPIを呼び出し、正常なレスポンスが返ることを確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** VibeVoice（音声合成対応）がルーターに登録されている、**実行** `/v1/audio/speech` に `model: "vibevoice"` を指定してリクエスト、**結果** 音声データが正常に返る
2. **前提** LLaMA（テキスト生成対応）がルーターに登録されている、**実行** `/v1/chat/completions` に `model: "llama-3.1-8b"` を指定してリクエスト、**結果** テキストレスポンスが正常に返る

---

### ユーザーストーリー3 - モデル一覧で capabilities を確認できる (優先度: P2)

開発者として、各モデルがどのAPIに対応しているかをモデル一覧で確認したい。これにより、適切なモデルを選択できる。

**この優先度の理由**: エラーを事前に防ぐための情報提供であり、開発体験を向上させる。

**独立テスト**: `/v1/models` を呼び出し、各モデルに capabilities が含まれていることを確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** 複数のモデルがルーターに登録されている、**実行** `/v1/models` を呼び出す、**結果** 各モデルに `capabilities` フィールドが含まれ、対応するAPI能力が一覧で表示される

---

### エッジケース

- 未登録モデルを指定した場合、「モデルが見つかりません」エラーが返る
- capabilities が未設定のモデル（レガシー登録）の場合、モデルタイプから自動推定される
- クラウドモデル（openai:gpt-4o など）の capabilities は事前定義された値が使用される

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、各モデルに対して対応するAPI能力（capabilities）を管理する必要がある
- **FR-002**: システムは、APIリクエスト時に指定されたモデルの capabilities を検証する必要がある
- **FR-003**: システムは、モデルが要求されたAPIに対応していない場合、明確なエラーメッセージを返す必要がある
- **FR-004**: システムは、モデルタイプから capabilities を自動推定する必要がある（後方互換性）
- **FR-005**: システムは、`/v1/models` レスポンスに各モデルの capabilities を含める必要がある
- **FR-006**: システムは、以下の capabilities を識別する必要がある:
  - テキスト生成（chat/completions）
  - 音声合成（audio/speech）
  - 音声認識（audio/transcriptions）
  - 画像生成（images/generations）
  - 画像理解（chat with images）
  - 埋め込み生成（embeddings）

### 主要エンティティ

- **ModelCapability**: モデルが対応するAPI能力を表す。1つのモデルが複数の capabilities を持つ場合がある（例: GPT-4o はテキスト生成、画像理解、音声合成に対応）

---

## 技術制約

- 既存のモデル登録APIとの後方互換性を維持する必要がある
- capabilities 未設定のモデルは、モデルタイプから自動推定する

---

## 前提条件

この機能は以下を前提とします:

- ルーターに登録されたモデルは、すべてのノードで同期されている
- ルーティングは「どのノードに振り分けるか」のみを決定し、「どのモデルを使うか」はルーター時点で決定済み

---

## 依存関係

この機能は以下に依存します:

- 既存のモデル登録機能
- 既存のOpenAI互換API

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. 非対応モデルでAPIを呼び出した場合、100%の確率で明確なエラーメッセージが返る
2. 対応モデルでAPIを呼び出した場合、既存の動作と同様に正常に処理される
3. モデル一覧で、すべてのモデルの capabilities が確認できる
4. 既存のモデル登録（capabilities 未設定）との後方互換性が維持される
