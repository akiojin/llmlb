openapi: 3.0.3
info:
  title: LLM Router Health Check API
  description: |
    ヘルスチェックシステムのAPI仕様。

    ノードからのハートビート受信と、
    ノード状態の監視を行う。
  version: 0.1.0

servers:
  - url: http://localhost:8080
    description: ローカル開発サーバー

paths:
  /v0/health:
    post:
      summary: ハートビート送信
      description: |
        ノードからllmlbへのハートビート送信。
        メトリクス情報を含めて送信し、ノードの生存を通知する。
      operationId: sendHeartbeat
      tags:
        - Health
      security:
        - nodeTokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HeartbeatRequest'
      responses:
        '200':
          description: ハートビート受信成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HeartbeatResponse'
        '401':
          description: ノードトークン無効
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: ノードが未登録
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /v0/nodes:
    get:
      summary: ノード状態一覧の取得
      description: 登録済みノードの状態一覧を取得する。
      operationId: listNodeHealth
      tags:
        - Nodes
      security:
        - bearerAuth: []
      responses:
        '200':
          description: ノード状態一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeHealthListResponse'

  /v0/nodes/{node_id}/health:
    get:
      summary: ノード健康状態の取得
      description: 特定ノードの詳細な健康状態を取得する。
      operationId: getNodeHealth
      tags:
        - Nodes
      security:
        - bearerAuth: []
      parameters:
        - name: node_id
          in: path
          required: true
          schema:
            type: string
          description: ノードID
      responses:
        '200':
          description: ノード健康状態
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeHealthResponse'
        '404':
          description: ノードが見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    nodeTokenAuth:
      type: apiKey
      in: header
      name: X-Node-Token
      description: ノード登録時に発行されたトークン

    bearerAuth:
      type: http
      scheme: bearer

  schemas:
    HeartbeatRequest:
      type: object
      required:
        - node_id
      properties:
        node_id:
          type: string
          description: ノードID
        gpu_metrics:
          $ref: '#/components/schemas/GpuMetrics'
        system_metrics:
          $ref: '#/components/schemas/SystemMetrics'
        active_requests:
          type: integer
          description: 処理中リクエスト数
        loaded_models:
          type: array
          items:
            type: string
          description: ロード済みモデル一覧
      example:
        node_id: "node-1"
        gpu_metrics:
          usage: 45.5
          vram_usage: 78.2
          temperature: 65.0
        system_metrics:
          cpu_usage: 30.0
          memory_usage: 50.0
        active_requests: 2
        loaded_models:
          - "llama-3.2-1b"

    GpuMetrics:
      type: object
      properties:
        usage:
          type: number
          format: float
          minimum: 0
          maximum: 100
          description: GPU使用率（%）
        vram_usage:
          type: number
          format: float
          minimum: 0
          maximum: 100
          description: VRAM使用率（%）
        temperature:
          type: number
          format: float
          description: GPU温度（℃）
        vram_used_mb:
          type: integer
          description: VRAM使用量（MB）
        vram_total_mb:
          type: integer
          description: VRAM総容量（MB）

    SystemMetrics:
      type: object
      properties:
        cpu_usage:
          type: number
          format: float
          minimum: 0
          maximum: 100
          description: CPU使用率（%）
        memory_usage:
          type: number
          format: float
          minimum: 0
          maximum: 100
          description: メモリ使用率（%）

    HeartbeatResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, not_registered, invalid_token]
          description: 処理結果
        server_time:
          type: integer
          description: サーバー時刻（Unix timestamp）
      example:
        status: "ok"
        server_time: 1704067200

    NodeHealthListResponse:
      type: object
      properties:
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/NodeHealthSummary'

    NodeHealthSummary:
      type: object
      properties:
        id:
          type: string
          description: ノードID
        state:
          type: string
          enum: [pending, registering, online, offline]
          description: ノード状態
        last_seen:
          type: string
          format: date-time
          description: 最終ハートビート時刻

    NodeHealthResponse:
      type: object
      properties:
        node_id:
          type: string
        state:
          type: string
          enum: [pending, registering, online, offline]
        last_seen:
          type: string
          format: date-time
        time_until_timeout:
          type: integer
          description: タイムアウトまでの残り秒数
        consecutive_heartbeats:
          type: integer
          description: 連続ハートビート成功回数
        uptime_seconds:
          type: integer
          description: オンライン継続時間（秒）

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - message
            - type
          properties:
            message:
              type: string
            type:
              type: string
            code:
              type: string
