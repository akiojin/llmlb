# 機能仕様書: ヘルスチェックシステム

**機能ID**: `SPEC-443acc8c`
**作成日**: 2025-10-30
**ステータス**: ⚠️ 廃止予定 (Deprecated)
**元のSPEC**: SPEC-32e2b31a から分割
**依存SPEC**: SPEC-94621a1f（ノード自己登録）← 廃止予定
**後継SPEC**: SPEC-66555000（ロードバランサー主導エンドポイント登録システム）

> **⚠️ 廃止予定**
>
> このSPECは **SPEC-66555000（ロードバランサー主導エンドポイント登録システム）** により廃止されます。
>
> **廃止理由**:
>
> - プッシュ型（ノード→ロードバランサー）からプル型（ロードバランサー→エンドポイント）に変更
> - ノード専用のヘルスチェックから、全エンドポイント統一のヘルスチェックに移行
>
> **影響を受けるAPI**:
>
> - `POST /v0/health` → 廃止
> - `X-Node-Token` → 廃止
>
> **新方式**:
>
> - ロードバランサー側から各エンドポイントへ定期的にヘルスチェックを実行（プル型）
> - エンドポイントタイプ別のチェック方法（自社ノード: GET /v1/models、Ollama: GET /api/tags など）

## 概要

ノードの稼働状況を定期的に監視し、障害を自動検知するヘルスチェックシステム。応答がないノードは自動的にリクエスト振り分けから除外され、復旧時に自動的に再登録される。

## ユーザーシナリオ＆テスト

### ユーザーストーリー - ヘルスチェックと自動障害検知

ロードバランサーは各ノードの稼働状況を定期的に監視し、応答がないノードを自動的に検出する。障害が検出されたノードは自動的にリクエスト振り分けから除外され、復旧時に自動的に再登録される。

**この優先度の理由**: 基本的なロードバランシングが動作していれば、障害検知は追加機能として実装可能。手動でのノード管理でも最低限の運用は可能。

**独立テスト**: ノードを強制終了し、ロードバランサーがそれを検知して除外することで価値を提供する。

**受け入れシナリオ**:

1. **前提** 3台のノードが登録され稼働中、**実行** 1台のノードを強制終了する、**結果** 30秒以内にロードバランサーが障害を検知し、該当ノードを「オフライン」状態にする
2. **前提** 1台のノードがオフライン状態、**実行** 新しいリクエストを送信する、**結果** オフラインのノードにはリクエストが振り分けられず、オンラインのノードのみが使用される
3. **前提** 1台のノードがオフライン状態、**実行** そのノードを再起動する、**結果** ノードが自動的にロードバランサーに再登録され、リクエスト振り分けの対象に戻る
4. **前提** すべてのノードがオフライン、**実行** 新しいリクエストを送信する、**結果** 「すべてのノードが利用不可」というエラーメッセージが返される

## 機能要件

### FR-013: 定期的なヘルスチェック

ノードは定期的にロードバランサーへハートビート（ヘルスチェック＋メトリクス）を送信し、ロードバランサーはそれを受信して稼働状況を更新する（ロードバランサーからノードへポーリングはしない）。

- 送信間隔: 30秒ごと（Node側設定。例: `XLLM_HEARTBEAT_SECS`）
- 送信先: `POST /v0/health`（`X-Node-Token` 必須）

### FR-014: 障害検知

ノードからの応答がない場合、障害と判定する。

- 監視間隔: ロードバランサーのバックグラウンド監視（環境変数 `LLMLB_HEALTH_CHECK_INTERVAL` / フォールバック `HEALTH_CHECK_INTERVAL`）
- タイムアウト期間: 60秒（環境変数 `LLMLB_NODE_TIMEOUT` / フォールバック `NODE_TIMEOUT`）
- 最後のハートビート（`last_seen`）からタイムアウト以上経過したらオフライン状態に遷移
- オフライン状態のノードはリクエスト振り分けから除外

### FR-015: 自動復旧

オフライン状態のノードが再起動された際、自動的に検出して復帰させる。

- ノードからのハートビートを受信したらオンライン状態に復帰
- 復帰したノードは即座にリクエスト振り分けの対象となる

### FR-016: ヘルスチェックAPI

ロードバランサーはノードからのヘルスチェック受信エンドポイントを提供する。

- エンドポイント: `POST /v0/health`
- 認証: `X-Node-Token: <node_token>` 必須
- レスポンス: 200 OK

## 非機能要件

### NFR-008: 信頼性

- ヘルスチェック失敗による誤検知を最小化
- ネットワーク遅延を考慮したタイムアウト設定

### NFR-009: パフォーマンス

- ヘルスチェック処理がプロキシ処理に影響を与えない
- バックグラウンドで非同期に実行

## 実装状態

✅ **実装済み** (PR #1でマージ済み)

- 定期的なヘルスチェック
- ハートビートベースの障害検知
- 自動オフライン遷移
- 自動復旧（ハートビート受信時）
- 環境変数による設定可能化
- 統合テスト

---

## Clarifications

### Session 2025-12-24

仕様を精査した結果、重大な曖昧さは検出されませんでした。実装も完了しています。

**確認済み事項**:

- ハートビート送信間隔: 30秒（Node側、`XLLM_HEARTBEAT_SECS`で設定可能）（FR-013で明記）
- タイムアウト期間: 60秒（`LLMLB_NODE_TIMEOUT`で設定可能）（FR-014で明記）
- 障害検知: `last_seen`からタイムアウト経過でオフライン遷移（FR-014で明記）
- 自動復旧: ハートビート受信時にオンライン復帰（FR-015で明記）
- API: `POST /v0/health`、`X-Node-Token`必須（FR-016で明記）

**アーキテクチャの確認**:

- プッシュ型: ノード→ロードバランサーへのハートビート送信（ロードバランサーからのポーリングなし）
