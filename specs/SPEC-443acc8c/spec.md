# 機能仕様書: ヘルスチェックシステム

**機能ID**: `SPEC-443acc8c`
**作成日**: 2025-10-30
**ステータス**: 実装済み
**元のSPEC**: SPEC-32e2b31a から分割
**依存SPEC**: SPEC-94621a1f（エージェント自己登録）

## 概要

エージェントの稼働状況を定期的に監視し、障害を自動検知するヘルスチェックシステム。応答がないエージェントは自動的にリクエスト振り分けから除外され、復旧時に自動的に再登録される。

## ユーザーシナリオ＆テスト

### ユーザーストーリー - ヘルスチェックと自動障害検知

コーディネーターは各エージェントの稼働状況を定期的に監視し、応答がないエージェントを自動的に検出する。障害が検出されたエージェントは自動的にリクエスト振り分けから除外され、復旧時に自動的に再登録される。

**この優先度の理由**: 基本的なロードバランシングが動作していれば、障害検知は追加機能として実装可能。手動でのエージェント管理でも最低限の運用は可能。

**独立テスト**: エージェントを強制終了し、コーディネーターがそれを検知して除外することで価値を提供する。

**受け入れシナリオ**:

1. **前提** 3台のエージェントが登録され稼働中、**実行** 1台のエージェントを強制終了する、**結果** 30秒以内にコーディネーターが障害を検知し、該当エージェントを「オフライン」状態にする
2. **前提** 1台のエージェントがオフライン状態、**実行** 新しいリクエストを送信する、**結果** オフラインのエージェントにはリクエストが振り分けられず、オンラインのエージェントのみが使用される
3. **前提** 1台のエージェントがオフライン状態、**実行** そのエージェントを再起動する、**結果** エージェントが自動的にコーディネーターに再登録され、リクエスト振り分けの対象に戻る
4. **前提** すべてのエージェントがオフライン、**実行** 新しいリクエストを送信する、**結果** 「すべてのエージェントが利用不可」というエラーメッセージが返される

## 機能要件

### FR-013: 定期的なヘルスチェック

コーディネーターは定期的に各エージェントの稼働状況を確認する。

- チェック間隔: 30秒ごと（環境変数`HEALTH_CHECK_INTERVAL`で設定可能）
- ヘルスチェックAPI: `GET /api/health` をエージェントに送信
- タイムアウト: 5秒

### FR-014: 障害検知

エージェントからの応答がない場合、障害と判定する。

- タイムアウト期間: 60秒（環境変数`AGENT_TIMEOUT`で設定可能）
- 最後のハートビートから60秒以上経過したらオフライン状態に遷移
- オフライン状態のエージェントはリクエスト振り分けから除外

### FR-015: 自動復旧

オフライン状態のエージェントが再起動された際、自動的に検出して復帰させる。

- エージェントからのハートビートを受信したらオンライン状態に復帰
- 復帰したエージェントは即座にリクエスト振り分けの対象となる

### FR-016: ヘルスチェックAPI

エージェントはヘルスチェックエンドポイントを提供する。

- エンドポイント: `GET /api/health`
- レスポンス: `{"status": "ok", "timestamp": "..."}`

## 非機能要件

### NFR-008: 信頼性

- ヘルスチェック失敗による誤検知を最小化
- ネットワーク遅延を考慮したタイムアウト設定

### NFR-009: パフォーマンス

- ヘルスチェック処理がプロキシ処理に影響を与えない
- バックグラウンドで非同期に実行

## 実装状態

✅ **実装済み** (PR #1でマージ済み)

- 定期的なヘルスチェック
- ハートビートベースの障害検知
- 自動オフライン遷移
- 自動復旧（ハートビート受信時）
- 環境変数による設定可能化
- 統合テスト
