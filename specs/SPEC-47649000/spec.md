# 機能仕様書: モデルメタデータSQLite統合

**機能ID**: `SPEC-47649000`
**作成日**: 2025-12-20
**ステータス**: ✅ 実装完了（6/6タスク完了）
**入力**: ユーザー説明: "モデルメタデータ（models.json）をSQLiteに統合し、認証システム（router.db）と同じDBで管理する。タグ検索やソースフィルタリングを高速化する。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - モデル一覧の高速表示 (優先度: P1)

管理者として、ダッシュボードでモデル一覧を開いた際に、数百件のモデルがあっても
1秒以内に一覧が表示されることを期待する。現在のJSON読み込み方式では
ファイルサイズが大きくなると遅延が発生する可能性がある。

**この優先度の理由**: モデル一覧はダッシュボードの主要機能であり、
レスポンス速度はユーザー体験に直結する。

**独立テスト**: ダッシュボードのモデル一覧ページを開き、
表示完了までの時間を計測することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** 100件以上のモデルが登録されている、**実行** ダッシュボードのモデル一覧を開く、
   **結果** 1秒以内に一覧が表示される
2. **前提** ルーターが起動している、**実行** モデル一覧APIを呼び出す、
   **結果** モデル情報が正しく返される

---

### ユーザーストーリー2 - タグによるモデル検索 (優先度: P1)

開発者として、特定の機能（vision、tools、embeddingなど）を持つモデルを
タグで素早く検索したい。タグ検索が高速であれば、適切なモデルを
効率的に見つけることができる。

**この優先度の理由**: タグ検索はモデル選択の主要なユースケースであり、
JSONファイル全体を読み込む現在の方式では非効率。

**独立テスト**: 特定のタグ（例: "vision"）でモデルを検索し、
該当するモデルのみが返されることを確認。

**受け入れシナリオ**:

1. **前提** "vision"タグを持つモデルが存在する、**実行** タグ"vision"で検索、
   **結果** visionタグを持つモデルのみが一覧に表示される
2. **前提** 複数のタグを持つモデルがある、**実行** 複数タグでAND検索、
   **結果** すべてのタグを持つモデルのみが返される

---

### ユーザーストーリー3 - ソースによるモデルフィルタリング (優先度: P2)

管理者として、モデルのソース（HuggingFace GGUF、HuggingFace ONNX、
事前定義など）でフィルタリングしたい。ソース別にモデルを管理することで、
モデルの更新やメンテナンスが容易になる。

**この優先度の理由**: ソースフィルタリングは管理作業の効率化に寄与するが、
タグ検索ほど頻繁には使用されない。

**独立テスト**: 特定のソース（例: "hf_gguf"）でフィルタし、
該当するモデルのみが返されることを確認。

**受け入れシナリオ**:

1. **前提** 複数ソースのモデルが登録されている、**実行** ソース"hf_gguf"でフィルタ、
   **結果** HuggingFace GGUFソースのモデルのみが表示される

---

### ユーザーストーリー4 - 既存データの自動移行 (優先度: P1)

システム管理者として、ルーターのアップデート後に既存の`models.json`データが
自動的に新しい保存形式に移行されることを期待する。手動でのデータ移行は
避けたい。

**この優先度の理由**: データ移行の自動化は、アップグレード時のユーザー負担を
最小化するために必須。

**独立テスト**: 既存の`models.json`がある状態でルーターを起動し、
データが正しく移行されていることを確認。

**受け入れシナリオ**:

1. **前提** 既存の`models.json`にモデルデータがある、**実行** ルーターを起動、
   **結果** モデルデータが新形式に移行され、元ファイルは`.migrated`にリネームされる
2. **前提** 移行済みの状態、**実行** ルーターを再起動、
   **結果** 二重移行は発生せず、既存データが保持される

---

### エッジケース

- モデル名が重複した場合、どのように処理するか？
  - 既存モデルを上書きし、警告ログを出力する
- 移行中にルーターがクラッシュした場合、データは失われるか？
  - トランザクションにより、移行は原子的に行われる
- 空の`models.json`の場合は？
  - 空のテーブルとして移行が完了する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはモデルメタデータを認証システムと同じデータベースに保存する必要がある
- **FR-002**: システムはモデル名での検索をサポートする必要がある
- **FR-003**: システムはタグでのモデル検索をサポートする必要がある
- **FR-004**: システムはソースでのモデルフィルタリングをサポートする必要がある
- **FR-005**: システムは既存の`models.json`からの自動移行をサポートする必要がある
- **FR-006**: システムは移行後も既存のモデル管理APIと互換性を維持する必要がある
- **FR-007**: システムはルーター再起動後もモデルデータを永続化する必要がある

### 主要エンティティ

- **モデル（Model）**: モデルの名前、サイズ、説明、必要メモリ、ソース、パス、
  ダウンロードURL、リポジトリ情報を持つ
- **モデルタグ（ModelTag）**: モデルに紐付くタグ。1つのモデルは複数のタグを持つことができる

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- モデルのバージョン管理（同名モデルの複数バージョン保持）
- モデル使用統計の記録
- モデルのお気に入り機能

---

## 技術制約 *(該当する場合)*

- 既存の認証システム（`router.db`）と同じSQLiteデータベースを使用する
- 既存のモデル管理API（`/v1/models`）との後方互換性を維持する
- 起動時の既存JSONファイルからの自動移行をサポートする

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- ルーターの認証システム（SQLite）が既に実装済み
- 既存の`models.json`ベースのモデル管理機能が存在する
- マイグレーションフレームワークが利用可能

---

## 依存関係 *(該当する場合)*

### 前提条件（このSPECが依存するもの）

- なし（独立機能）
- 既存の認証データベース（`router/src/db/migrations.rs`）✅ 実装済み
- 既存のモデル管理API（`router/src/api/models.rs`）✅ 実装済み
- 既存のモデルストレージ実装（`router/src/db/models.rs`）✅ 実装済み

### 依存元（このSPECに依存するもの）

- **SPEC-e03a404c**: 画像認識モデル対応

---

## Clarifications

### Session 2025-12-24

仕様を精査した結果、重大な曖昧さは検出されませんでした。

**確認済み事項**:

- 保存先: 認証システムと同じDB（router.db）（FR-001で明記）
- 検索機能: モデル名、タグ、ソースでの検索/フィルタ対応（FR-002〜FR-004で明記）
- 移行方式: models.json → SQLite自動移行（FR-005で明記）
- 移行後ファイル: .migratedにリネーム（受け入れシナリオで明記）
- 後方互換性: 既存API 100%互換（成功基準4で明記）
- パフォーマンス: 一覧取得1秒以内、タグ検索0.5秒以内（成功基準1,2で明記）

**エッジケース対応**:

- 重複モデル名: 上書き＋警告ログ（エッジケースで明記）
- 移行中クラッシュ: トランザクションで原子的に処理（エッジケースで明記）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. 100件以上のモデルがある場合でも、モデル一覧の取得が1秒以内に完了する
2. タグ検索の結果が0.5秒以内に返される
3. 既存の`models.json`からの移行が自動的に行われ、データ損失がない
4. 既存のモデル管理APIが変更なく動作する（後方互換性100%）
5. ルーター再起動後もモデルデータが永続化されている
