# 機能仕様書: モデル自動解決機能

**機能ID**: `SPEC-48678000`
**作成日**: 2025-12-06
**ステータス**: 下書き
**入力**: ユーザー説明: "モデル自動解決機能: モデルがローカルにない場合、1)共有パスがあれば直接参照、2)共有パスがなければ外部ソース（Hugging Face 等）またはルータープロキシ経由でダウンロード、3)いずれにも無ければエラー。従来のauto_repair（破損検出・修復）機能は削除。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 共有パスからの直接モデル利用 (優先度: P1)

ノードオペレーターとして、推論リクエストを受けた際にモデルがローカルにない場合、ルーター側で管理されている共有ストレージ上のモデルを直接利用できるようにしたい。これにより、各ノードにモデルをコピーする必要がなくなり、ストレージ効率が向上する。

**この優先度の理由**: 最も一般的なユースケースであり、ストレージ効率とモデル更新の即時反映という2つの重要なメリットを提供する。

**独立テスト**: 共有パスにモデルが存在する状態で推論リクエストを送信し、モデルがロードされて推論結果が返ることを確認することで完全にテストできる。

**受け入れシナリオ**:

1. **前提** ノードのローカルにモデルがなく、共有パスにモデルが存在する、**実行** 推論リクエストを送信、**結果** 共有パスからモデルが直接ロードされ、推論結果が返る

2. **前提** 共有パスのモデルが更新された、**実行** 次の推論リクエストを送信、**結果** 更新されたモデルが使用される（ノード側でコピー不要）

---

### ユーザーストーリー2 - 外部ソース/プロキシ経由でのモデル取得 (優先度: P2)

ノードオペレーターとして、共有パスにアクセスできない環境でも、外部ソース（Hugging Face 等）またはルーターのプロキシ経由でモデルをダウンロードできるようにしたい。これにより、共有ストレージがない環境でもシステムを運用できる。

**この優先度の理由**: 共有ストレージを持たない環境でのフォールバック手段として必要。共有パスが利用できる環境では使用されない。

**独立テスト**: 共有パスがアクセス不可な状態で推論リクエストを送信し、外部ソース（またはプロキシ）経由でモデルがダウンロードされることを確認する。

**受け入れシナリオ**:

1. **前提** ノードのローカルにモデルがなく、共有パスがアクセス不可、外部ソース（HF等）が利用可能、**実行** 推論リクエストを送信、**結果** モデルがダウンロードされ、ローカルに保存後、推論結果が返る

---

### ユーザーストーリー3 - モデル不在時のエラー通知 (優先度: P2)

ノードオペレーターとして、リクエストされたモデルがどこにも存在しない場合、明確なエラーメッセージを受け取りたい。これにより、問題の原因を迅速に特定し、適切な対処（モデルの事前配布など）を行える。

**この優先度の理由**: 運用時のトラブルシューティングに必須。ユーザーが問題を理解し対処するために必要。

**独立テスト**: 存在しないモデル名で推論リクエストを送信し、適切なエラーレスポンスが返ることを確認する。

**受け入れシナリオ**:

1. **前提** モデルがローカル、共有パス、ルーターのいずれにも存在しない、**実行** 推論リクエストを送信、**結果** モデルが見つからないことを示すエラーレスポンスが返る

---

### エッジケース

- 共有パスへのネットワーク接続が切断された場合、外部ソース/プロキシ経由のダウンロードにフォールバックする
- ルーターAPI経由のダウンロード中にノードが再起動した場合、次回起動時に再ダウンロードを試行する
- 複数のリクエストが同時に同じモデルを要求した場合、重複ダウンロードを防止する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはモデル要求時、まずローカルストレージを確認し、存在すればそのパスを使用する必要がある
- **FR-002**: システムはローカルにモデルがない場合、共有パス（設定済みの場合）を直接参照する必要がある（コピーしない）
- **FR-003**: システムは共有パスがアクセス不可の場合、**許可リスト内の外部ソース**または**ルーターのプロキシ**経由でモデルをダウンロードする必要がある
- **FR-004**: システムはダウンロードしたモデルをローカルに保存する必要がある
- **FR-005**: システムはローカル/共有/外部ソースのいずれにもモデルが存在しない場合、エラーを返す必要がある
- **FR-006**: システムは**許可リスト内に限り**外部ソースからの直接ダウンロードを許可する
- **FR-007**: システムは従来のauto_repair（破損検出・修復）機能を削除する必要がある
- **FR-008**: システムは登録形式とGPUバックエンドに基づき、必要アーティファクトのみを取得する必要がある

### 主要エンティティ

- **モデルパス**: モデルファイル（GGUF/safetensors等）の場所を示す。ローカル、共有パス、または外部ソース/プロキシ経由で解決される
- **共有パス**: 設定済みの共有ストレージ上のモデルファイルへのパス（ルーター管理に限定しない）
- **ルーターAPI**: マニフェスト提示やプロキシ配信に使うAPI（例: `/v0/models/registry/...`）

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- モデルファイルの破損検出・自動修復機能（auto_repair）
- ルーターによる強制的な事前キャッシュ（Node主導方針のため）
- モデルファイルのバージョン管理・ロールバック機能

---

## 技術制約 *(該当する場合)*

- 共有パスはNFSまたは同等のネットワークファイルシステムを前提とする
- 外部ソースからの取得は許可リストに限定する

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- ルーターが稼働しており、マニフェスト/APIが参照可能である
- ノードから外部ソース（HF等）またはルーターへのネットワーク接続が確立されている

---

## 依存関係 *(該当する場合)*

### 前提条件（このSPECが依存するもの）

- **SPEC-dcaeaec4**: LLM-Router独自モデルストレージ ✅ 実装済み
- **SPEC-11106000**: Hugging Face URL登録 ✅ 実装済み
- `/v1/models/blob/:model_name` エンドポイント経由でのモデルファイル配信

### 依存元（このSPECに依存するもの）

- なし

---

## Clarifications

### Session 2025-12-24

仕様を精査した結果、重大な曖昧さは検出されませんでした。

**確認済み事項**:

- 解決優先順位: ローカル → 共有パス → 外部ソース/プロキシ（FR-001〜FR-003で明記）
- 共有パス動作: 直接参照、コピーしない（FR-002で明記）
- 許可事項: 許可リスト内の外部ソースから直接ダウンロード可（FR-006で明記）
- 削除対象: auto_repair機能の完全削除（FR-007で明記）
- エラー応答時間: 1秒以内（成功基準3で明記）

**実装時の判断に委ねる事項**:

- 外部ソース/プロキシ経由ダウンロード時のタイムアウト値（推奨: 5分）
- ダウンロード進捗表示の粒度（推奨: 10%単位）
- 同時ダウンロード数の上限（推奨: 1件/ノード）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. モデルがローカルにない場合でも、共有パスまたは外部ソース/プロキシ経由で自動的に取得され、推論リクエストが成功する
2. 共有パスからの直接参照時、モデルファイルのコピーが発生しない
3. モデルがどこにも存在しない場合、1秒以内に明確なエラーメッセージが返る
4. 従来のauto_repair関連のコードが完全に削除され、関連する環境変数の警告が表示されない
