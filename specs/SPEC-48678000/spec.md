# 機能仕様書: モデル自動解決機能

**機能ID**: `SPEC-48678000`
**作成日**: 2025-12-06
**ステータス**: 下書き
**入力**: ユーザー説明: "モデル自動解決機能: ノード側でモデルが存在しない場合、supported_models.jsonに定義されたモデルを外部ソース（Hugging Face等）またはルータープロキシ経由で自動取得する。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 外部ソースからのモデル自動取得 (優先度: P1)

ノードオペレーターとして、推論リクエストを受けた際にモデルがローカルにない場合、`supported_models.json`に定義済みのモデルを外部ソース（Hugging Face等）から自動的にダウンロードできるようにしたい。これにより、手動でのモデル配布なしにシステムを運用できる。

**この優先度の理由**: ノードの自律運用を可能にし、モデル配布の手間を大幅に削減する。

**独立テスト**: `supported_models.json`に定義されたモデルで推論リクエストを送信し、モデルが自動ダウンロードされて推論結果が返ることを確認できる。

**受け入れシナリオ**:

1. **前提** ノードのローカルにモデルがなく、`supported_models.json`にモデルが定義済み、**実行** 推論リクエストを送信、**結果** 外部ソースからモデルがダウンロードされ、推論結果が返る

2. **前提** モデルのダウンロード中、**実行** ダウンロード進捗を確認、**結果** 進捗状況が通知される

---

### ユーザーストーリー2 - ルータープロキシ経由でのモデル取得 (優先度: P2)

ノードオペレーターとして、ノードから外部ソースに直接アクセスできない環境でも、ルーターのプロキシ経由でモデルをダウンロードできるようにしたい。これにより、セキュリティポリシーで外部アクセスが制限された環境でもシステムを運用できる。

**この優先度の理由**: 企業環境での運用を可能にするフォールバック手段として必要。

**独立テスト**: 外部ソースへの直接アクセスがブロックされた状態で推論リクエストを送信し、ルータープロキシ経由でモデルがダウンロードされることを確認する。

**受け入れシナリオ**:

1. **前提** ノードから外部ソースへの直接アクセスが不可、ルーターへのアクセスは可能、**実行** 推論リクエストを送信、**結果** ルータープロキシ経由でモデルがダウンロードされ、推論結果が返る

---

### ユーザーストーリー3 - 未定義モデル要求時のエラー通知 (優先度: P1)

ノードオペレーターとして、`supported_models.json`に未定義のモデルをリクエストされた場合、明確なエラーメッセージを受け取りたい。これにより、問題の原因を迅速に特定し、適切な対処（モデル定義の追加など）を行える。

**この優先度の理由**: 運用時のトラブルシューティングに必須。ユーザーが問題を理解し対処するために必要。

**独立テスト**: `supported_models.json`に未定義のモデル名で推論リクエストを送信し、適切なエラーレスポンスが返ることを確認する。

**受け入れシナリオ**:

1. **前提** モデルが`supported_models.json`に未定義、**実行** 推論リクエストを送信、**結果** モデルがサポートされていないことを示すエラーレスポンスが返る

---

### エッジケース

- ダウンロード中にノードが再起動した場合、次回起動時に再ダウンロードを試行する
- 複数のリクエストが同時に同じモデルを要求した場合、重複ダウンロードを防止する
- ダウンロード中のリクエストには適切な待機レスポンスを返す

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはモデル要求時、まずローカルストレージを確認し、存在すればそのパスを使用する必要がある
- **FR-002**: システムはローカルにモデルがない場合、`supported_models.json`の定義を参照し、外部ソース（Hugging Face等）からダウンロードする必要がある
- **FR-003**: システムは外部ソースへの直接アクセスが不可の場合、ルーターのプロキシ経由でモデルをダウンロードする必要がある
- **FR-004**: システムはダウンロードしたモデルをローカルに保存する必要がある
- **FR-005**: システムは`supported_models.json`に未定義のモデルが要求された場合、エラーを返す必要がある
- **FR-006**: システムは登録形式とGPUバックエンドに基づき、必要アーティファクトのみを取得する必要がある
- **FR-007**: システムは同一モデルへの同時ダウンロード要求を検出し、重複ダウンロードを防止する必要がある
- **FR-008**: システムはダウンロード進捗を通知する必要がある（推奨: 10%単位）

### 主要エンティティ

- **supported_models.json**: サポートされるモデルの定義ファイル。モデルID、外部ソースURL、形式、必要アーティファクトを含む
- **モデルパス**: モデルファイル（GGUF/safetensors等）の場所を示す。ローカルまたは外部ソース/プロキシ経由で解決される
- **ルーターAPI**: プロキシ配信に使うAPI（例: `/v1/models/blob/:model_name`）

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- モデルファイルの破損検出・自動修復機能（auto_repair）
- モデルファイルのバージョン管理・ロールバック機能
- 共有ストレージ（NFS等）からの直接モデル参照（廃止）

---

## 技術制約 *(該当する場合)*

- 取得可能なモデルは`supported_models.json`に定義されたもののみに限定される
- ノードは外部ソースまたはルーターの少なくとも一方にアクセス可能である必要がある

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- `supported_models.json`が最新の状態で維持されている
- ノードから外部ソース（HF等）またはルーターへのネットワーク接続が確立されている

---

## 依存関係 *(該当する場合)*

### 前提条件（このSPECが依存するもの）

- **SPEC-dcaeaec4**: LLM-Router独自モデルストレージ
- **SPEC-11106000**: Hugging Face URL登録
- **SPEC-6cd7f960**: 対応モデルリスト型管理（`supported_models.json`）
- `/v1/models/blob/:model_name` エンドポイント経由でのモデルファイル配信

### 依存元（このSPECに依存するもの）

- なし

---

## Clarifications

### Session 2025-12-30

インタビューにより以下が確定:

- **共有パス機能**: 廃止（本SPECのスコープから削除）
- **対象モデル**: `supported_models.json`に定義されたモデルのみ
- **目的再定義**: ノード側での自動取得（共有パス参照は行わない）
- **解決優先順位**: ローカル → 外部ソース → ルータープロキシ

**実装時の判断に委ねる事項**:

- 外部ソース/プロキシ経由ダウンロード時のタイムアウト値（推奨: 5分）
- ダウンロード進捗表示の粒度（推奨: 10%単位）
- 同時ダウンロード数の上限（推奨: 1件/ノード）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. `supported_models.json`に定義されたモデルがローカルにない場合でも、外部ソースまたはプロキシ経由で自動的に取得され、推論リクエストが成功する
2. `supported_models.json`に未定義のモデルが要求された場合、1秒以内に明確なエラーメッセージが返る
3. 同一モデルへの同時リクエストで重複ダウンロードが発生しない
4. ダウンロード進捗が10%単位で通知される
