# 機能仕様書: クラウドモデルプレフィックスルーティング

**機能ID**: `SPEC-4b6e9f2a`  
**作成日**: 2025-11-25  
**ステータス**: 実装完了  
**依存SPEC**: SPEC-63acef08（統一APIプロキシ）

## 概要

OpenAI互換エンドポイントで指定されたモデル名にクラウド事業者プレフィックス（`openai:` `google:` `anthropic:`）が付与されている場合、ロードバランサーはローカルLLMに転送せず、対応するクラウド推論APIへプロキシする。プレフィックスなしのモデルは従来どおりローカルノードへルーティングする。

この仕組みにより、利用者は単一のエンドポイントからローカルLLMとクラウドLLMをシームレスに使い分けられる。

## ユーザーストーリー

1. **クラウド強制指定**  
   - 前提: `OPENAI_API_KEY` が設定されている  
   - 行動: `model: "openai:gpt-4.1"` を指定して `/v1/chat/completions` を呼び出す  
   - 結果: ロードバランサーはノードには振り分けず OpenAI API に転送し、応答をそのまま返す

2. **ベンダー切替**  
   - 前提: `GOOGLE_API_KEY` または相当の認証情報が設定されている  
   - 行動: `model: "google:gemini-1.5-pro"` を指定してチャットリクエストを送信  
   - 結果: Google Generative Language API に転送され、レスポンスが返る

3. **Anthropic利用**  
   - 前提: `ANTHROPIC_API_KEY` が設定されている  
   - 行動: `model: "anthropic:claude-3-opus"` を指定してチャットリクエストを送信  
   - 結果: Anthropic API に転送され、レスポンスが返る

4. **ストリーミング**  
   - 前提: いずれかのクラウドキーが設定されている  
   - 行動: `stream: true` でクラウドプレフィックス付きモデルを指定  
   - 結果: ロードバランサーはクラウドAPIのストリーミングレスポンスをSSEとしてクライアントへ中継する

5. **認証未設定エラー**  
   - 前提: 該当ベンダーのAPIキーが未設定  
   - 行動: `model: "openai:gpt-4.1"` などを指定  
   - 結果: 401（または 400）で「当該クラウドAPIキーが未設定」エラーを返す

6. **ローカル優先の既存動作維持**  
   - 行動: プレフィックスなし（例: `model: "gpt-oss:20b"`）でリクエスト  
   - 結果: 従来どおりローカルノードにルーティングされる

## 機能要件

- **FR-CLD-001: プレフィックス検出**  
  - モデル名の先頭に `openai:` `google:` `anthropic:`（`ahtnorpic:` のタイポ互換含む）が付いている場合、クラウド経路を選択する。

- **FR-CLD-002: クラウドAPIプロキシ**  
  - プレフィックスに応じて各クラウド推論APIへHTTPリクエストを送信し、結果をOpenAI互換形式でクライアントに返す。  
  - 必要なAPIキー/エンドポイントは環境変数で設定できること。  
    - OpenAI: `OPENAI_API_KEY`（必須）、`OPENAI_BASE_URL`（任意）  
    - Google: `GOOGLE_API_KEY` もしくは同等の認証情報、`GOOGLE_API_BASE_URL`（任意）  
    - Anthropic: `ANTHROPIC_API_KEY`、`ANTHROPIC_API_BASE_URL`（任意）

- **FR-CLD-003: ストリーミング中継**  
  - `stream: true` の場合、クラウドAPIのストリーミングレスポンスをSSEでクライアントへ中継する。  
  - ロードバランサー独自のJSONチャンク生成ではなく、クラウドAPIからのイベントを順次転送する。

- **FR-CLD-004: エラーハンドリング**  
  - APIキー未設定、権限不足、モデル未対応、ベンダーダウン時などを判別し、HTTPステータスとメッセージを明示的に返す。  
  - 不明なプレフィックスは 400 Bad Request とする。

- **FR-CLD-005: ローカルとの分離**  
  - クラウドプレフィックス付きリクエストはローカルノード選択の対象に含めない。  
  - 逆にプレフィックスなしモデルはクラウド経路に送らない。

- **FR-CLD-006: オブザーバビリティ**  
  - ベンダー種別・モデル名を含むトレースID/ログを出力し、遅延・失敗を計測できる。  
  - メトリクスにクラウド呼び出し回数とレイテンシを追加する（ベンダー別カウンタ・ヒストグラム）。
  - ダッシュボード統計でクラウドAPIキーの有無（OpenAI/Google/Anthropic）を確認できる。

## 非機能要件

- 追加のクラウドAPI呼び出しによるレイテンシ増を可視化し、ローカル経路への影響を最小化する。
- 既存のOpenAI互換APIコントラクトテストと両立し、回帰を生まない。
- 環境変数のみで有効化・無効化でき、デフォルトは現行と同一動作（プレフィックスなし=ローカル）。

---

## Clarifications

### Session 2025-12-24

仕様を精査した結果、重大な曖昧さは検出されませんでした。実装も完了しています。

**確認済み事項**:

- 対応ベンダー: openai:, google:, anthropic:（FR-CLD-001で明記）
- 環境変数: OPENAI_API_KEY, GOOGLE_API_KEY, ANTHROPIC_API_KEY（FR-CLD-002で明記）
- ストリーミング: SSE中継（FR-CLD-003で明記）
- エラー処理: APIキー未設定時401/400、不明プレフィックス時400（FR-CLD-004で明記）
- ルーティング分離: プレフィックス付き=クラウド、なし=ローカル（FR-CLD-005で明記）

**オブザーバビリティ**:

- ベンダー別メトリクス、ダッシュボードでのAPIキー有無確認（FR-CLD-006で明記）

### Session 2025-12-30

インタビューにより以下が確定:

**クラウドルーティング原則（重要）**:

- **明示的プレフィックス必須**: `openai:` / `google:` / `anthropic:` のプレフィックス指定がない限り、
  クラウドモデルへのルーティングは**絶対に行わない**
  - 例: `model: "gpt-4o"` → ローカルノードへルーティング（クラウドには送信しない）
  - 例: `model: "openai:gpt-4o"` → OpenAI APIへルーティング
- **理由**: コスト制御と予期しないクラウド課金の防止
- **自動フォールバック禁止**: ローカルモデルが見つからない場合でも、
  プレフィックスなしでクラウドへ自動ルーティングしてはならない

**クラウドAPIエラー処理**:

- **レート制限（429）**: 即座にエラーを返却（リトライしない）
  - クライアント側でリトライ判断を行うべき
- **代替プロバイダーへのフォールバック**: 行わない
  - `openai:gpt-4o` が429を返した場合、`anthropic:claude-3-opus` への自動切替は行わない
  - プロバイダー選択はユーザーの責任
