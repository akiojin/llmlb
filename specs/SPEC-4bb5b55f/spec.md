# SPEC-4bb5b55f: エンドポイント×モデル単位TPS（秒間生成トークン数）可視化

## ステータス

Draft

## 概要

ロードバランサーがプロキシする推論リクエストの応答から、
エンドポイント×モデルの粒度で **TPS（output tokens per second）** を
リアルタイムに計測・蓄積し、ダッシュボード・REST API・WebSocket で
確認できるようにする。

## ビジネス価値

- ハードウェア毎のモデル推論性能を定量的に把握できる
- 同一モデルを複数エンドポイントで比較し、最適な配置を判断できる
- キャパシティプランニング（GPU増設・モデル再配置）の根拠データとなる
- 運用中の性能劣化を早期検知できる

## ユーザーストーリー

### US-1: リアルタイムTPS確認

> 運用担当者として、ダッシュボードのエンドポイント詳細パネルで
> 各モデルの現在のTPS（EMA）を一覧表示し、推論性能を即座に確認したい。

**受け入れ条件:**

- エンドポイント詳細パネルにモデル別TPSテーブルが表示される
- テーブル列: モデル名 | TPS | リクエスト数 | 累計出力トークン | 平均処理時間
- TPS値は小数点1位 + "tok/s" で表示（例: "42.5 tok/s"）
- 未計測のモデルは "—" と表示
- WebSocket経由でリクエスト完了時にリアルタイム更新される

### US-2: TPS履歴トレンド分析

> 運用担当者として、エンドポイント×モデルの日次TPS推移を確認し、
> 性能トレンドや劣化を分析したい。

**受け入れ条件:**

- EndpointDailyStatsに出力トークン累計・処理時間累計が追加される
- 日次平均TPSを計算可能（日次出力トークン累計 / 日次処理時間累計）
- REST APIから日次TPS履歴を取得できる

### US-3: REST API経由のTPS取得

> 外部モニタリングツール連携のために、REST APIからエンドポイント×モデルの
> TPS情報を取得したい。

**受け入れ条件:**

- GET /api/endpoints/{id}/model-tps でモデル別TPS一覧を取得できる
- レスポンスに model_id, tps, request_count,
  total_output_tokens, average_duration_ms を含む
- GET /api/dashboard/overview のレスポンスにTPS情報が含まれる

## 機能要件

### FR-1: TPS計算

- **計算式**: `output_tokens / duration_seconds`
- **対象**: 出力トークン数（completion_tokens）のみ
- **平滑化**: EMA（指数移動平均）α=0.2
- **ストリーミング**: 全出力トークン / ストリーム全体の処理時間で計算
- **トークン取得**: usageフィールド優先、不在時はtiktoken推定
  （推定値と実測値の区別はしない）

### FR-2: 計測対象エンドポイントタイプ

- xLLM: 対象
- Ollama: 対象
- vLLM: 対象
- LM Studio: 対象
- OpenAI互換: **対象外**

### FR-3: インメモリTPS状態管理

- エンドポイントID × モデルID をキーとしたEMA値をインメモリで保持
- リクエスト完了時にEMA更新
- 初期値はNone（未計測）

### FR-4: DB永続化

- EndpointDailyStatsテーブルに以下のカラムを追加:
  - `total_output_tokens` (BIGINT): 日次出力トークン累計
  - `total_duration_ms` (BIGINT): 日次処理時間累計（ミリ秒）
- リクエスト完了時に該当レコードを更新（UPSERT）

### FR-5: REST API

- GET /api/endpoints/{id}/model-tps
  - エンドポイントIDのモデル別TPS一覧を返却
- GET /api/dashboard/overview にTPS情報を含める

### FR-6: WebSocket通知

- 推論リクエスト完了時にTPS更新情報をプッシュ
- 既存のWebSocketフレームに追加情報として含める

### FR-7: ダッシュボードUI

- エンドポイント詳細パネル内にモデル別TPSテーブルを表示
- テーブル列: モデル名 | TPS | リクエスト数 | 累計出力トークン | 平均処理時間
- 表示フォーマット: 小数点1位 + "tok/s"（例: "42.5 tok/s"）
- 未計測のモデル: "—" 表示
- WebSocket経由でリアルタイム更新

## 非機能要件

### NFR-1: パフォーマンス

- TPS計算はリクエスト完了のクリティカルパスに影響を与えない
- EMA更新はO(1)で、追加のメモリ消費はエンドポイント×モデル数に比例

### NFR-2: データ整合性

- インメモリTPS値はプロセス再起動時にリセットされる（許容）
- DB永続化された日次集計は再起動後も保持される

## スコープ外

- TPSベースのルーティング判断（将来の拡張として検討）
- TTFT（Time To First Token）の追跡
- クラウドAPI（OpenAI/Anthropic/Google）のTPS追跡
- OpenAI互換タイプエンドポイントのTPS追跡
