# SPEC-5045f436: トークン累積統計機能

## 概要

LLM Routerシステムにおいて、ノードが処理したリクエストのトークン使用量を
累積・永続化し、コスト管理・課金目的でダッシュボードから可視化する機能を提供する。

## ビジネス価値

- **コスト管理**: 各ノード・モデルのトークン消費量を把握し、運用コストを最適化
- **課金基盤**: ユーザー別・プロジェクト別のトークン使用量追跡による課金基盤構築
- **キャパシティプランニング**: 使用傾向分析によるリソース計画の精度向上

## ユーザーストーリー

### US-1: 運用管理者としてトークン消費を把握したい

> 運用管理者として、各ノードおよびモデルごとのトークン消費量を確認したい。
> それにより、コスト効率の悪いノードやモデルを特定し、運用を最適化できる。

**受け入れ条件**:

- ダッシュボードのノード一覧にトークン統計サマリが表示される
- ノード別、モデル別のトークン消費量を確認できる
- prompt_tokens、completion_tokens、total_tokensが分けて表示される

### US-2: 運用管理者として時系列でトークン使用傾向を分析したい

> 運用管理者として、日次・月次のトークン使用量推移を確認したい。
> それにより、使用傾向を把握し、将来のキャパシティ計画に活用できる。

**受け入れ条件**:

- 累計、日次、月次での集計が可能
- 専用の統計ページでグラフ表示できる
- データは無期限で保持される

### US-3: システムとしてトークン数を正確に記録したい

> システムとして、各リクエストのトークン使用量を正確に記録したい。
> それにより、信頼性の高いコスト管理・課金が実現できる。

**受け入れ条件**:

- ノードレスポンスのusageフィールドからトークン数を取得する
- usageフィールドがない場合はtiktokenで推定する
- ストリーミングレスポンスでもチャンクごとに累積される
- エラー応答でもトークンがカウントされる

## 機能要件

### FR-1: トークン統計の記録

| 項目 | 要件 |
|------|------|
| 記録粒度 | ノード × モデル単位 |
| 記録項目 | prompt_tokens, completion_tokens, total_tokens |
| データソース | ノードレスポンスのusageフィールド（優先）、tiktoken推定（フォールバック） |
| 永続化 | SQLite（既存request_historyパターン踏襲） |
| 更新方式 | バッチ更新（パフォーマンス考慮） |

### FR-2: トークン統計の表示

| 項目 | 要件 |
|------|------|
| ノード一覧 | トークン統計サマリを表示 |
| 専用ページ | 詳細統計・グラフ表示 |
| 集計単位 | 累計 / 日次 / 月次 |
| ルーター集計 | 全ノードの合計を表示 |

### FR-3: トークン取得ロジック

| シナリオ | 処理 |
|----------|------|
| 通常レスポンス（usageあり） | usageフィールドから抽出 |
| 通常レスポンス（usageなし） | tiktokenで推定 |
| ストリーミング | チャンクごとに累積 |
| エラー応答 | トークンをカウント（可能な範囲で） |

### FR-4: データ管理

| 項目 | 要件 |
|------|------|
| 保持期間 | 無期限 |
| リセット機能 | 不要 |
| オフラインノード | 統計情報を保持 |

## 非機能要件

### NFR-1: パフォーマンス

- バッチ更新によりDB書き込み負荷を軽減
- 集計クエリに適切なインデックスを設定

### NFR-2: 互換性

- OpenAI互換APIのusageフィールド形式に準拠
- tiktokenはOpenAI公式トークナイザとして利用

## スコープ外

以下は本SPECのスコープ外とする：

- **単価計算・課金処理**: トークン数のみを記録し、金額計算は行わない
- **レート制限**: トークン数に基づくレート制限は実装しない
- **ユーザー別統計**: 本SPECではノード×モデル粒度のみ対応

## 用語定義

| 用語 | 定義 |
|------|------|
| prompt_tokens | 入力（プロンプト）のトークン数 |
| completion_tokens | 出力（生成テキスト）のトークン数 |
| total_tokens | prompt_tokens + completion_tokens |
| tiktoken | OpenAI公式のトークナイザライブラリ |
| usageフィールド | OpenAI互換APIレスポンスに含まれるトークン使用量情報 |

## 関連SPEC

- なし（新規機能）

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2026-01-04 | 初版作成（インタビュー結果に基づく） |
