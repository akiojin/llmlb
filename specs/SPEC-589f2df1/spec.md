# 機能仕様書: ロードバランシングシステム

**機能ID**: `SPEC-589f2df1`
**作成日**: 2025-10-30
**ステータス**: ✅ 実装完了 (2025-11-06)
**元のSPEC**: SPEC-32e2b31a から分割
**依存SPEC**: SPEC-63acef08（統一APIプロキシ）

## 概要

複数のノード間でリクエストを最適に分散するロードバランシング機能。各ノードの負荷状況に応じて、最も適切なノードにリクエストを振り分ける。

## ユーザーシナリオ＆テスト

### ユーザーストーリー - ロードバランシングと負荷分散

ユーザーが複数のリクエストを送信した際、ロードバランサーは各ノードの負荷状況に応じて最適なノードにリクエストを振り分ける。これにより、特定のマシンに負荷が集中することを防ぐ。

**この優先度の理由**: 基本的なAPI統合が完了していれば、負荷分散の最適化は段階的に改善可能。最初はラウンドロビンで動作し、後で負荷ベースに改善できる。

**独立テスト**: 複数のノードが登録された状態で大量のリクエストを送信し、各ノードへの分散状況を監視することで価値を提供する。

**受け入れシナリオ**:

1. **前提** 3台のノードが登録され、すべてアイドル状態、**実行** 連続して30個のリクエストを送信する、**結果** 各ノードがほぼ均等（各10個前後）のリクエストを処理する
2. **前提** 2台のノードが登録され、1台が高負荷（GPU使用率 90%）、**実行** 新しいリクエストを送信する、**結果** 低負荷のノードが優先的に選択される
3. **前提** 4台のノードが登録されている、**実行** ダッシュボードでリアルタイムのリクエスト分散状況を確認する、**結果** 各ノードが処理中のリクエスト数と処理済みリクエスト数が表示される

## 機能要件

### FR-009: メトリクス収集

ノードから定期的にパフォーマンスメトリクスを収集する。

- メトリクス項目:
  - **GPU使用率**（優先指標）
  - **VRAM使用率**（優先指標）
  - GPU温度
  - 処理中のリクエスト数
  - 平均レスポンスタイム
  - CPU使用率（参考値）
  - メモリ使用率（参考値）
- 収集間隔: 30秒ごと
- エンドポイント: `POST /v0/health`（`X-Node-Token` 必須、body に `runtime_id` を含める）

### FR-010: 負荷ベースのノード選択

収集されたメトリクスに基づいて、最も負荷の低いノードを選択する。
LLM推論はGPU集約的な処理であるため、GPU使用率を最優先指標とする。

- 選択アルゴリズム:
  1. オンライン状態のノードを抽出
  2. **GPU使用率が80%以下のノードを優先**
  3. **VRAM使用率が90%以下のノードを優先**
  4. 処理中のリクエスト数が最も少ないノードを選択
- フォールバック: すべてのノードが高負荷の場合、ラウンドロビンを使用
- 注記: CPU使用率はLLM推論においてはほぼ影響しないため、選択基準から除外

### FR-013: GPUスペック優先度とフォールバック

ノードのGPU能力スコア（0-10000）をロードバランサーが考慮し、以下の順序で優先順位を決定する。

1. **スペック優先**: すべての候補がアイドル（GPU使用率<=80%かつアクティブリクエスト数が少ない）であれば、GPU能力スコアの高いノードから順に選択する。
2. **ビジー時フォールバック**: 最上位スペックがビジー状態（GPU使用率>80%またはVRAM使用率>90%またはアクティブリクエストが閾値超過）の場合、次点のGPU能力スコアを持つノードにフォールバックする。
3. **メトリクス欠如時の扱い**: 一部のノードが最新メトリクスを送信していない場合でも、GPU能力スコアを基準に優先順位を決め、同点のみラウンドロビンで解決する。
4. **メトリクスモード動作**: `LOAD_BALANCER_MODE=metrics` でも同じ優先度ルールを適用する。負荷スコアが同一ならGPU能力スコア→ラウンドロビンの順で決定する。

**受け入れ条件**

- 高スペックのGPUがアイドルなら常に最優先で割り当てられる。
- 高スペックGPUがビジーになると、次点スペックのノードへ自動でリクエストが移る。
- メトリクス欠如時も「スペック→ラウンドロビン」で公平に分配される。

### FR-011: リクエスト統計

各ノードの処理リクエスト数を追跡する。

- トラッキング項目:
  - 総リクエスト数
  - 成功リクエスト数
  - エラーリクエスト数
  - 平均処理時間

### FR-012: カスタムロードバランシングアルゴリズム

将来的に複数のロードバランシングアルゴリズムから選択可能にする。

- サポート予定のアルゴリズム:
  - ラウンドロビン（現在実装済み）
  - 最小接続数
  - 重み付けラウンドロビン
  - レスポンスタイム優先

## 非機能要件

### NFR-006: パフォーマンス

- ノード選択ロジックは10ms以内に完了
- メトリクス収集がプロキシ処理をブロックしない

### NFR-007: スケーラビリティ

- 最大1000台のノードでメトリクスベースの選択が可能

## 実装状態

### ✅ 実装済み

- ラウンドロビン方式のロードバランシング
- 基本的なリクエスト統計

### 🚧 未実装（今後の拡張）

- メトリクスベースのノード選択
- CPU/メモリ使用率の監視
- カスタムロードバランシングアルゴリズム
- リアルタイムメトリクスダッシュボード

---

## Clarifications

### Session 2025-12-24

仕様を精査した結果、重大な曖昧さは検出されませんでした。

**確認済み事項**:

- メトリクス収集間隔: 30秒（FR-009で明記）
- メトリクス項目: GPU使用率、VRAM使用率、GPU温度、処理中リクエスト数、平均レスポンスタイム、CPU使用率（参考値）、メモリ使用率（参考値）（FR-009で明記）
- ノード選択アルゴリズム: GPU使用率80%以下 → VRAM使用率90%以下 → 最小接続数 → ラウンドロビン（FR-010で明記）
- GPU優先度: GPU能力スコア（0-10000）による優先順位決定（FR-013で明記）
- パフォーマンス: ノード選択10ms以内（NFR-006で明記）
- スケーラビリティ: 最大1000台ノード対応（NFR-007で明記）

**重要な設計判断（2025-12-24追加）**:

- LLM推論はGPU集約的な処理であるため、CPU使用率ではなく**GPU使用率/VRAM使用率を最優先指標**とする
- CPU使用率は参考値として収集するが、ノード選択基準からは除外

**実装状態の確認**:

- 実装済み: ラウンドロビン、基本統計
- 未実装: メトリクスベース選択（GPU使用率ベース）、GPU監視、カスタムアルゴリズム
