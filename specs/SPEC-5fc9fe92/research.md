# リサーチ: Playground Chat マルチモーダル対応（SPEC-5fc9fe92）

## 決定事項

### 1) 入力形式（マルチモーダル表現）

**決定**: OpenAI互換の **Chat Completions の content parts 形式**を採用する。

**理由**:
- 既存の `/v1/chat/completions` と整合しやすい
- 画像/音声を「テキストと同じmessages内」で表現でき、追加エンドポイントが不要
- ロードバランサー/クラウドプロバイダへのパススルーと相性が良い

**代替案**:
- 画像/音声を別APIでアップロードし、参照IDを送る  
  → 永続ストレージ、認可、クリーンアップが必要になり、複雑化するため採用しない

---

### 2) 添付データの扱い（送信・保存）

**決定**:
- 添付は「送信時の入力」として扱い、セッション（localStorage）には原則保存しない
- ロードバランサーのリクエスト履歴には、添付の生データを保存せず「要約」に置換して保存する

**理由**:
- localStorage容量の制約により、base64を保存すると破綻しやすい
- 履歴に生データを保存すると、容量・秘匿・監査上のリスクが大きい

**代替案**:
- 添付も含めてセッションを永続化する  
  → 容量問題が大きく、将来的にサーバ保存に寄せる必要が出るため当面は採用しない

---

### 3) 添付の制約（MVPの既定値）

**決定（MVP）**:
- 画像: PNG/JPEG、サイズ上限を設ける
- 音声: WAV/MP3 等、サイズ上限を設ける
- 1メッセージにつき添付は「画像 or 音声」いずれか1つ（同時添付は将来対応）

**理由**:
- UI/テスト/エラー処理が単純になる
- 仕様の受け入れシナリオを満たす最小構成

---

### 4) モデル対応状況（画像/音声の可否）

**決定**:
- UIは「モデルが画像/音声に対応しているか」を表示し、非対応時は添付操作を無効化する
- 初期実装では「明確に判断できる情報」がないモデルを **不明** として扱う

**理由**:
- 誤って送信し、不可解な失敗体験になるのを避ける
- 将来、モデルメタデータ（capabilities）を増やして精度を上げられる

**代替案**:
- すべて“対応”として扱い、失敗したらエラーにする  
  → UXが悪化し、サポート/デバッグコストが増えるため採用しない

---

### 5) 画像/音声の貼り付け（ペースト）

**決定**:
- 画像/音声は、ファイル添付に加えて「貼り付け（ペースト）」でも入力できるようにする
- ブラウザ/OSの制約により貼り付けが取得できない場合は、ファイル添付にフォールバックする

**理由**:
- 「スクショをコピーして貼り付ける」「ファイルをコピーして貼り付ける」ワークフローは高速で、Playgroundの目的に合う
- 貼り付けが使えない環境でも、添付（ファイル選択）で同じ価値を提供できる

**代替案**:
- すべてファイル添付のみにする  
  → UXが落ちるため採用しない

---

### 6) 生成AIの画像/音声の表示

**決定**:
- アシスタントの本文に **画像/音声URL** や **データURL** が含まれる場合、会話ログ上で埋め込み表示する
- 表示に失敗した場合は、リンクとして利用できる形で提示する

**理由**:
- APIを増やさずに、出力の確認体験を改善できる
- テキスト出力しか返せない推論基盤でも、URL表現なら表示に繋げられる

**代替案**:
- 画像/音声の生成専用エンドポイントを新設し、バイナリを返す  
  → ストレージ、認可、クリーンアップなどが必要になり、段階的導入に向かないため採用しない

## リスクと緩和策

- **リスク**: ローカルノードがマルチモーダル推論に対応していない可能性  
  **緩和**: UIで対応状況を明示し、非対応モデルでは添付を無効化する。将来は推論基盤側の対応を別途計画する。
- **リスク**: 添付が大きい場合に応答が遅くなる/失敗する  
  **緩和**: 事前バリデーション（サイズ/形式）と分かりやすいエラー表示を実装する。
