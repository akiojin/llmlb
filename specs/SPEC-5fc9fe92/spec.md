# 機能仕様書: Playground Chat マルチモーダル対応

**機能ID**: `SPEC-5fc9fe92`
**作成日**: 2025-12-13
**ステータス**: 実装済み
**依存SPEC**: SPEC-712c20cf（管理ダッシュボード）
**入力**: ユーザー説明: "Playground Chat をテキスト・画像・音声に対応させたい（マルチモーダル対応）"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー0 - マルチモーダル対応モデルを迷わず選択できる (優先度: P1)

利用者として、Playground Chat のモデル一覧で「画像/音声入力に対応しているモデル」を
迷わず選択したい。マルチモーダル入力はモデル側の対応が必要なため、誤って非対応モデルを選ぶと
添付ができない/失敗するなどの混乱が起きやすい。事前に対応状況が分かれば、学習コストと手戻りを減らせる。

**この優先度の理由**: マルチモーダルは「対応モデルの選択」が成立条件であり、ここが不明確だと
画像/音声入力の価値が大きく毀損されるため。

**独立テスト**: モデル選択UIで、各モデルの画像/音声入力対応状況が確認でき、対応モデルを選択できることを確認する。

**受け入れシナリオ**:

1. **前提** Playground Chat を開く、**実行** モデル一覧を開く、**結果** 各モデルに「画像入力/音声入力」の対応状況が表示される（対応/非対応/不明）
2. **前提** 画像入力に対応したモデルが存在する、**実行** そのモデルを選択し画像添付操作を行う、**結果** 画像添付が有効である
3. **前提** 画像入力に非対応または不明なモデルを選択中、**実行** 画像添付操作を行う、**結果** 添付は無効化される、または明確な理由付きで拒否される

---

### ユーザーストーリー1 - 画像を添付して質問できる (優先度: P1)

利用者として、Playground Chat で画像を添付（貼り付け含む）して質問し、画像の内容を踏まえた回答を得たい。
テキストだけでは説明が難しい状況（スクリーンショット、図、UI、エラー画面など）でも、
すばやく検証・デバッグ・相談ができるようにしたい。

**この優先度の理由**: Playground の価値は「手元で素早く試せること」にある。画像添付は
テキスト入力だけでは代替しづらく、体験価値の伸びが大きい。

**独立テスト**: Playground Chat で画像を添付して送信し、会話ログに画像が表示され、
回答が返ることを確認する（テキストのみの既存動作は維持される）。

**受け入れシナリオ**:

1. **前提** Playground Chat を開きモデルを選択済み、**実行** 画像（PNG/JPEG）を添付して送信、
   **結果** 会話ログに画像とユーザー入力が表示され、画像内容を踏まえた回答が返る
2. **前提** Playground Chat を開きモデルを選択済み、**実行** クリップボードから画像を貼り付け（ペースト）して送信、
   **結果** 会話ログに画像とユーザー入力が表示され、画像内容を踏まえた回答が返る
3. **前提** 画像入力に非対応のモデルを選択中、**実行** 画像を添付/貼り付けしようとする、
   **結果** 添付/貼り付けが無効化される、または明確な理由付きで拒否される（送信できない）
4. **前提** 画像が形式不正またはサイズ上限超過、**実行** 画像を添付/貼り付けして送信、
   **結果** 送信されず、利用者が次に取るべき行動（形式変更/縮小など）が分かるエラーが表示される

---

### ユーザーストーリー2 - 音声を添付して質問できる (優先度: P2)

利用者として、Playground Chat で音声を添付（貼り付け含む）して質問し、音声の内容を踏まえた回答を得たい。
会話や読み上げ、短い指示などを入力として扱い、テキスト入力が難しい状況でも試せるようにしたい。

**この優先度の理由**: 音声はユースケースが広い一方、モデル対応状況の差が大きい。
まずは画像対応を優先し、その後に音声を段階的に拡張する。

**独立テスト**: Playground Chat で音声ファイル（WAV/MP3 等）を添付して送信し、会話ログに
音声が表示（再生できる）され、回答が返ることを確認する。

**受け入れシナリオ**:

1. **前提** Playground Chat を開きモデルを選択済み、**実行** 音声を添付して送信、
   **結果** 会話ログに音声とユーザー入力が表示され、音声内容を踏まえた回答が返る
2. **前提** Playground Chat を開きモデルを選択済み、**実行** クリップボードから音声を貼り付け（ペースト）して送信、
   **結果** 会話ログに音声とユーザー入力が表示され、音声内容を踏まえた回答が返る
3. **前提** 音声入力に非対応のモデルを選択中、**実行** 音声を添付/貼り付けしようとする、
   **結果** 添付/貼り付けが無効化される、または明確な理由付きで拒否される（送信できない）
4. **前提** 音声が形式不正または長さ/サイズ上限超過、**実行** 音声を添付/貼り付けして送信、
   **結果** 送信されず、利用者が次に取るべき行動が分かるエラーが表示される

---

### ユーザーストーリー3 - 生成AIが返した画像/音声を表示できる (優先度: P2)

利用者として、Playground Chat の回答に画像や音声が含まれる場合、それを会話ログ上で
分かりやすく表示（画像プレビュー、音声プレイヤー）したい。URLやデータURLなどが含まれる場合でも、
手動で別タブを開かずに結果を確認できるようにしたい。

**この優先度の理由**: マルチモーダル対応は入力だけでなく「結果の確認」まで含めて価値がある。
出力の表示ができないと、ユーザーはPlayground内で検証を完結できない。

**独立テスト**: 会話ログに画像URL/音声URL（またはデータURL）を含むアシスタントメッセージが存在する状態で、
Playgroundが画像/音声を埋め込み表示できることを確認する。

**受け入れシナリオ**:

1. **前提** アシスタントのメッセージ本文に画像URL（またはデータURL）が含まれる、**実行** 会話ログを表示、
   **結果** 画像が会話ログ内にプレビュー表示される（テキストも表示される）
2. **前提** アシスタントのメッセージ本文に音声URL（またはデータURL）が含まれる、**実行** 会話ログを表示、
   **結果** 音声プレイヤーが会話ログ内に表示され、再生できる
3. **前提** 画像/音声URLが不正または読み込みに失敗する、**実行** 会話ログを表示、
   **結果** 失敗が分かり、ユーザーが次に取れる行動（リンクを開く等）が提示される

---

### ユーザーストーリー4 - テキストのみでも快適に使える (優先度: P3)

利用者として、画像/音声を使わない場合でも、従来どおりテキストだけでスムーズにチャットしたい。
マルチモーダル機能追加によって、既存の体験が壊れたり遅くなったりしないことが重要。

**この優先度の理由**: Playground の利用の多くはテキストである可能性が高く、
後方互換性の確保が運用上のリスク低減につながる。

**独立テスト**: 画像/音声を添付せずに、送信・ストリーミング・停止がこれまで通り利用できることを確認する。

**受け入れシナリオ**:

1. **前提** Playground Chat を開きモデルを選択済み、**実行** テキストのみで送信、
   **結果** 期待通り回答が返り、UIが破綻しない
2. **前提** ストリーミングが有効、**実行** テキストを送信、**結果** 回答が逐次表示され、停止操作も有効

---

### エッジケース

- 画像と音声を同時に添付した場合、ユーザーが混乱しない形で扱えるか
- 添付後に削除/差し替えを行った場合、意図した内容で送信されるか
- 添付のサイズが大きい場合でも、UIが固まらずに失敗理由が分かるか
- 生成AIが返したURLが大量/複数ある場合に、表示が破綻しないか
- ネットワークやモデル側エラー時に、送信済みメッセージが不整合状態にならないか
- リクエスト履歴/監査ログに添付データの扱いが適切か（プライバシー・容量）

## 要件 *(必須)*

### 機能要件

- **FR-001**: 利用者は Playground Chat でテキストメッセージを送信できる必要がある
- **FR-002**: 利用者は 1 件のメッセージに画像（PNG/JPEG）を添付または貼り付けして送信できる必要がある
- **FR-003**: 利用者は 1 件のメッセージに音声（WAV/MP3 等）を添付または貼り付けして送信できる必要がある
- **FR-004**: 利用者は送信前に、添付した画像/音声をプレビューし、削除できる必要がある
- **FR-005**: システムは、**モデル一覧および選択中のモデル**について、画像/音声入力に対応しているかを利用者に分かる形で示す必要がある
- **FR-006**: システムは、添付ファイルの形式/サイズ/長さの制約を超える入力を拒否し、理由と対処が分かるエラーを表示する必要がある
- **FR-007**: システムは、生成AIの回答に含まれる画像/音声を会話ログ上で表示（プレビュー/再生）できる必要がある
- **FR-008**: システムは、添付付きメッセージ送信時もストリーミング/停止など既存の主要体験を損なわない必要がある
- **FR-009**: システムは、リクエスト履歴/監査用途の保存において、添付データの取り扱いを明確化し、必要以上の露出や肥大化を避ける必要がある
- **FR-010**: システムは、Playground がモデル一覧を表示するために利用するAPIに、画像/音声入力の対応状況（対応/非対応/不明）を含める必要がある
- **FR-011**: システムは、対応状況が取得できない場合でも、利用者に誤解を与えないため「不明」として扱い、添付操作は安全側に制御する必要がある

### 主要エンティティ *(機能がデータを含む場合に含める)*

- **チャットセッション**: 会話のまとまり（タイトル、モデル、メッセージ一覧、更新日時など）
- **メッセージ**: 送信者と内容（テキスト、添付、送信時刻など）
- **添付**: 画像または音声（種類、表示情報、制約情報など）
- **生成結果メディア**: 回答に含まれる画像/音声（表示/再生のための情報）

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- 動画の添付
- カメラ/マイクからのリアルタイム収録（録音）を直接行う機能
- 大量の添付（複数画像/複数音声）を 1 メッセージで扱う高度な編集機能

---

## 前提条件 *(該当する場合)*

- 利用者は Playground Chat にアクセスでき、利用可能なモデルを選択できる
- 画像/音声入力は、選択したモデルが該当モダリティに対応している場合に限り利用できる

---

## 依存関係 *(該当する場合)*

- 画像/音声の入力を処理できる推論系（モデル/ランタイム）が存在すること
- モデルの対応状況（画像/音声の可否）が利用者に提示できること
- モデル一覧取得APIが、各モデルの対応状況（対応/非対応/不明）を提供できること（または安全な推定ができること）

---

## Clarifications

### Session 2025-12-24

仕様を精査した結果、重大な曖昧さは検出されませんでした。

**確認済み事項**:

- 対応画像形式: PNG/JPEG（FR-002で明記）
- 対応音声形式: WAV/MP3等（FR-003で明記）
- モデル対応表示: 対応/非対応/不明の3状態（FR-005, FR-010, FR-011で明記）
- 添付プレビュー: 送信前に削除可能（FR-004で明記）
- 出力表示: 画像プレビュー、音声プレイヤー（FR-007で明記）
- 後方互換: テキストのみの既存体験維持（FR-008で明記）

**スコープ外の確認**:

- 動画添付
- リアルタイム録音
- 複数画像/音声の1メッセージ送信

---

## 成功基準 *(必須)*

1. 利用者は Playground Chat で、画像を添付して 1 回の会話ターンを完了できる
2. 利用者は Playground Chat で、音声を添付して 1 回の会話ターンを完了できる
3. 利用者は Playground Chat で、生成AIの回答に含まれる画像/音声を会話ログ上で確認できる
4. モデル非対応や入力不正時に、利用者は理由と次の行動が分かる
5. テキストのみの既存利用において、主要な操作（送信、ストリーミング、停止）が引き続き利用できる
