# 機能仕様書: IPアドレスロギング＆クライアント分析

**機能ID**: `SPEC-62ac4b68`
**作成日**: 2026-02-20
**ステータス**: 下書き
**入力**: ユーザー説明: "llmlbロードバランサーに対するAPIリクエストの送信元IPアドレスを記録し、
ダッシュボードの新規「Clients」タブで可視化・分析する機能"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - リクエスト送信元IPの自動記録 (優先度: P1)

管理者として、llmlbに届いたすべての推論リクエストについて、
どのIPアドレスから送信されたかを自動的に記録してほしい。
これにより、誰がシステムを利用しているかの基礎データを蓄積できる。

**この優先度の理由**: IPの記録はすべての分析・可視化の前提条件であり、
この機能なしには他の一切が動作しない。最優先で実装する必要がある。

**独立テスト**: APIリクエストを送信し、リクエスト履歴にIPアドレスが
記録されていることをデータベース直接確認またはAPIレスポンスで検証できる。

**受け入れシナリオ**:

1. **前提** llmlbサーバーが起動している、
   **実行** クライアントから`/v1/chat/completions`へリクエストを送信する、
   **結果** リクエスト履歴にクライアントのIPアドレス（IPv4またはIPv6）が記録される
1. **前提** llmlbサーバーが起動している、
   **実行** APIキーを使用して推論リクエストを送信する、
   **結果** リクエスト履歴にIPアドレスと使用されたAPIキーの識別子が
   紐付けて記録される
1. **前提** IPv6ネットワークからの接続が可能な環境、
   **実行** IPv6アドレスからリクエストを送信する、
   **結果** IPv6アドレスが正しく記録される

---

### ユーザーストーリー2 - リクエスト履歴でのIP表示とフィルター (優先度: P1)

管理者として、既存のリクエスト履歴一覧画面で
各リクエストの送信元IPアドレスを確認したい。
また、特定のIPアドレスでフィルターして、
そのIPからのリクエストだけを絞り込みたい。

**この優先度の理由**: 既存画面への統合は最小限の変更で即座に価値を提供する。
IP記録と同時に実装することで、記録されたデータをすぐに活用できる。

**独立テスト**: リクエスト履歴画面を開き、IPカラムが表示されることを確認し、
IPフィルターで絞り込みが正しく動作することを検証できる。

**受け入れシナリオ**:

1. **前提** IPが記録されたリクエスト履歴が存在する、
   **実行** ダッシュボードのリクエスト履歴一覧を表示する、
   **結果** 各リクエスト行にクライアントIPカラムが表示される
1. **前提** 複数のIPからのリクエスト履歴が存在する、
   **実行** 特定のIPアドレスでフィルターする、
   **結果** そのIPからのリクエストのみが一覧に表示される

---

### ユーザーストーリー3 - Clientsタブでのクライアント一覧と基本分析 (優先度: P2)

管理者として、ダッシュボードの専用「Clients」タブで
どのIPアドレスからどれくらいのリクエストが来ているかを
ランキング形式で確認したい。
バーチャートとテーブルで直感的に把握したい。

**この優先度の理由**: クライアント分析の中核機能であり、
トップ利用者の把握はシステム運用の基本ニーズ。

**独立テスト**: Clientsタブを開き、IPランキングテーブルと
バーチャートが正しく表示されることを確認できる。

**受け入れシナリオ**:

1. **前提** 複数IPからのリクエスト履歴が蓄積されている、
   **実行** Clientsタブを開く、
   **結果** IPアドレスがリクエスト数降順でランキングテーブルに表示される
1. **前提** Clientsタブが表示されている、
   **実行** バーチャートを確認する、
   **結果** 上位IPのリクエスト数がバーチャートで可視化されている
1. **前提** IPv6クライアントからのリクエストが存在する、
   **実行** Clientsタブのランキングを確認する、
   **結果** IPv6アドレスは/64プレフィックス単位で
   グルーピングされて集計される

---

### ユーザーストーリー4 - 使用パターンの時系列分析 (優先度: P2)

管理者として、ユニークIP数の推移を時系列チャートで確認し、
利用者数の増減傾向を把握したい。
また、どのモデルがどのIPから多く利用されているかを
パイチャートで把握したい。

**この優先度の理由**: 時系列データとモデル分布は運用判断に直結する。
リソース計画やモデル配置の最適化に活用できる。

**独立テスト**: Clientsタブの時系列チャートとパイチャートが
過去24時間のデータを正しく描画することを確認できる。

**受け入れシナリオ**:

1. **前提** 過去24時間にリクエストが発生している、
   **実行** Clientsタブの時系列チャートを確認する、
   **結果** ユニークIP数の推移がラインチャートで表示される
1. **前提** 複数モデルへのリクエストが存在する、
   **実行** Clientsタブのモデル分布チャートを確認する、
   **結果** クライアント全体のモデル利用割合がパイチャートで表示される

---

### ユーザーストーリー5 - 時間帯×曜日ヒートマップ (優先度: P2)

管理者として、リクエストの集中する時間帯と曜日の組み合わせを
ヒートマップで可視化し、ピーク時間帯のパターンを把握したい。

**この優先度の理由**: ピーク時間帯の把握はキャパシティプランニングに有用。
視覚的に一目でわかるヒートマップは運用者の判断を助ける。

**独立テスト**: ヒートマップが24時間×7曜日のマトリックスで
リクエスト密度を色の濃淡で表現していることを確認できる。

**受け入れシナリオ**:

1. **前提** 複数日にわたるリクエスト履歴が存在する、
   **実行** Clientsタブのヒートマップを確認する、
   **結果** 時間帯（0-23時）×曜日（月-日）のマトリックスで
   リクエスト数が色の濃淡で表現される

---

### ユーザーストーリー6 - IPドリルダウン詳細ビュー (優先度: P2)

管理者として、Clientsタブで特定のIPアドレスをクリックした際に、
そのIPに関する詳細情報（リクエスト履歴、使用モデル分布、
時間帯パターン）をドリルダウン表示で確認したい。

**この優先度の理由**: 個別IPの詳細分析は問題調査や
特定クライアントの利用状況把握に不可欠。

**独立テスト**: IPランキングテーブルの任意のIPをクリックし、
ドリルダウンビューが正しく展開されることを確認できる。

**受け入れシナリオ**:

1. **前提** Clientsタブのランキングテーブルが表示されている、
   **実行** 任意のIPアドレス行をクリックする、
   **結果** そのIPのリクエスト履歴一覧が展開表示される
1. **前提** ドリルダウンビューが展開されている、
   **実行** 使用モデル分布とアクティビティチャートを確認する、
   **結果** そのIPが利用したモデルの分布と
   時間帯ごとのリクエスト頻度がミニチャートで表示される

---

### ユーザーストーリー7 - APIキーとのクロス分析 (優先度: P2)

管理者として、IPアドレスとAPIキーの組み合わせで
クライアントを識別し、同一IPから異なるAPIキーが使われている場合や、
同一APIキーが異なるIPから使われている場合を確認したい。

**この優先度の理由**: APIキーとIPの紐付けにより、
不正利用の検出やクライアント識別の精度が向上する。

**独立テスト**: Clientsタブのランキングテーブルで
APIキー名カラムが表示され、IP×APIキーの組み合わせが確認できる。

**受け入れシナリオ**:

1. **前提** 同一IPから異なるAPIキーを使ったリクエストが存在する、
   **実行** Clientsタブで当該IPのドリルダウンを開く、
   **結果** 使用されたAPIキーの一覧と
   それぞれのリクエスト数が表示される
1. **前提** APIキーが削除済みの過去リクエストが存在する、
   **実行** リクエスト履歴を確認する、
   **結果** APIキーのIDは表示されるが、
   名前は「削除済み」と表示される

---

### ユーザーストーリー8 - 閾値ベースの異常検知 (優先度: P3)

管理者として、過去1時間に異常に多いリクエストを送信しているIPを
ダッシュボード上で自動的にハイライト表示してほしい。
閾値はダッシュボードのGUI設定から変更でき、
サーバーの再起動なしに反映されるようにしたい。

**この優先度の理由**: 異常検知はセキュリティ上重要だが、
IP記録と基本分析が先に機能している必要がある。
閾値ベースのシンプルな実装なので、基盤ができた後に追加しやすい。

**独立テスト**: 閾値を設定した後、閾値を超えるIPが
ハイライト表示されることを確認し、
閾値変更が即座に反映されることを検証できる。

**受け入れシナリオ**:

1. **前提** Clientsタブが表示されている、
   **実行** 異常検知の閾値（例: 過去1時間に100件以上）を
   GUI設定画面で設定する、
   **結果** 閾値がデータベースに保存され、
   サーバー再起動なしに即座に反映される
1. **前提** 閾値が100件に設定されている、
   **実行** あるIPから過去1時間に150件のリクエストが送信されている状態で
   Clientsタブを表示する、
   **結果** 当該IPがランキングテーブル上で
   視覚的にハイライト（警告色など）される
1. **前提** 閾値を超えるIPが存在しない、
   **実行** Clientsタブを表示する、
   **結果** 全IPが通常表示（ハイライトなし）で表示される

---

### エッジケース

- クライアントIPが取得できない場合（例: 内部テスト）、
  NULLとして記録し分析からは除外する
- データ0件時（サーバー起動直後等）、Clientsタブの各チャート・テーブルに
  空状態メッセージ（「リクエストデータがありません」等）を表示する
- 同一IPから大量のリクエスト（数万件/日）が来た場合、
  集計クエリのパフォーマンスに影響しないか
- IPv4-mapped IPv6アドレス（::ffff:192.168.1.1）は
  IPv4に正規化して保存・集計する（192.168.1.1として扱う）
- APIキーなし（認証スキップされたリクエスト）の場合、
  api_key_idはNULLとして記録する
- リクエスト履歴のリテンションポリシーでレコードが削除された場合、
  Clientsタブの表示範囲（過去24時間）のデータが途中で欠落しないか
- IPv6の/64グルーピングにおいて、
  リンクローカルアドレス（fe80::）やループバック（::1）の扱い

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、すべての推論APIリクエスト
  （chat completions, embeddings, audio, images）の
  送信元IPアドレスを自動的に記録する必要がある
- **FR-002**: システムは、直接TCP接続のソケット接続元アドレスから
  IPアドレスを取得する必要がある（リバースプロキシは非対応）
- **FR-003**: システムは、IPv4およびIPv6の両方のアドレスを
  正しく記録・保存できる必要がある。
  IPv4-mapped IPv6アドレス（::ffff:x.x.x.x）はIPv4に正規化して保存する
- **FR-004**: システムは、各リクエストで使用された
  APIキーの識別子（UUID）をリクエスト履歴に記録する必要がある
- **FR-005**: システムは、IPアドレスを匿名化せず
  生の値のままデータベースに保存する必要がある
- **FR-006**: 既存のリクエスト履歴一覧画面に、
  クライアントIPカラムとIPアドレスによるフィルター機能を
  追加する必要がある
- **FR-007**: ダッシュボードに新規「Clients」タブを追加し、
  IP別のリクエスト数ランキングテーブルを表示する必要がある。
  デフォルトは上位20件表示とし、ページネーションで全件閲覧可能とする
- **FR-008**: Clientsタブに、IP別リクエスト数の
  バーチャートを表示する必要がある
- **FR-009**: Clientsタブに、ユニークIP数の時系列推移を
  ラインチャートで表示する必要がある
- **FR-010**: Clientsタブに、モデル利用分布の
  パイチャートを表示する必要がある
- **FR-011**: Clientsタブに、時間帯（0-23時）×曜日（月-日）の
  リクエスト密度ヒートマップを表示する必要がある
- **FR-012**: Clientsタブの表示期間は過去24時間固定とする
- **FR-013**: Clientsタブで特定のIPをクリックした際に、
  そのIPのリクエスト履歴一覧・使用モデル分布・
  時間帯パターンをドリルダウン表示する必要がある
- **FR-014**: IPv6アドレスはClientsタブの集計において、
  /64プレフィックス単位でグルーピングする必要がある
- **FR-015**: IPとAPIキーの組み合わせによる
  クロス分析が可能である必要がある
- **FR-016**: 閾値ベースの異常検知機能を提供し、
  過去1時間にN件以上のリクエストを送信したIPを
  ランキングテーブル上でハイライト表示する必要がある。
  デフォルト閾値は100件/時間とする
- **FR-017**: 異常検知の閾値は、ダッシュボードのGUI設定画面から
  変更可能で、サーバー再起動なしに即座に反映される必要がある
- **FR-018**: 異常検知の閾値はデータベースに永続化し、
  サーバー再起動後も維持される必要がある
- **FR-019**: 既存のリクエスト履歴リテンションポリシーに従い、
  IP情報を含むレコードも自動削除の対象とする

### 主要エンティティ

- **リクエスト履歴レコード（拡張）**: 既存のリクエスト履歴に
  クライアントIPアドレスとAPIキー識別子を追加したもの。
  各推論リクエストの送信元と認証情報を紐付けて記録する。
- **クライアント（IP）**: システムにリクエストを送信する
  個々のIPアドレス（IPv4）またはIPグループ（IPv6の/64プレフィックス）。
  ランキング・分析・異常検知の単位となる。
- **異常検知設定**: 管理者が設定する閾値情報。
  ダッシュボードから変更可能で、データベースに永続化される。

## Clarifications

### Session 2026-02-20

- Q: IPv4-mapped IPv6アドレス（::ffff:192.168.1.1）の正規化方針は？
  → A: IPv4に正規化する（::ffff:192.168.1.1 → 192.168.1.1として保存・集計）
- Q: Clientsタブのランキングテーブル表示件数は？
  → A: 上位20件をデフォルト表示＋ページネーションで全件閲覧可能
- Q: Clientsタブのアクセス制御は？
  → A: 既存のJWT認証と同等（ダッシュボードにログインできれば閲覧可）
- Q: 異常検知閾値のデフォルト値は？
  → A: 100件/時間
- Q: データ0件時のClientsタブ表示は？
  → A: 空状態メッセージ（「リクエストデータがありません」等のプレースホルダー）

## 成功基準 *(必須)*

### 測定可能な結果

- **SC-001**: すべての推論APIリクエストの100%について、
  送信元IPアドレスが正しく記録される（NULLでない）
- **SC-002**: リクエスト履歴一覧のIPフィルターで、
  指定したIPからのリクエストのみが正確に絞り込まれる
- **SC-003**: Clientsタブのランキングテーブルが
  過去24時間のデータを3秒以内に表示できる
- **SC-004**: IPv6アドレスが/64プレフィックス単位で
  正しくグルーピングされ、同一/64内のアドレスが統合して集計される
- **SC-005**: 閾値設定の変更が、ページリロードなしで
  次回のデータ取得時に反映される
- **SC-006**: 1000件以上のユニークIPが存在する環境でも、
  Clientsタブの各チャートが5秒以内に描画される
- **SC-007**: APIキーの識別子がリクエスト履歴に
  正しく紐付けて記録され、キー名をJOINで取得できる
