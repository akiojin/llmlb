# 機能仕様書: 統一APIプロキシ

**機能ID**: `SPEC-63acef08`
**作成日**: 2025-10-30
**ステータス**: 実装済み
**元のSPEC**: SPEC-32e2b31a から分割
**依存SPEC**: SPEC-94621a1f（エージェント自己登録）

## 概要

複数のOllamaインスタンスを統一して扱うプロキシ機能。ユーザーはコーディネーターの単一エンドポイントを通じてOllama APIにアクセスでき、コーディネーターが自動的に利用可能なエージェントにリクエストを振り分ける。

## ユーザーシナリオ＆テスト

### ユーザーストーリー - 統一APIエンドポイントによるOllamaアクセス

ユーザーは複数のOllamaインスタンスを意識せず、コーディネーターの単一エンドポイントを通じてOllama APIにアクセスできる。コーディネーターは自動的に利用可能なエージェントにリクエストを振り分ける。

**この優先度の理由**: 複数のOllamaインスタンスを統一して扱えることがこのシステムの中核的な価値。エージェント登録が完了していれば独立して実装・テスト可能。

**独立テスト**: コーディネーターのエンドポイント（例: `http://coordinator:8080/api/chat`）に対してOllama API形式のリクエストを送信し、正常にレスポンスが返ることで価値を提供する。

**受け入れシナリオ**:

1. **前提** 2台のエージェントが登録されている、**実行** コーディネーターのAPI（`POST /api/chat`）にチャットリクエストを送信する、**結果** いずれかのエージェントが処理し、LLMからのレスポンスが返される
2. **前提** 登録されたエージェントがない、**実行** コーディネーターのAPIにリクエストを送信する、**結果** 「利用可能なエージェントがありません」というエラーメッセージが返される
3. **前提** 1台のエージェントが登録されている、**実行** 同時に5つのリクエストを送信する、**結果** すべてのリクエストが同じエージェントで処理され、順次レスポンスが返される
4. **前提** 3台のエージェントが登録されている、**実行** 連続して9つのリクエストを送信する、**結果** リクエストが3台のエージェントに均等に分散され（各エージェントが3リクエストずつ処理）、すべてレスポンスが返される

## 機能要件

### FR-005: Ollama APIプロキシ

コーディネーターはOllama API互換のエンドポイントを提供し、リクエストを適切なエージェントに転送する。

- エンドポイント:
  - `POST /api/chat` - チャット完了リクエスト
  - `POST /api/generate` - テキスト生成リクエスト
- リクエスト形式: Ollama API互換
- レスポンス形式: Ollama API互換

### FR-006: エージェント選択ロジック

利用可能なエージェントから、リクエストを処理するエージェントを選択する。

- 初期実装: ラウンドロビン方式
- オンライン状態のエージェントのみを選択対象とする
- エージェントが存在しない場合はエラーを返す

### FR-007: リクエスト転送

選択されたエージェントにリクエストを転送し、レスポンスをクライアントに返す。

- HTTPプロキシとして動作
- ストリーミングレスポンスをサポート
- タイムアウト: 60秒

### FR-008: エラーハンドリング

エージェントへのリクエスト転送が失敗した場合の処理。

- エージェントが応答しない場合、エラーレスポンスを返す
- 将来的には他のエージェントへのフェイルオーバーを実装予定

## 非機能要件

### NFR-004: パフォーマンス

- プロキシのオーバーヘッドは50ms以内
- 同時に最大100個のリクエストを処理可能

### NFR-005: 互換性

- Ollama API v0.1.0以降と互換性を持つ
- 既存のOllamaクライアントから透過的に利用可能

## 実装状態

✅ **実装済み** (PR #1でマージ済み)

- `/api/chat` プロキシエンドポイント
- `/api/generate` プロキシエンドポイント
- ラウンドロビン方式のエージェント選択
- HTTPリクエスト転送
- 統合テスト
