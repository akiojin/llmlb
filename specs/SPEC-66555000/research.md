# リサーチノート: ロードバランサー主導エンドポイント登録システム

**機能ID**: `SPEC-66555000`
**日付**: 2026-01-14

## 1. エンドポイントAPI仕様（統一）

### 1.1 OpenAI互換API

**決定**: すべてのエンドポイントは GET /v1/models でモデル一覧取得

**理由**:

- xLLM（自社推論サーバー）、Ollama、vLLM等すべてOpenAI互換APIを提供
- /v1/models が業界標準エンドポイント
- エンドポイントタイプ分けが不要になり、統一的な扱いが可能

**検討した代替案**:

- タイプ別API（Ollama: /api/tags等）→ 統一性の観点から却下
- 独自API → 標準化の観点から却下

**ヘルスチェック・モデル同期方法（統一）**:

```text
GET {base_url}/v1/models
Header: Authorization: Bearer {api_key} (if required)
期待レスポンス: 200 OK with OpenAI format model list
タイムアウト: 5秒
```

**対応エンドポイント**:

- **xLLM**: 自社推論サーバー（llama.cpp/whisper.cpp/stable-diffusion.cpp/safetensors.cpp対応）
- **Ollama**: OllamaのOpenAI互換モード
- **vLLM**: vLLMサーバー
- **その他**: OpenAI互換APIを提供する任意のサービス

## 2. ヘルスチェック設計

### 2.1 プル型 vs プッシュ型

**決定**: プル型（ロードバランサーからエンドポイントへ定期ポーリング）

**理由**:

- 外部エンドポイント（Ollama等）はロードバランサーへのプッシュ機能を持たない
- 統一的なヘルスチェック方式で管理が容易
- エンドポイント側の実装変更不要

**検討した代替案**:

- プッシュ型（既存方式）→ 外部エンドポイント非対応のため却下
- ハイブリッド → 複雑さが増すため却下

### 2.2 ヘルスチェック間隔

**決定**: デフォルト30秒、設定可能

**理由**:

- 障害検知の即時性と負荷のバランス
- 既存のハートビート間隔（30秒）との整合性

### 2.3 オフライン判定

**決定**: 連続2回のチェック失敗でオフライン遷移（pending状態は初回失敗でoffline遷移を許可）

**理由**:

- 一時的なネットワーク遅延による誤検知を防止
- 60秒以内の障害検知を維持
- 初回登録時は厳格に判定（pending→offline は即時遷移可）

### 2.4 自動復旧

**決定**: 次回ヘルスチェック成功時に自動でonline遷移

**理由**:

- 手動介入なしでの復旧を実現
- error状態からの復旧も同様に自動化

### 2.5 ロードバランサー起動時の挙動

**決定**: 全エンドポイントの即時チェックを並列実行

**理由**:

- 起動直後から正確な状態把握が可能
- 順次チェックは遅延が発生するため却下

### 2.6 ヘルスチェック履歴

**決定**: 全履歴を別テーブル（endpoint_health_checks）に保存、30日間保持

**理由**:

- 障害分析やトレンド把握に必要
- 最新N件ではパターン分析が困難
- 30日間でストレージ効率とのバランスを確保

## 3. 既存コードベースとの統合

### 3.1 NodeRegistry との関係

**決定**: EndpointRegistry を新規作成、NodeRegistry は廃止

**理由**:

- 概念が異なる（Node vs Endpoint）
- 既存のNodeRegistryはプッシュ型前提の設計
- クリーンな移行のため新規作成が適切

**移行計画**:

1. EndpointRegistry を新規実装
2. ルーティングロジックをEndpointRegistry対応に変更
3. NodeRegistry/NodeStorage を削除
4. 旧APIエンドポイント（/v0/nodes, /v0/health）を削除

### 3.2 データベーススキーマ

**決定**: 新規テーブル `endpoints`, `endpoint_models` を追加

**理由**:

- 既存の `nodes` テーブルとは構造が異なる
- 移行期間中は両方のテーブルが共存可能

### 3.3 API互換性

**決定**: 破壊的変更（旧API廃止）

**理由**:

- ノード自己登録方式は完全に廃止
- 後方互換性維持は複雑さを増すため却下

**影響を受けるAPI**:

- `POST /v0/nodes` → 削除
- `POST /v0/health` → 削除
- `X-Node-Token` 認証 → 削除

## 4. モデル同期設計

### 4.1 同期タイミング

**決定**: 登録時に自動同期 + 手動トリガー + ヘルスチェック時（オプション）

**理由**:

- 登録時の即時同期でユーザー体験向上（追加操作不要）
- 手動トリガーで管理者の制御を維持
- ヘルスチェック時の自動同期は設定で有効化

### 4.2 同期失敗時の挙動

**決定**: 既存モデル情報を維持、エラーログ記録

**理由**:

- 一時的な同期失敗で情報が失われるのを防止
- 管理者がエラー状況を確認可能

### 4.3 モデル削除同期

**決定**: エンドポイント側で削除されたモデルは自動でDBからも削除

**理由**:

- 古い情報を残すとルーティング失敗の原因になる
- 次回同期時に差分を計算して反映

### 4.4 Capabilities自動判定

**決定**: モデル名プレフィックスから自動判定（embed*→embeddings、それ以外→chat）

**理由**:

- 管理者の設定負担を軽減
- 多くのモデルは命名規則に従っている
- 誤判定時は手動オーバーライド可能

### 4.5 レスポンス形式パース

**決定**: OpenAI形式とOllama形式の両方をサポート

**理由**:

- OpenAI: `{ "data": [{ "id": "model-name" }] }`
- Ollama: `{ "models": [{ "name": "model-name" }] }`
- 両形式を試行してパースし、柔軟に対応

## 5. 認証設計

### 5.1 エンドポイントAPI認証

**決定**: 既存のJWT認証（ダッシュボード）/ APIキー認証（API）を使用

**理由**:

- 既存の認証基盤を活用
- 新規認証方式の追加は不要

### 5.2 エンドポイントへの認証情報

**決定**: APIキーを暗号化してDBに保存

**理由**:

- 一部エンドポイント（外部API）はAPIキー認証が必要
- 平文保存はセキュリティリスク

**暗号化方式**:

- AES-256-GCM（既存のJWTシークレットをベースに鍵導出）

## 6. ルーティング設計

### 6.1 複数エンドポイントでの同一モデル

**決定**: レイテンシベースのルーティング

**理由**:

- 最もレスポンスが速いエンドポイントを選択
- レイテンシはヘルスチェック時に計測・更新（30秒間隔）
- ラウンドロビンは均等分散だが効率が劣る

**実装方式**:

- endpoints テーブルに `latency_ms` フィールドを追加
- ヘルスチェック時にレイテンシを計測・更新
- 同一モデルを持つエンドポイントのうち、最小レイテンシを選択

### 6.2 モデルプレフィックス

**決定**: 非対応（現時点では不要）

**理由**:

- `ollama:llama3`, `vllm:llama3` のようなプレフィックスは複雑さを増す
- 現在は同一モデル名でレイテンシベースルーティングで十分
- 将来的に必要になれば追加検討

## 7. タイムアウト設計

### 7.1 タイムアウト値

**決定**: ヘルスチェック5秒、推論は別途設定

**理由**:

- ヘルスチェック: GET /v1/models は軽量操作、5秒で十分
- 推論: モデルサイズやプロンプト長で大きく異なるため別設定
- 両方同じ値は適切でない

### 7.2 推論タイムアウト

**決定**: エンドポイント単位で設定可能（デフォルト: 120秒）

**理由**:

- 長文生成は時間がかかる場合がある
- エンドポイントごとに異なる特性に対応
- ストリーミングの場合は最初のトークンまでのタイムアウト

## 8. 制約設計

### 8.1 URL一意性

**決定**: base_url は UNIQUE 制約、変更禁止（削除→再登録）

**理由**:

- 同一URLの重複登録は管理上の混乱を招く
- URL変更はモデル情報の整合性に影響するため禁止
- 変更が必要な場合は明示的な削除→再登録フロー

### 8.2 名前一意性

**決定**: name も UNIQUE 制約

**理由**:

- 同名エンドポイントは管理・ルーティング時の混乱を招く
- 識別しやすい命名を強制

### 8.3 viewerロール権限

**決定**: エンドポイント管理APIはGET（参照）のみ許可

**理由**:

- 閲覧者に登録・更新・削除権限を与えない
- SPEC-7c0a37e0のスコープシステムと整合

---

*すべての要明確化が解決済み*
