# 機能仕様書: ルーター主導エンドポイント登録システム

**機能ID**: `SPEC-66555000`
**作成日**: 2026-01-14
**ステータス**: 下書き
**入力**: ユーザー説明: "ルーター主導エンドポイント登録システム - ルーターがダッシュボードおよびREST API経由でOpenAI互換APIエンドポイント（aLLM、Ollama、vLLM等）を登録・管理する。既存のノード自己登録システム（SPEC-94621a1f）を廃止し、統一されたエンドポイント管理に移行する。プル型ヘルスチェック（GET /v1/models）でエンドポイントの稼働状況を監視し、モデル一覧の自動同期機能を提供する。"

## ユーザーシナリオ＆テスト

### ユーザーストーリー1 - エンドポイントの登録 (優先度: P1)

管理者として、ダッシュボードまたはAPIからOpenAI互換APIエンドポイントを登録したい。
これにより、aLLM（自社推論サーバー）、Ollama、vLLM等を統一的に管理できるようになる。
すべてのエンドポイントはOpenAI互換APIとして扱われる。

**この優先度の理由**: エンドポイント登録はシステムの中核機能であり、
他のすべての機能（ヘルスチェック、モデル同期、ルーティング）の前提条件となる。

**独立テスト**: ダッシュボードからエンドポイントを登録し、
エンドポイント一覧に表示されることを確認することで、独立して価値を提供する。

**受け入れシナリオ**:

1. **前提** 管理者がダッシュボードにログイン済み、**実行** 新規エンドポイント登録フォームにaLLMサーバーのURLを入力して保存、**結果** エンドポイントが一覧に追加される
2. **前提** 管理者がダッシュボードにログイン済み、**実行** Ollamaサーバーのエンドポイントを登録、**結果** エンドポイントが一覧に追加される
3. **前提** APIキーを持つ管理者、**実行** REST APIでエンドポイントを登録、**結果** 201 Createdが返り、エンドポイントが作成される
4. **前提** 同じURLのエンドポイントが既に存在、**実行** 同じURLで新規登録を試行、**結果** 重複エラーが返され、登録は拒否される

---

### ユーザーストーリー2 - エンドポイントの稼働状況監視 (優先度: P1)

管理者として、登録したエンドポイントの稼働状況をリアルタイムで確認したい。
ルーターが定期的にエンドポイントをチェックし、オンライン/オフライン状態を
自動的に更新することで、障害を迅速に検知できる。

**この優先度の理由**: 稼働状況の監視がなければ、障害ノードにリクエストが
振り分けられ、ユーザー体験が損なわれる。安定運用の基盤となる機能。

**独立テスト**: エンドポイントを登録し、稼働状況がダッシュボードに
表示されること、エンドポイント停止時にオフライン状態に遷移することを確認する。

**受け入れシナリオ**:

1. **前提** エンドポイントが登録されている、**実行** ダッシュボードでエンドポイント一覧を表示、**結果** 各エンドポイントの稼働状況（オンライン/オフライン）が表示される
2. **前提** オンラインのエンドポイントがある、**実行** そのエンドポイントのサービスを停止、**結果** 60秒以内にルーターが検知し、状態がオフラインに変わる
3. **前提** オフラインのエンドポイントがある、**実行** そのエンドポイントのサービスを再起動、**結果** 次回のヘルスチェックで検知され、状態がオンラインに復帰する

---

### ユーザーストーリー3 - モデル一覧の自動同期 (優先度: P2)

管理者として、エンドポイントで利用可能なモデルを自動的に取得したい。
手動でモデルを登録する手間を省き、エンドポイント側のモデル追加・削除が
ルーターに自動反映されるようにしたい。

**この優先度の理由**: モデル同期により運用負荷が大幅に軽減される。
ただし、手動でのモデル指定でも最低限の運用は可能なため、P2とする。

**独立テスト**: エンドポイントを登録後、モデル同期を実行し、
そのエンドポイントで利用可能なモデルがルーターに表示されることを確認する。

**受け入れシナリオ**:

1. **前提** Ollamaエンドポイントが登録されている、**実行** モデル同期を実行、**結果** Ollamaにロードされているモデルがルーターのモデル一覧に表示される
2. **前提** aLLMエンドポイントが登録されている、**実行** モデル同期を実行、**結果** aLLMで利用可能なモデルがルーターのモデル一覧に表示される
3. **前提** エンドポイントにモデルが追加された、**実行** 次回のモデル同期、**結果** 新しいモデルがルーターに反映される

---

### ユーザーストーリー4 - エンドポイントの接続テスト (優先度: P2)

管理者として、エンドポイント登録前に接続テストを実行したい。
URLやAPIキーの設定ミスを事前に検出し、登録後のトラブルを防止したい。

**この優先度の理由**: 接続テストにより設定ミスを早期発見できる。
ただし、テストなしでも登録自体は可能なため、P2とする。

**独立テスト**: 接続テストボタンを押し、成功/失敗の結果が
表示されることを確認する。

**受け入れシナリオ**:

1. **前提** 正しいURLを入力済み、**実行** 接続テストを実行、**結果** 成功メッセージとエンドポイント情報が表示される
2. **前提** 不正なURLを入力済み、**実行** 接続テストを実行、**結果** 失敗メッセージと具体的なエラー理由が表示される
3. **前提** APIキーが必要なエンドポイントで誤ったキーを入力、**実行** 接続テストを実行、**結果** 認証エラーが表示される

---

### ユーザーストーリー5 - エンドポイントの管理操作 (優先度: P3)

管理者として、登録済みエンドポイントの編集・削除を行いたい。
URLの変更、メモの追加、不要になったエンドポイントの削除ができるようにしたい。

**この優先度の理由**: 日常的な管理操作として必要だが、
初期登録とヘルスチェックが動作すれば基本的な運用は可能なため、P3とする。

**独立テスト**: エンドポイントの編集・削除操作を行い、
変更が反映されることを確認する。

**受け入れシナリオ**:

1. **前提** エンドポイントが登録されている、**実行** エンドポイントの名前を編集して保存、**結果** 新しい名前で表示される
2. **前提** エンドポイントが登録されている、**実行** エンドポイントを削除、**結果** エンドポイントが一覧から削除される
3. **前提** エンドポイントにメモを追加、**実行** エンドポイント詳細を表示、**結果** メモが表示される

---

### エッジケース

- 登録時にエンドポイントが一時的に応答しない場合、どのように扱うか？→ 登録は受け付け、状態を「保留中」として次回チェックを待つ
- ヘルスチェック中にエンドポイントがタイムアウトした場合、何が起こるか？→ エラー回数をカウントし、閾値超過でオフライン遷移
- モデル同期中にエンドポイントが応答しない場合、どうなるか？→ 同期失敗としてログに記録、既存のモデル情報は維持
- 初回ヘルスチェック失敗時、pending→offlineへの遷移は許可する（厳密なステータス管理）
- エンドポイント削除時、そのエンドポイントのみが提供していたモデルへのリクエストは404 Not Foundを返す
- GET /v1/modelsのレスポンス形式がOpenAI標準と異なる場合、複数形式（OpenAI/Ollama）をパースする

## Clarifications

### Session 2026-01-14

**ルーティング戦略**:

- Q: 複数エンドポイントが同一モデルを提供している場合のルーティング戦略は？
- A: レイテンシベース（過去の応答時間が短いエンドポイントを優先）
- レイテンシはヘルスチェック時（30秒間隔）に更新

**APIキー暗号化**:

- Q: エンドポイントのAPIキー暗号化の鍵管理は？
- A: 既存JWTシークレットをベースに鍵を導出（AES-256-GCM）

**capabilities判定**:

- Q: モデルのcapabilities（chat/embeddings）はどう判定する？
- A: モデル名プレフィックスで自動判定（embed*→embeddings、それ以外→chat）

**モデル同期**:

- Q: エンドポイント登録時にモデル同期を自動実行する？
- A: 登録時に自動同期（UX向上）
- Q: エンドポイントから削除されたモデルの扱いは？
- A: 自動削除（ルーターからも削除）

**オフライン時のモデル表示**:

- Q: エンドポイントがofflineになった際、モデル一覧での扱いは？
- A: 表示するがofflineマーク付き

**接続テストとヘルスチェック**:

- Q: 接続テストはステータスを更新する？
- A: 接続テストもステータスを更新（即時ヘルスチェックと同等）
- Q: 「即時チェック」ボタンは必要？
- A: 必要（ダッシュボードから任意のタイミングで手動チェック可能）

**タイムアウト設計**:

- Q: ヘルスチェックと推論リクエストのタイムアウトは別？
- A: 別設定（HC: 5秒固定、推論: リクエスト単位で設定可能）

**ダッシュボード表示**:

- Q: エンドポイント一覧の表示項目は？
- A: 基本情報（名前、URL、ステータス、モデル数）＋メトリクス（レイテンシ、エラー率、最終確認時刻）

**ステータス遷移**:

- Q: errorステータスからの復帰は？
- A: 次回ヘルスチェック成功で自動復帰（error→online）

**エラー履歴**:

- Q: ヘルスチェック履歴は保存する？
- A: 全履歴を別テーブルに保存、保存期間は30日間

**URL変更**:

- Q: エンドポイントURLの変更は許可する？
- A: 禁止（削除→再登録が必要）

**ルーター再起動時**:

- Q: ヘルスチェッカーの再起動時動作は？
- A: 全エンドポイント即時チェック（並列実行）

**名前の一意性**:

- Q: エンドポイント名のUNIQUE制約は？
- A: 名前もUNIQUE必須（URLと名前の両方が一意）

**viewerロール**:

- Q: viewerロールのエンドポイント管理APIアクセス権限は？
- A: GETのみ許可（一覧・詳細の参照のみ）

**モデル指定**:

- Q: モデル指定時のエンドポイントプレフィックスは？
- A: プレフィックスなし（モデル名のみで指定、ルーターが自動選択）

## 要件

### 機能要件

- **FR-001**: 管理者はダッシュボードからエンドポイントを登録できる必要がある
- **FR-002**: 管理者はREST APIからエンドポイントを登録できる必要がある
- **FR-003**: システムは登録済みエンドポイントの一覧を表示できる必要がある
- **FR-004**: システムはエンドポイントの稼働状況を定期的にチェックする必要がある（GET /v1/models）
- **FR-005**: システムはエンドポイントの状態（保留中、オンライン、オフライン、エラー）を管理する必要がある
- **FR-006**: システムはエンドポイントからモデル一覧を取得・同期できる必要がある（GET /v1/models）
- **FR-007**: 管理者は登録前にエンドポイントへの接続テストを実行できる必要がある
- **FR-008**: 管理者はエンドポイントを編集・削除できる必要がある
- **FR-009**: システムはエンドポイントのURLの重複を検出し、拒否する必要がある
- **FR-010**: システムはAPIキーが必要なエンドポイントの認証情報を安全に保存する必要がある
- **FR-011**: システムはエンドポイント名の重複を検出し、拒否する必要がある
- **FR-012**: システムはエンドポイント登録時に自動でモデル同期を実行する必要がある
- **FR-013**: システムはレイテンシベースのルーティングで複数エンドポイント間の負荷分散を行う必要がある
- **FR-014**: システムはヘルスチェック履歴を30日間保存する必要がある
- **FR-015**: viewerロールはエンドポイント管理APIの参照（GET）のみ可能である必要がある
- **FR-016**: 管理者はダッシュボードから即時ヘルスチェックを実行できる必要がある
- **FR-017**: システムはルーター起動時に全エンドポイントの即時チェックを並列実行する必要がある
- **FR-018**: システムはモデルのcapabilitiesをモデル名プレフィックスから自動判定する必要がある

### 廃止される機能

以下の機能は本仕様により廃止される：

- **SPEC-94621a1f**: ノード自己登録システム（ノード側からルーターへの登録）
- **POST /v0/nodes**: ノード登録エンドポイント
- **POST /v0/health**: ノードからのハートビート受信エンドポイント
- **X-Node-Token**: ノードトークン認証

### 主要エンティティ

- **エンドポイント**: OpenAI互換APIの接続先。名前、URL、認証情報、状態を持つ
- **エンドポイント状態**: 保留中（未確認）、オンライン（稼働中）、オフライン（停止）、エラー（異常）
- **エンドポイントモデル**: エンドポイントで利用可能なモデルの情報（GET /v1/modelsで取得）

---

## スコープ外

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- エンドポイントの自動発見（ネットワークスキャン等）
- エンドポイントグループ化・タグ付け機能
- エンドポイント間の負荷分散ポリシーのカスタマイズ
- 複数ルーター間でのエンドポイント情報共有

---

## 技術制約

- 既存のクラウドプロバイダー連携（openai:、google:、anthropic:プレフィックス）は維持する
- ヘルスチェックはルーター側からのプル型で実装する（ノードからのプッシュ型は廃止）

---

## 前提条件

この機能は以下を前提とします:

- ルーターのダッシュボード（SPEC-712c20cf）が利用可能であること
- 管理者認証（JWT認証）が実装済みであること
- REST API認証（APIキー認証）が実装済みであること

---

## 依存関係

この機能は以下に依存します:

- SPEC-712c20cf: 管理ダッシュボード（UIの提供基盤）
- SPEC-63acef08: 統一APIプロキシ（エンドポイントへのリクエスト転送）
- SPEC-7c0a37e0: APIキースコープシステム（エンドポイント管理権限）

以下のSPECを廃止・置換します:

- SPEC-94621a1f: ノード自己登録システム（本仕様により完全に置換）
- SPEC-443acc8c: ヘルスチェックシステム（プル型に移行）

以下のSPECを更新します:

- SPEC-7c0a37e0: `endpoints`スコープ追加、`node`スコープ廃止

---

## 成功基準

以下の成功基準を満たす必要があります:

1. 管理者は1分以内にダッシュボードからエンドポイントを登録できる
2. 管理者は30秒以内にAPIからエンドポイントを登録できる
3. システムは60秒以内にエンドポイントの障害を検知し、オフライン状態に遷移する
4. システムはエンドポイント復旧後、次回ヘルスチェックでオンライン状態に復帰する
5. モデル同期実行後、エンドポイントの全モデルがルーターに反映される
6. 既存のクラウドプロバイダー連携（openai:等）は引き続き正常に動作する
