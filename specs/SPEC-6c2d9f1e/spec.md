# 機能仕様書: モデル登録キャッシュとマルチモーダルI/Oの完全動作

**機能ID**: `SPEC-6c2d9f1e`  
**作成日**: 2025-12-20  
**ステータス**: 実装中（TDD）  
**入力**: ユーザー説明: "モデルの登録（キャッシュ）、モデルを指定して正常にチャット、画像・音声の入出力、モデルの削除が全て正常動作する必要がある。要件は漏れなく記載し、TDD対応を完璧にする。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - モデル登録（キャッシュ優先） (P1)
運用管理者として、既にローカルキャッシュにあるモデルは再ダウンロードせず即時登録できることを期待する。破損/0Bのキャッシュは無効として再取得されることが必要。

**独立テスト**:
- 既存キャッシュ（正常サイズ）→ 登録は即時完了・再ダウンロード無し
- 0Bキャッシュ → 再ダウンロードされ、/v1/models に ready として表示される

### ユーザーストーリー2 - モデル指定チャット (P1)
利用者として、/v1/chat/completions で指定したモデルが実際に選択され、正常にチャットが返ることを期待する。

**独立テスト**:
- 指定モデル名で Chat API を実行し、ノード側で当該モデルがロードされる
- 未登録モデルは 404 / 503 を返す

### ユーザーストーリー3 - 画像入出力 (P1)
利用者として、OpenAI互換の画像生成/編集/バリエーションAPIが機能し、適切なノードにルーティングされることを期待する。

**独立テスト**:
- /v1/images/generations が StableDiffusion 対応ノードにルーティングされ成功する
- /v1/images/edits, /v1/images/variations が動作し、入力不足は 400 を返す

### ユーザーストーリー4 - 音声入出力 (P1)
利用者として、OpenAI互換の音声認識/音声合成APIが機能し、適切なノードにルーティングされることを期待する。

**独立テスト**:
- /v1/audio/transcriptions が Whisper 対応ノードへルーティングされ成功
- /v1/audio/speech が ONNX Runtime 対応ノードへルーティングされ成功

### ユーザーストーリー5 - モデル削除 (P1)
運用管理者として、モデルを削除すると /v1/models から即時消え、ルーター/ノードのローカルキャッシュも削除されることを期待する。

**独立テスト**:
- DELETE /v1/models/:name でモデルを削除後に /v1/models から消える
- ノード側のモデルも同期で削除される

## 要件 *(必須)*

### 機能要件
- **FR-001**: 登録時にキャッシュが存在し、サイズが 0 ではない場合は再ダウンロードを行わず即時登録する。
- **FR-002**: 0Bまたは不完全なキャッシュは無効として扱い、再ダウンロードを行う。
- **FR-003**: /v1/models の `ready=true` は「実体（safetensors/GGUF）が存在し、サイズ > 0」である場合のみ返す。
- **FR-004**: /v1/chat/completions は指定モデルを必ず使用し、ノード側で当該モデルがロードされること。
- **FR-005**: /v1/images/* は画像生成対応ノードにのみルーティングする。
- **FR-006**: /v1/audio/transcriptions はASR対応ノード、/v1/audio/speech はTTS対応ノードにのみルーティングする。
- **FR-007**: ノードは supported_runtimes と音声/画像のロード状況を登録・ハートビートで送信する。
- **FR-008**: DELETE /v1/models/:name でルーター登録情報・ファイル・ノードキャッシュが削除される。

### 非機能要件
- **NFR-001**: 登録・削除・ルーティングはいずれも OpenAI互換 API のエラー形式を維持する。
- **NFR-002**: 既存の契約/統合テストを破壊しない。

## スコープ外
- 実際のモデル品質（生成品質・音声品質）評価
- クラウドAPIプロバイダ側の品質保証

## 依存関係
- SPEC-11106000（HF登録/キャッシュ）
- SPEC-26006000（音声対応）
- SPEC-32637000（capabilities）

## Clarifications

### Session 2025-12-24

仕様を精査した結果、重大な曖昧さは検出されませんでした。

**確認済み事項**:

- キャッシュ判定: サイズ > 0 で有効（FR-001, FR-002で明記）
- ready状態: 実体（safetensors/GGUF）が存在しサイズ > 0（FR-003で明記）
- ルーティング: 画像生成→画像、ASR→音声認識、TTS→音声合成（FR-005, FR-006で明記）
- 削除範囲: 登録情報、ファイル、ノードキャッシュ全て（FR-008で明記）
- エラー形式: OpenAI互換（NFR-001で明記）

**依存関係の確認**:

- SPEC-11106000: HF登録/キャッシュ
- SPEC-26006000: 音声対応（TTS+ASR）
- SPEC-32637000: capabilities検証

---

## 成功基準 *(必須)*
1. キャッシュ有/無/破損の登録が正しく動作すること。
2. 指定モデルでの chat/completions が成功し、誤ったモデルを選択しないこと。
3. 画像/音声 API が対応ノードへルーティングされること。
4. モデル削除が即時反映され、/v1/models に表示されないこと。
5. 追加/修正した TDD テストが全て PASS すること。
