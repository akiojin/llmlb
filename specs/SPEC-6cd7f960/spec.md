# SPEC-6cd7f960: 対応モデルリスト型管理

## ステータス

- **Status**: ✅ 実装完了
- **Priority**: P1
- **Created**: 2025-12-28

## 概要

モデル管理方式を「対応モデルリスト（内部）」と「URL登録」を併用する形式に統合する。
登録はメタデータのみ行い、モデルバイナリは Node が HF から直接取得する。

## 背景と動機

### 現状の課題

1. ユーザーが任意のHuggingFace URLを入力してモデルを登録できる
2. 対応していないモデルアーキテクチャの場合、正常に動作しない
3. ダウンロード後にエラーが発生し、ユーザー体験を損なう
4. サポート対象外のモデルへの問い合わせが発生する

### 解決策

動作確認済みのモデルを「対応モデル」として内部リストに持ち、
URL登録は維持しつつ、Nodeがマニフェストに従い直接取得する。

## ユーザーストーリー

### US-1: モデル一覧の確認

```
ユーザーとして、
対応しているモデルの一覧を確認したい。
なぜなら、どのモデルが利用可能か知りたいから。
```

**受入条件**:

- ダッシュボードの「Model Hub」タブで対応モデル一覧が表示される
- 各モデルに名前、説明、サイズ、必要VRAM、タグが表示される
- HuggingFaceのダウンロード数・スター数が表示される（オプション）
- 検索バーでモデル名による絞り込みができる

### US-2: モデルの登録（メタデータのみ）

```
ユーザーとして、
対応モデルを登録したい。
なぜなら、Node が HF から直接取得して推論準備を進められるから。
```

**受入条件**:

- 「Register」ボタンをクリックすると `/v0/models/register` が呼ばれる
- ロードバランサーはメタデータのみ保存し、バイナリは保持しない
- Node が HF から直接取得し、準備完了後に「Local」タブで Ready が表示される

### US-3: 登録済みモデルの確認

```
ユーザーとして、
登録済みのモデルを確認したい。
なぜなら、どのモデルが利用可能か把握したいから。
```

**受入条件**:

- ダッシュボードの「Local」タブで登録済みモデル一覧が表示される
- 各モデルのサイズ、必要VRAM、パスが表示される
- モデルの削除ができる

### US-4: モデルの状態確認

```
ユーザーとして、
各モデルの状態（未登録/登録済み/Ready）を
一目で確認したい。
なぜなら、次に何をすべきか判断したいから。
```

**受入条件**:

- Model Hubタブで各モデルに状態バッジが表示される
  - 「available」: 未登録（Registerボタン表示）
  - 「registered」: 登録済み（Node準備中）
  - 「ready」: Node準備完了（チェックマーク表示）

## 機能要件

### FR-1: 対応モデルリストの管理

- 動作確認済みモデルを `llmlb/src/supported_models.json` で管理する
- リストにはモデルID、名前、説明、HFリポジトリ、推奨ファイル名、
  サイズ、必要VRAM、タグ、能力、エンジン、対応プラットフォームを含む
- 新しいモデルの追加はローカルテスト後にコード更新で行う

#### supported_models.json スキーマ

```json
{
  "id": "string",
  "name": "string",
  "description": "string",
  "repo": "string",
  "recommended_filename": "string",
  "size_bytes": "number",
  "required_memory_bytes": "number",
  "tags": ["string"],
  "capabilities": ["string"],
  "quantization": "string",
  "parameter_count": "string",
  "format": "string",
  "engine": "string",
  "platforms": ["string"]
}
```

### FR-2: モデル一覧API

- `GET /v0/models/hub` で対応モデル一覧と状態を返す
- `status`（available/downloading/downloaded）と `lifecycle_status`（registered/ready など）を含む
- Node同期に基づく ready 状態を返す
- HuggingFaceの動的情報（ダウンロード数、スター数）は任意（キャッシュ付き）

### FR-3: Node直取得（Pull API なし）

- ロードバランサーはダウンロードを開始しない（`/v0/models/pull` は不要）
- Nodeがマニフェストに従ってHFから直接取得する

### FR-4: URL登録機能の維持

- `POST /v0/models/register` は維持する（メタデータ登録のみ）
- `POST /v0/models/discover-gguf` は廃止
- ダッシュボードの「Register」ダイアログは維持する

### FR-5: バイナリ非保持

- ロードバランサーはモデルバイナリを保持しない
- Node がローカルキャッシュを管理する

### FR-6: OpenAI互換API維持

- `GET /v1/models` は従来通り利用可能なモデルのみを返す
- ダウンロード中や未ダウンロードのモデルは含まない

### FR-6: モデル削除

- ロードバランサーはDBからメタデータを削除する
- 削除後、モデル同期通知をノードに送信する（登録時と同じ同期フロー）
- 複数ノードに同一モデルが存在する場合、全ノードから削除する
- ノード側の実際のファイル削除はノードのモデル同期処理に委譲

### FR-7: ダウンロード中断時の復旧

- ノードがダウンロード中にクラッシュした場合、再起動時に自動レジュームする
- ダウンロードの進捗管理はノード主導で行う
- ロードバランサーはノードの進捗状態をポーリングで取得する

### FR-8: ダウンロード中モデルへの推論リクエスト

- ダウンロード中（lifecycle_status: pending）のモデルへの推論リクエストは503で拒否する
- エラーレスポンスにはモデルがダウンロード中である旨を含める

## 非機能要件

### NFR-1: パフォーマンス

- モデル一覧APIのレスポンス時間: 500ms以内
- HF動的情報のキャッシュTTL: 10分

### NFR-2: 可用性

- HF APIが利用不可の場合でも静的情報でモデル一覧を返す

## UI/UX要件

### タブ構成

- 「Local」タブ: 登録済みモデル一覧
- 「Model Hub」タブ: 対応モデル一覧（デフォルト表示）
- 「OpenAI」タブ: OpenAIクラウドモデル一覧（APIキー設定時のみ表示）
- 「Anthropic」タブ: Anthropicクラウドモデル一覧（APIキー設定時のみ表示）
- 「Google」タブ: Geminiクラウドモデル一覧（APIキー設定時のみ表示）

### カード表示

- モデル名（大きく）
- 説明（1-2行）
- サイズ / 必要VRAM
- ダウンロード数 / スター数（HFから取得）
- 状態に応じたアクションボタン

### ポーリング間隔

- UI更新頻度: 10秒間隔
- モデル一覧・ノード状態・ダウンロード進捗を定期更新

### テーマ

- OS設定に追従したダークモード対応
- システムのカラースキーム設定を自動検出

### セッション管理

- ブラウザを閉じてもセッションを維持（永続セッション）
- 認証状態はJWTトークンで管理
- 詳細はSPEC-d4eb8796（認証・アクセス制御）を参照

## 依存関係

### 直接依存（このSPECが依存するもの）

- SPEC-11106000（HuggingFace URL登録）: URL登録機能を継承
- SPEC-dcaeaec4（モデルストレージ）: ダウンロード・キャッシュ機能を利用
- SPEC-d4eb8796（認証・アクセス制御）: ダッシュボード認証
- SPEC-94621a1f（ノード管理）: ノードとの通信・同期

### 依存元（このSPECに依存するもの）

- SPEC-48678000（モデル自動解決）: supported_models.json定義を使用
- SPEC-08d2b908（モデル管理統合）: 責務境界に含む

### 関連仕様

- SPEC-82491000（クラウドプロバイダー統合）: OpenAI/Anthropic/Googleモデル連携
- SPEC-d7feaa2c（エンジンローダー抽象化）: 量子化選択（`modelname:量子化`形式）

## 除外事項

- カスタムモデル登録機能（対応モデル以外の登録）
- モデルの自動更新機能
- モデルバージョン管理
- ロードバランサー主導のモデルダウンロード/変換

## Clarifications

### Session 2026-01-02 インタビュー

以下がインタビューにより確定:

**UI/UX詳細**:

- リアルタイム更新: ポーリング維持（10秒間隔）、WebSocket不使用
- アクセシビリティ: WCAG AAA準拠
- レスポンシブ: 基本対応（モバイル表示可、操作性限定）
- Model Hubソート: 固定順（ユーザー変更不可）
- カスタマイズ: 固定レイアウト
- オンボーディング: 不要

**モデル管理**:

- エンジン選択: 自動のみ（ユーザー変更不可）
- GPUメモリ不足: エラーメッセージのみ（事前警告なし）
- ダウンロードタイムアウト: なし（無期限待機、手動キャンセルのみ）
- 同時操作競合: 先勝ち方式

**Playground**:

- チャット履歴: ローカル保存（localStorage）
- モデル比較機能: 不要
- パラメータ調整: Playgroundのみ（グローバルデフォルトなし）

**その他**:

- エクスポート/インポート: 不要
- メンテナンスモード: 不要
- 監査ログ: 不要
- ノード自動起動: 不可（手動のみ）
- エラー境界: 不要

**ログビューア要件**:

- 表示範囲: ロードバランサー + ノード（別タブ）
- フィルタリング: 高度なフィルタ対応
  - ログレベル（info/warn/error）
  - 時間範囲
  - キーワード検索
  - 正規表現対応
  - 複数条件AND/OR
  - 保存済みフィルタ

**リクエスト履歴**:

- 保存期間: 7日間
- 保存内容: メタデータ + リクエスト内容 + レスポンス内容
- エラー表示: 簡易/詳細切替可能

**国際化対応**:

- 対応言語: 英語 + 日本語

**通知**:

- ノードオフライン: バッジ変化 + Toast通知
- ブラウザWeb Push通知: 不要

**設定画面**:

- レイアウト: 単一ページ（タブ分割なし）
- 全設定を1ページに表示

**ノード詳細ページ**:

- 表示内容: 包括的
  - 基本情報（ステータス、GPU情報、ロード済みモデル）
  - メトリクス（GPU使用率、メモリ、リクエスト数）
  - ログ表示
  - 履歴グラフ

**ダッシュボード構成**:

- デフォルトページ: オーバービュー（システムサマリー）
- オーバービュー内容: リッチダッシュボード
  - グラフ表示
  - トレンド表示
  - アラート表示
  - ノード数、モデル数、リクエスト数、エラー率、レイテンシ

**コスト追跡**:

- クラウドプロバイダーAPI使用量: 集計ダッシュボード
- 表示単位: 日/週/月単位のコスト集計

**ダウンロード責務の明確化**:

- ダッシュボード: モデル登録のみ（メタデータ操作）
- ノード: 実際のモデルダウンロード実行
- ダッシュボードはダウンロードを開始しない

### Session 2026-01-02 インタビュー Part 2

**エラーハンドリング**:

- 通信断時UI: サイレントリトライ（バックグラウンドでリトライ、一定時間後にエラー表示）
- ストリームエラー: 全体をエラー置換（途中結果を破棄）
- 異常検知（GPUメモリリーク等）: 警告のみ（自動介入なし）

**Playground**:

- システムプロンプト: テキストエリアで自由編集可能
- 会話上限: 制限なし（ブラウザメモリの限り）
- ファイルアップロード: 複数形式対応（画像、PDF、テキストファイル）

**認証・セッション**:

- タブ間同期: 不要（各タブ独立）
- トークン期限切れ: リフレッシュトークンで自動更新

**技術選定**:

- 状態管理: React Queryのみ（専用ライブラリ不使用）
- UIライブラリ: お任せ（現行shadcn/ui維持可）
- バンドルサイズ: 制約なし
- 開発者ツール: 組み込まない（ブラウザDevToolsのみ）

**表示仕様**:

- 複数ノード同一モデル: ノード別に個別表示
- モデルウォームアップ: 非表示
- フォールバック機能: 不要（ユーザーが明示的にモデル選択）
- 履歴フィルタ: なし（全履歴を時系列表示のみ）

**ノード管理**:

- ノードラベル: 複数タグ付与可能（例: 「GPU-A」「開発用」）

**クラウド連携**:

- APIタイムアウト: 全プロバイダー共通の固定値

**品質保証**:

- パフォーマンス監視: 本番RUM（Real User Monitoring）
- テスト戦略: ユニット + 統合 + E2E（Playwright）

### Session 2026-01-02 インタビュー Part 3

**ファイルアップロード詳細**:

- サイズ制限: 最大100MB
- 保存先: ブラウザのみ（サーバーに送信しない）
- 送信形式: モデル依存（対応形式に応じて自動選択）

**権限管理**:

- ノードタグ管理: 管理者のみ

**デプロイ**:

- 方式: ロードバランサー組み込み（静的ファイルをロードバランサーバイナリに埋め込み）
- モデルファイルDL: サポートなし

**RUM（Real User Monitoring）**:

- 実装方式: ロードバランサー統合（ロードバランサーのメトリクスエンドポイントに送信）

**Playground詳細**:

- 会話エクスポート: 不要
- メッセージ再編集: サポートなし

**UI/UX詳細**:

- キーボードショートカット: 不要
- ヘルプ: 外部リンク（GitHub/Docsサイト）
- 言語切替: ブラウザ追従 + 手動変更可能
- 高負荷表示: バッジ色で表現（黄色/赤色）

**表示項目**:

- コンテキスト長: モデル一覧カードにも表示

### Session 2026-01-02 インタビュー Part 4

**アーキテクチャ決定**:

- リアルタイム更新: WebSocket全面移行（ポーリングから移行）
- マークダウン表示: Playground対応必須（react-markdown使用）
- セッション管理: 現状維持（シングルトークン、タイムアウトなし）

**UI/UX確定事項**:

- 削除確認ダイアログ: 全削除操作で必須（ノード、モデル、APIキー、ユーザー）
- ノードタグ: カンマ区切りテキスト入力（現状維持）
- ノード一覧: ソート（5項目）、ページング、エクスポート（JSON/CSV）全て必要
- Stopボタン: ストリーミング中断機能必須
- エラーメッセージ: 理由を含む標準形式（例: 「ノードが応答しませんでした」）

**表示仕様**:

- メトリクスグラフ: 24時間表示（ノード詳細ページ）
- オーバービュー: 24時間表示、包括的グラフ（リクエスト/レイテンシ/GPU/エラー率）
- メトリクス古さ判定: 30秒で`metrics_stale: true`
- セッション保存: 即時保存（メッセージごとにlocalStorageへ）

**追加機能**:

- コスト追跡: 詳細実装（トークン・費用を日/週/月でグラフ表示）
- ログ検索: キーワード検索追加（正規表現は不要）
- ユーザー管理: Manage Users、Invitation Codes維持
- ログダウンロード: テキスト/JSON両形式選択可能

**ノード状態遷移**:

- Pending → Registering: 管理者承認
- Registering → Online: ヘルスチェック受信 + 全モデル準備完了（`ready_models` loaded == total）
- Online → Offline: 30秒以上ヘルスチェックなし

**技術仕様**:

- APIフィールド: `runtime_id`に統一（バックエンド修正必要）
- ブラウザサポート: モダンブラウザのみ（Chrome/Firefox/Safari/Edge最新2バージョン）
