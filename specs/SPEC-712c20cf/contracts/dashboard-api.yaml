openapi: 3.0.3
info:
  title: LLM Router Dashboard API
  description: |
    管理ダッシュボードのREST API仕様。
    ノード情報とシステム統計をJSON形式で提供します。
  version: 1.0.0
  contact:
    name: LLM Router Team
servers:
  - url: http://localhost:32768
    description: Local development server
  - url: http://router:32768
    description: Production server

paths:
  /dashboard:
    get:
      summary: ダッシュボードページを取得
      description: 管理ダッシュボードのHTMLページを返却
      operationId: getDashboardPage
      tags:
        - Dashboard UI
      responses:
        '200':
          description: ダッシュボードHTMLページ
          content:
            text/html:
              schema:
                type: string
                example: |
                  <!DOCTYPE html>
                  <html>...

</html>
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/dashboard/nodes:
    get:
      summary: ノード一覧を取得
      description: 登録済みの全ノード情報をJSON配列で返却
      operationId: getNodes
      tags:
        - Dashboard API
      responses:
        '200':
          description: ノード一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DashboardNode'
              examples:
                multipleNodes:
                  summary: 複数のノード
                  value:
                    - id: "123e4567-e89b-12d3-a456-426614174000"
                      machine_name: "server-01"
                      ip_address: "192.168.1.100"
                      status: "online"
                      runtime_version: "0.1.0"
                      registered_at: "2025-10-31T10:00:00Z"
                      last_seen: "2025-10-31T12:30:00Z"
                      uptime_seconds: 9000
                      sync_state: "running"
                      sync_progress:
                        model_id: "gpt-oss-20b"
                        file: "model.gguf"
                        downloaded_bytes: 1048576
                        total_bytes: 1073741824
                      sync_updated_at: "2025-10-31T12:30:05Z"
                    - id: "234e5678-e89b-12d3-a456-426614174001"
                      machine_name: "server-02"
                      ip_address: "192.168.1.101"
                      status: "online"
                      runtime_version: "0.1.0"
                      registered_at: "2025-10-31T09:00:00Z"
                      last_seen: "2025-10-31T12:30:00Z"
                      uptime_seconds: 12600
                emptyList:
                  summary: ノードなし
                  value: []
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/dashboard/stats:
    get:
      summary: システム統計を取得
      description: システム全体の統計情報をJSON形式で返却
      operationId: getSystemStats
      tags:
        - Dashboard API
      responses:
        '200':
          description: システム統計
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardStats'
              examples:
                normalStats:
                  summary: 通常の統計
                  value:
                    total_nodes: 10
                    online_nodes: 8
                    offline_nodes: 2
                    total_requests: 0
                    successful_requests: 0
                    failed_requests: 0
                    total_active_requests: 0
                    average_response_time_ms: null
                noNodes:
                  summary: ノードなし
                  value:
                    total_nodes: 0
                    online_nodes: 0
                    offline_nodes: 0
                    total_requests: 0
                    successful_requests: 0
                    failed_requests: 0
                    total_active_requests: 0
                    average_response_time_ms: null
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/dashboard/metrics/{node_id}:
    get:
      summary: ノードメトリクス履歴を取得
      description: |
        特定のノードのメトリクス履歴を取得。
      operationId: getNodeMetrics
      tags:
        - Dashboard API
      parameters:
        - name: node_id
          in: path
          required: true
          description: ノードID（UUID）
          schema:
            type: string
            format: uuid
            example: "123e4567-e89b-12d3-a456-426614174000"
      responses:
        '200':
          description: ノードメトリクス履歴
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/HealthMetrics'
        '404':
          description: ノードが見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    DashboardNode:
      type: object
      description: ノード情報（稼働時間付き）
      required:
        - id
        - machine_name
        - ip_address
        - status
        - runtime_version
        - registered_at
        - last_seen
        - uptime_seconds
      properties:
        id:
          type: string
          format: uuid
          description: ノードID（UUID v4）
          example: "123e4567-e89b-12d3-a456-426614174000"
        machine_name:
          type: string
          description: マシン名
          example: "server-01"
          minLength: 1
          maxLength: 255
        ip_address:
          type: string
          description: IPアドレス（IPv4またはIPv6）
          example: "192.168.1.100"
          pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$|^([0-9a-fA-F]{0,4}:){7}[0-9a-fA-F]{0,4}$"
        status:
          type: string
          enum: [online, registering, offline]
          description: ノードステータス
          example: "online"
        runtime_version:
          type: string
          description: LLM runtimeバージョン（セマンティックバージョニング）
          example: "0.1.0"
          pattern: "^\\d+\\.\\d+\\.\\d+$"
        registered_at:
          type: string
          format: date-time
          description: 登録日時（ISO 8601形式）
          example: "2025-10-31T10:00:00Z"
        last_seen:
          type: string
          format: date-time
          description: 最終確認日時（ISO 8601形式）
          example: "2025-10-31T12:30:00Z"
        uptime_seconds:
          type: integer
          format: int64
          description: 直近でオンラインになってからの経過時間（秒）。Offlineまたは不明な場合は0。
        sync_state:
          type: string
          enum: [idle, running, success, failed]
          description: モデル同期状態
          example: "running"
        sync_progress:
          type: object
          description: モデル同期の進捗情報
          properties:
            model_id:
              type: string
              description: 対象モデルID
              example: "gpt-oss-20b"
            file:
              type: string
              description: 対象ファイル名
              example: "model.gguf"
            downloaded_bytes:
              type: integer
              format: int64
              description: ダウンロード済みバイト数
              example: 1048576
            total_bytes:
              type: integer
              format: int64
              description: 総バイト数
              example: 1073741824
        sync_updated_at:
          type: string
          format: date-time
          description: 同期状態の最終更新時刻（ISO 8601形式）
          example: "2025-10-31T12:30:05Z"
          example: 9000
          minimum: 0

    DashboardStats:
      type: object
      description: システム統計情報
      required:
        - total_nodes
        - online_nodes
        - offline_nodes
        - total_requests
        - successful_requests
        - failed_requests
        - total_active_requests
        - average_response_time_ms
      properties:
        total_nodes:
          type: integer
          description: 登録ノード総数
          example: 10
          minimum: 0
        online_nodes:
          type: integer
          description: オンラインノード数
          example: 8
          minimum: 0
        offline_nodes:
          type: integer
          description: オフラインノード数
          example: 2
          minimum: 0
        total_requests:
          type: integer
          format: int64
          description: 総リクエスト処理数
          example: 0
          minimum: 0
        successful_requests:
          type: integer
          format: int64
          description: 成功リクエスト数
          example: 0
          minimum: 0
        failed_requests:
          type: integer
          format: int64
          description: 失敗リクエスト数
          example: 0
          minimum: 0
        total_active_requests:
          type: integer
          format: int32
          description: 処理中リクエスト数
          example: 0
          minimum: 0
        average_response_time_ms:
          type: number
          format: float
          description: 平均レスポンスタイム（ミリ秒）
          example: 0.0

    HealthMetrics:
      type: object
      description: ノードメトリクス（履歴エントリ）
      required:
        - node_id
        - cpu_usage
        - memory_usage
        - active_requests
      properties:
        node_id:
          type: string
          format: uuid
          description: ノードID
          example: "123e4567-e89b-12d3-a456-426614174000"
        cpu_usage:
          type: number
          format: float
          description: CPU使用率（%）
          example: 45.2
          minimum: 0
          maximum: 100
        memory_usage:
          type: number
          format: float
          description: メモリ使用率（%）
          example: 60.5
          minimum: 0
          maximum: 100
        active_requests:
          type: integer
          description: 処理中のリクエスト数
          example: 3
          minimum: 0

    Error:
      type: object
      description: エラーレスポンス
      required:
        - error
        - timestamp
      properties:
        error:
          type: string
          description: エラーメッセージ
          example: "Internal server error"
        details:
          type: string
          description: 詳細な説明（オプション）
          example: "Failed to read node data"
        timestamp:
          type: string
          format: date-time
          description: エラー発生日時
          example: "2025-10-31T12:30:00Z"

tags:
  - name: Dashboard UI
    description: ダッシュボードページ（HTML）
  - name: Dashboard API
    description: ダッシュボードデータAPI（JSON）
