# 機能仕様書: 管理ダッシュボード

**機能ID**: `SPEC-712c20cf`
**作成日**: 2025-10-30
**ステータス**: ✅ 実装完了 (2025-11-01)
**元のSPEC**: SPEC-32e2b31a から分割
**依存SPEC**: SPEC-94621a1f, SPEC-63acef08, SPEC-443acc8c, SPEC-d4eb8796

## 概要

WebブラウザからアクセスできるリアルタイムダッシュボードUI。ノードの状態、リクエスト処理状況、パフォーマンスメトリクスを可視化し、以下2種類のPlaygroundを備える。

- エンドポイント別 Playground（`#playground/:endpointId`）: 特定エンドポイントに直接送る検証用
- LB Playground（`#lb-playground`）: ロードバランサー経由（`/v1/chat/completions`）の配分検証用

## ユーザーシナリオ＆テスト

### ユーザーストーリー - 管理ダッシュボードとリアルタイム監視

ユーザーはWebブラウザからロードバランサーのダッシュボードにアクセスし、すべてのノードの状態、リクエスト処理状況、パフォーマンスメトリクスをリアルタイムで確認できる。

**この優先度の理由**: システムがAPI経由で動作していれば、ダッシュボードは可視化のための追加機能。運用初期はログやAPIレスポンスで状態確認が可能。

**独立テスト**: ブラウザでダッシュボードにアクセスし、ノード情報が表示されることで価値を提供する。

**受け入れシナリオ（監視機能）**:

1. **前提** ロードバランサーが起動している、**実行** ブラウザで`http://lb:32768/dashboard`にアクセスする、**結果** ダッシュボードが表示され、登録済みノードの一覧が確認できる
2. **前提** 複数のノードが登録されている、**実行** ダッシュボードでノード一覧を確認する、**結果** 各ノードのマシン名、IPアドレス、LLM runtimeバージョン、稼働時間、状態（オンライン/オフライン）が表示される
3. **前提** ノードがリクエストを処理中、**実行** ダッシュボードをリロードする、**結果** リアルタイムでリクエスト処理数、レスポンスタイム、エラー数が更新される
4. **前提** ダッシュボードを表示中、**実行** 新しいノードが登録される、**結果** ページをリロードせずに新しいノードが一覧に自動追加される

**受け入れシナリオ（Playground機能）**:

1. **前提** エンドポイントがOnlineかつモデル同期済み、**実行** Endpoint詳細モーダルの「Open Playground」を押す、**結果** `#playground/:endpointId` に遷移し対象エンドポイントへ直接送信できる
2. **前提** ダッシュボードを表示中、**実行** ヘッダーの「LB Playground」を押す、**結果** `#lb-playground` に遷移し、ロードバランサー経由の送信画面が開く
3. **前提** LB PlaygroundでAPIキーが未入力、**実行** 送信操作を行う、**結果** 送信不可となりAPIキー要求エラーが表示される
4. **前提** LB Playgroundで有効なAPIキーが設定済み、**実行** `/v1/models` を取得してモデルを選択し送信、**結果** `/v1/chat/completions` 経由で応答が表示される（stream ON/OFF両対応）
5. **前提** LB Playgroundで負荷試験モードを選択済み、**実行** 試験開始（既定: 200件 / 並列10 / 間隔0ms）、**結果** 進捗が表示され停止操作も可能である
6. **前提** LB Playgroundで送信または負荷試験を完了、**実行** 配分表示を確認、**結果** `request-responses` を根拠にエンドポイント別の件数/成功失敗/平均応答時間が可視化される
7. **前提** Playground を表示中、**実行** Settings の Max Tokens を「手動値」と「Use model max context」で切り替え、モデルを変更する、**結果** 選択中モデルの `max_tokens` が既知なら入力欄は自動値に固定され、未知なら手動入力が有効のままになる。モデル変更後もチェックボックスが「チェック済みなのにdisabledで解除できない」状態にならず、利用者は常にOFFに戻せる

**受け入れシナリオ（ノード管理機能）**:

1. **前提** ノード一覧が表示されている、**実行** あるノードの「設定」ボタンをクリックする、**結果** ノード設定画面が開き、ノード名、メモ、タグを編集できる
2. **前提** ノード設定画面が開いている、**実行** ノード名を変更して「保存」をクリックする、**結果** 変更が即座に反映され、ノード一覧に新しい名前が表示される
3. **前提** 不要なノードが登録されている、**実行** ノード一覧で「削除」ボタンをクリックし、確認ダイアログで「削除」を選択する、**結果** ノードが登録解除され、一覧から削除される
4. **前提** 問題のあるノードが登録されている、**実行** ノード一覧で「強制切断」ボタンをクリックする、**結果** ノードが即座にOffline状態になる

## 機能要件

### FR-017: ダッシュボードUI

Webブラウザでアクセス可能なダッシュボード画面を提供する。

- エンドポイント: `GET /dashboard`
- 技術スタック: HTML + JavaScript + CSS（フレームワークはシンプルさを優先）
- レスポンシブデザイン対応

### FR-018: ノード一覧表示

登録されたすべてのノードを一覧表示する。

- 表示項目:
  - マシン名
  - IPアドレス
  - LLM runtimeバージョン
  - ステータス（オンライン/オフライン）
  - 最終確認時刻
  - 稼働時間（直近でオンラインになった時刻からの経過時間）
- ソート機能: マシン名、ステータスでソート可能

### FR-019: リアルタイム更新

ダッシュボードの情報を自動的に更新する。

- 更新間隔: 5秒ごと
- 更新方法: WebSocketまたはポーリング
- ページリロード不要

### FR-020: パフォーマンスメトリクス表示

各ノードのパフォーマンス情報を可視化する。

- 表示メトリクス:
  - CPU使用率（グラフ）
  - メモリ使用率（グラフ）
  - 処理中のリクエスト数
  - 総リクエスト処理数
  - 平均レスポンスタイム
  - エラー率

### FR-021: システム統計

システム全体の統計情報を表示する。

- 統計項目:
  - 登録ノード総数
  - オンラインノード数
  - 総リクエスト処理数
  - 平均レスポンスタイム
  - エラー総数

### FR-022: ノード詳細ビュー

特定のノードの詳細情報を表示する。

- 基本情報:
  - ノードID（UUID）
  - マシン名
  - IPアドレス/ポート
  - 登録日時
  - 稼働時間
  - 現在のステータス（オンライン/オフライン）
- システム情報:
  - OS名/バージョン
  - CPU情報（モデル、コア数、使用率）
  - メモリ情報（総容量、使用中、使用率グラフ）
  - ディスク情報（空き容量、使用率）
- GPU情報（FR-029と連携）:
  - GPU名/ベンダー
  - VRAM（総容量、使用中、使用率グラフ）
  - GPU温度（現在値、警告閾値）
  - GPUロード（%、グラフ）
- LLM runtime情報:
  - runtimeバージョン
  - 対応モダリティ（テキスト/画像/音声）
  - 設定パラメータ
- ロード済みモデル（FR-031と連携）:
  - モデル名一覧
  - 各モデルのサイズ/VRAM使用量
  - ロード状態
- パフォーマンス履歴:
  - 処理リクエスト数（直近1時間/24時間）
  - 平均レスポンスタイム
  - エラー率
  - リクエスト処理のタイムラインチャート
- エラーログ:
  - 直近のエラー一覧
  - エラー詳細表示（スタックトレース等）
  - エラーログのフィルタ/検索

### FR-022b: モデル同期/ダウンロード状態表示

ダッシュボードでノードのモデル同期状態と進捗を確認できる。

- 表示対象:
  - 同期状態（idle/running/success/failed）
  - 進捗（モデル名、ファイル名、ダウンロード量/総量）
- 表示場所:
  - ノード一覧のステータス行（簡易表示）
  - ノード詳細ビュー（詳細表示）

### FR-023: ノード設定管理

WebUIでノード個別の設定を表示・変更できる。

- 設定項目:
  - ロードバランサーURL（参照用）
  - 自動起動設定の有効化/無効化（将来的な拡張）
  - ノード名のカスタマイズ
  - メモ/タグ付け
- 設定変更後の反映:
  - 即座にダッシュボードに反映
  - ノード再起動時に適用

### FR-024: ノード制御

ダッシュボードからノードを制御できる。

- 制御機能:
  - ノードの登録解除（削除）
  - ノードの強制切断（Offline化）
  - 将来的な拡張：
    - ノードの起動/停止コマンド送信（OS依存）
    - ノード設定のリモート更新
- 確認ダイアログ:
  - 削除時に確認ダイアログ表示
  - 誤操作防止

### FR-025: 初期セットアップウィザード（将来的な拡張）

新規ノード追加時のガイドUIを提供する。

- ウィザード機能:
  - ロードバランサーURL入力フォーム
  - 接続テスト機能
  - トークン/認証設定（認証機能実装後）
  - セットアップ手順のステップバイステップガイド
- 将来的な拡張:
- ロードバランサー／ノードそれぞれのインストーラーダウンロードリンク
- 自動セットアップスクリプト生成

### FR-026: チャットコンソール（ダッシュボード付属）

- FR-026a（Endpoint Playground）:
  - ルート: `#playground/:endpointId`
  - 送信先: `POST /api/endpoints/:id/chat/completions`（JWTログイン前提）
  - 用途: 単一エンドポイントの疎通・モデル動作確認
- FR-026b（LB Playground）:
  - ルート: `#lb-playground`
  - 送信先: `POST /v1/chat/completions`（APIキー必須）
  - モデル取得: `GET /v1/models`（APIキー必須）
  - APIキー入力はUI上で行い、ブラウザの `localStorage` に保持する
  - 通常チャット（stream ON/OFF）と負荷試験モード（既定: 200件/並列10/間隔0ms）を提供する
  - 負荷試験結果は `GET /api/dashboard/request-responses` と `request_body.user` タグを使って集計し、エンドポイント配分を表示する
- 共通:
  - Settings ダイアログで `system_prompt` / `stream` / `temperature` / `max_tokens` を設定できる
  - `max_tokens` は手動指定に加えて、選択中モデルの `max_tokens` が既知の場合に「Use model max context」で自動使用できる（自動使用中は入力欄が無効化される）
  - 選択中モデルの `max_tokens` が不明（null/未取得）の場合は `(unknown)` と表示し、チェックボックスはOFFのときのみ無効化する（「チェック済みなのにdisabledで解除できない」状態を作らない）

### FR-027: テーマカラー切り替え

ダッシュボードのカラーテーマを切り替えられる。

- 設計コンセプト「Functional Monitoring」:
  - 情報優先・装飾最小のデザイン
  - 色のみのテーマ（レイアウトは全テーマ共通）
  - 装飾的視覚効果は廃止（スキャンライン、グリッド、CRT効果等）
- 提供テーマ（3種類）:
  - **Dark**（デフォルト）: ダークグレー背景 + シアンアクセント
  - **Light**: ライトグレー背景 + ブルーアクセント
  - **High Contrast**: 純黒背景 + 高彩度カラー（アクセシビリティ重視）
- CSS変数によるテーマ実装:
  - `--bg`, `--bg-card`, `--text`, `--accent`, `--border` 等のCSS Custom Properties
  - テーマ切替は `data-theme` 属性の変更のみで反映
- テーマ切り替え:
  - ヘッダーにテーマ切り替えボタン配置
  - 即座に反映（リロード不要）
  - LocalStorageで選択を永続化
  - 旧テーマからの自動マイグレーション対応
- アクセシビリティ:
  - prefers-reduced-motion対応
  - High Contrastテーマは WCAG AA準拠の色対比
- 対応範囲:
  - ダッシュボード全体
  - チャットUI
  - Chart.jsグラフ（テーマに応じたカラーパレット）

### FR-028: ModelsセクションUI簡略化

Models管理セクションから未使用のHugging Face関連UIを削除する。

- 削除対象:
  - Search HF入力フィールド
  - Refresh HFボタン
  - Refresh Registeredボタン
  - Refresh Tasksボタン
  - section-toolsコンテナ全体
- 理由:
  - 未実装または不要な機能のUIを削除しシンプル化
  - ユーザー混乱の防止

### FR-029: GPU情報表示

各ノードのGPU情報を詳細に表示する。

- 表示項目:
  - GPU名（例: NVIDIA RTX 4090）
  - VRAM使用率（使用中/総容量、グラフ表示）
  - GPU温度（警告閾値付き）
  - GPUロード状況（%）
- 表示場所:
  - ノード一覧のカラムとして追加
  - ノード詳細ビュー内のGPUセクション
- 更新頻度: 5秒ごと（FR-019と同期）

### FR-030: クラウドプロバイダー状況表示

登録済みクラウドプロバイダーの状態を表示する。

- 表示項目:
  - プロバイダー名（OpenAI、Anthropic等）
  - 接続状態（認証済み/未認証/エラー）
  - 最終確認時刻
  - 利用可能モデル数
- 表示場所:
  - ダッシュボードに「クラウドプロバイダー」セクションを追加
- 操作:
  - APIキー再認証ボタン
  - プロバイダー削除ボタン（確認ダイアログ付き）

### FR-031: モデル割り当て状況表示

各ノードにロードされているモデルの状況を表示する。

- 表示項目:
  - モデル名
  - モデルサイズ（パラメータ数/ファイルサイズ）
  - ロード状態（ロード済み/ロード中/未ロード）
  - VRAM使用量（推定）
- 表示場所:
  - ノード詳細ビュー内の「ロード済みモデル」セクション
  - モデル一覧に「割り当てノード」カラムを追加
- 操作:
  - モデルのアンロードボタン（将来拡張）

## 非機能要件

### NFR-010: ユーザビリティ

- 直感的なUI設計
- 5秒以内にシステム全体の状態を把握可能
- モバイルデバイスからもアクセス可能

### NFR-011: パフォーマンス

- 初回ロード時間: 2秒以内
- リアルタイム更新のレイテンシ: 100ms以内

### NFR-012: アクセシビリティ

- WCAG 2.1 Level AAに準拠
- スクリーンリーダー対応

## 実装状態

### 🚧 未実装（将来の拡張）

すべての機能が未実装です。以下の順序で実装を推奨：

1. **Phase 1: 基本UI**
   - 静的HTMLダッシュボード
   - ノード一覧表示
   - 手動リフレッシュ

2. **Phase 2: リアルタイム更新**
   - 自動ポーリング
   - WebSocket統合
   - リアルタイムステータス更新

3. **Phase 3: メトリクス可視化**
   - パフォーマンスグラフ
   - 統計サマリー
   - 履歴データ表示

4. **Phase 4: 高度な機能**
   - ノード詳細ビュー
   - フィルタリング＆検索
   - エクスポート機能

## 技術提案

### フロントエンド
- **オプション1**: Vanilla JS + Chart.js（シンプル、依存少ない）
- **オプション2**: React + Recharts（リッチなUI、保守性高い）
- **オプション3**: Vue.js + ECharts（学習コスト低い、日本語ドキュメント豊富）

### リアルタイム通信
- **オプション1**: WebSocket（双方向通信、低レイテンシ）
- **オプション2**: Server-Sent Events（シンプル、片方向通信）
- **オプション3**: ポーリング（実装簡単、レイテンシ高い）

### 推奨スタック

初期実装は**Vanilla JS + Chart.js + ポーリング**で開始し、必要に応じてWebSocketに移行することを推奨します。

---

## Clarifications

### Session 2025-12-24

仕様を精査した結果、重大な曖昧さは検出されませんでした。実装も完了しています。

**確認済み事項**:

- エンドポイント: /dashboard（FR-017で明記）
- リアルタイム更新: 5秒間隔（FR-019で明記）
- 表示項目: マシン名、IP、LLM runtimeバージョン、ステータス、稼働時間（FR-018で明記）
- チャットコンソール: `#playground/:endpointId`（エンドポイント別）と `#lb-playground`（LB経由）の2系統（FR-026で明記）
- テーマ: Dark（デフォルト）、Light、High Contrast（FR-027で明記）

**実装技術スタックの確認**:

- Vanilla JS + Chart.js + ポーリング（推奨スタックで明記）

**未実装機能の確認**:

- 初期セットアップウィザード（FR-025は将来拡張）

### Session 2025-12-30

インタビューにより以下が確定:

**React/Next.js移行（最優先）**:

- **技術スタック移行**: 現在のLeptos（Rust WASM）からReact/Next.jsへ移行する
- **移行理由**:
  - コミュニティ規模とエコシステムの充実
  - 開発者採用の容易さ
  - コンポーネントライブラリの豊富さ
- **移行優先度**: 最優先（他の新機能より先に実施）
- **移行範囲**: ダッシュボード全体（Playground含む）

**ターゲットユーザー**:

- 開発者・エンジニア（プライマリ）
- 一般ビジネスユーザー（セカンダリ）

**UI移行後に追加予定の機能**:

- プロンプトテンプレート機能
- 使用量ダッシュボード
- チーム機能
- クイックアクション

**競合差別化**:

- 複数ノード分散処理がLLM Load Balancerの最大の差別化要素
- LM Studio、Ollama、vLLM/TGI、LiteLLMとの差別化ポイント

**その他の決定事項**:

- クラウドプロバイダーAPIキー設定はダッシュボード設定画面で管理
- APIキー表示はマスク形式（`sk-****xxxx`）

**実装時の判断に委ねる事項**:

- コンポーネントライブラリ選定（推奨: shadcn/ui または Radix UI）
- 状態管理（推奨: Zustand または TanStack Query）

### Session 2025-12-30 (追加)

インタビューにより以下が追加確定:

**ハイブリッドAPI構成**:

- **推論API（パフォーマンス重視）**: Rustで継続（/v1/chat/completions等）
- **管理API（全機能）**: Next.jsで実装
  - ノード管理、モデル管理、設定管理
  - ユーザー管理、APIキー管理
  - ログ・履歴管理
- **理由**: 推論APIはレイテンシが重要なためRust継続、管理機能は開発効率を優先

**セッション管理**:

- **認証セッションタイムアウト**: 7日間（利便性重視）
- **セッション永続化**: JWT + リフレッシュトークン方式

**リアルタイム更新**:

- **WebSocket全面移行**: ポーリングから完全にWebSocketへ移行
  - ノード状態更新
  - キュー状態更新
  - メトリクス更新
  - リクエスト履歴更新
- **更新頻度**: 5秒ごと（既存と同じ）

**ヘルスチェック詳細化**:

- **チェック項目**: プロセス生存確認 + GPU・メモリ状態
  - GPU使用率、VRAM使用量、GPU温度
  - メモリ使用率
- **推論テスト**: スコープ外（オーバーヘッド回避）

### Session 2026-02-12

LB Playground追加に関する実装方針を以下で確定:

- 導線はダッシュボードヘッダーの `LB Playground` ボタン
- LB PlaygroundはAPIキー入力方式を採用し、キーは `localStorage` に保持
- 機能範囲は通常チャット + 配分可視化 + 負荷試験を同一画面で提供
- 負荷試験既定値は高負荷（200件 / 並列10 / 間隔0ms）
