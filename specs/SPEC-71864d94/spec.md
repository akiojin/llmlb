# 機能仕様書: llmlb全体的リファクタリング（メジャーバージョンアップ）

**機能ID**: `SPEC-71864d94`
**作成日**: 2026-02-22
**ステータス**: 下書き
**入力**: ユーザー説明: "llmlb全体的リファクタリング（メジャーバージョンアップ）"

## Clarifications

### Session 2026-02-22

- 事前インタビューにより全設計判断が合意済み。clarifyフェーズで追加の重大な曖昧性は検出されなかった。
- Proxy設計 → trait Provider抽象化（CloudProvider trait）
- Error統一 → AppError一本化（全52箇所のインラインErrorResponse含む徹底）
- Balancer分割 → ファイル分割のみ（LoadManager structは維持）
- Record改善 → ビルダー + node_→endpoint_リネーム同時（DB migration含む）
- Auth → auth_disabled廃止 + ヘルパー関数
- main.rs → チェックサム削除 + server.rs/bootstrap.rsに分割
- 型整理 → types/に統合、common/はprotocol+errorのみ
- レガシー命名 → 全体一掃（node\_ → endpoint\_）
- Dashboard → Rust側と同時並行、PlaygroundBase完全共通基盤
- テスト → TestAppStateBuilder統合
- DB層 → Repositoryパターン導入
- 破壊的変更 → 全面許容（APIは必要時のみ変更）
- フェーズ → 単一SPEC・Phase分割

## ユーザーシナリオ＆テスト *(必須)*

<!-- このリファクタリングの主要な受益者は「開発者」であり、
     ユーザーストーリーは開発者体験の改善を軸に構成する。
     各Phaseが独立したストーリーとして実装・テスト可能。 -->

### ユーザーストーリー1 - 型定義の一元管理と命名統一 (優先度: P1)

開発者として、すべてのドメイン型が1つのモジュールに集約され、
「ノード」という旧概念が完全に消えて「エンドポイント」で統一された命名になった
コードベースで作業したい。これにより、型を探す際の迷いがなくなり、
レガシー用語による認知負荷が解消される。

**この優先度の理由**: 型定義とレガシー命名は他のすべてのPhaseの基盤であり、
これを先に完了しないと後続の作業で二重修正が発生する。
また、`common/types.rs`と`types/endpoint.rs`のGPU型重複が混乱の原因となっている。

**独立テスト**: 型モジュールの再配置後に全テストスイート（265テスト）が
変更なく通過することで検証可能。grep検索で「node_id」「node_name」
「node_ip」がコードベースから完全に消えていることで命名統一を確認できる。

**受け入れシナリオ**:

1. **前提** `common/types.rs`に751行の型定義が存在する、
   **実行** 型を`types/`配下に移動する、
   **結果** `common/`モジュールには`protocol.rs`と`error.rs`のみが残り、
   全テストが通過する
2. **前提** `GpuDeviceInfo`と`GpuDevice`が別々に定義されている、
   **実行** 単一のGPU型に統一する、
   **結果** GPU関連の型定義が1箇所のみとなり、全参照が更新される
3. **前提** コードベース全体に`node_id`/`node_name`/`node_ip`が散在する、
   **実行** `endpoint_id`/`endpoint_name`/`endpoint_ip`にリネームする、
   **結果** `node_`プレフィクスの変数・フィールドがゼロになる

---

### ユーザーストーリー2 - エラーハンドリングの統一とセキュリティ修正 (優先度: P1)

開発者として、APIハンドラーのエラー返却方法が1つのパターンに統一され、
内部IPアドレスなどの機密情報がレスポンスに漏洩しない状態で開発したい。
現在、AppErrorが2箇所に定義され、うち1箇所はセキュリティリスクを持っている。

**この優先度の理由**: セキュリティリスク（内部IP漏洩）の即座の解消が必要。
また、3系統のエラーハンドリングパターンが混在しており、
新しいハンドラーを書く際にどのパターンを使うべきか迷いが生じている。

**独立テスト**: AppError重複の削除はコンパイルエラーの有無で即座に検証可能。
エラーレスポンスにIPアドレスが含まれないことを統合テストで確認できる。

**受け入れシナリオ**:

1. **前提** `api/models.rs`にAppErrorの重複定義がある、
   **実行** 重複を削除し`api/error.rs`の定義に統一する、
   **結果** 全APIハンドラーが`external_message()`経由の安全なレスポンスを返す
2. **前提** 52箇所にインラインErrorResponse構築がある、
   **実行** すべてをAppError返却に統一する、
   **結果** APIハンドラーのエラー返却が1パターンのみになる

---

### ユーザーストーリー3 - クラウドプロバイダの拡張容易化 (優先度: P1)

開発者として、新しいクラウドプロバイダ（例: Azure OpenAI、Cohere等）を追加する際に、
共通のインターフェースを実装するだけで完了するようにしたい。
現在、OpenAI/Google/Anthropicの3つのプロキシ関数がそれぞれ800行前後で
ほぼ同一の構造を持っており、新規追加時に大量のコピー＆ペーストが必要となっている。

**この優先度の理由**: 今後のプロバイダ追加のたびにコードの重複が増加し、
メンテナンスコストが膨らむ。共通インターフェースの導入はこれを根本的に解決する。

**独立テスト**: 既存の3プロバイダ（OpenAI/Google/Anthropic）への
プロキシリクエストが従来と同一のレスポンスを返すことで検証可能。

**受け入れシナリオ**:

1. **前提** 3つの類似したプロキシ関数（各800行前後）がopenai.rsに同居している、
   **実行** 共通インターフェースを定義し、各プロバイダが実装する、
   **結果** プロバイダ追加時にインターフェース実装のみで完了し、
   プロキシ本体を修正する必要がない
2. **前提** `api/openai.rs`が2,659行ある、
   **実行** プロバイダプロキシ・ユーティリティ・テストを分離する、
   **結果** 各ファイルが500行以内に収まり、単一責任の原則を満たす

---

### ユーザーストーリー4 - 認証フローの簡素化 (優先度: P1)

開発者として、デバッグビルドでも正規の認証フローを通す設計で作業したい。
`auth_disabled`フラグによる条件分岐が16箇所に散在しており、
認証の挙動がビルドモードによって異なることがデバッグ上の混乱を生んでいる。

**この優先度の理由**: CLAUDE.mdの開発モード認証方針（認証チェックをスキップする
フラグは禁止）と合致する変更であり、ルーター構築の大幅な簡素化につながる。

**独立テスト**: `auth_disabled`フラグの全削除後、デバッグビルドで
`admin`/`test`認証情報を使用したログインが成功することで検証可能。

**受け入れシナリオ**:

1. **前提** `create_app()`内に`auth_disabled`分岐が16箇所ある、
   **実行** `auth_disabled`モードを廃止し、デバッグビルドでは
   `#[cfg(debug_assertions)]`で認証情報を内部生成する、
   **結果** 16箇所の条件分岐が消滅し、全ルートが同一の認証フローを通る
2. **前提** 認証レイヤー適用コードが繰り返されている、
   **実行** ヘルパー関数に抽出する、
   **結果** ルート定義が宣言的で読みやすくなる

---

### ユーザーストーリー5 - リクエスト履歴記録の簡素化 (優先度: P1)

開発者として、リクエスト履歴の記録処理で15箇所以上のボイラープレートを書かずに、
簡潔なファクトリ呼び出しで記録を作成したい。また、レコードのフィールド名が
実態（エンドポイント）と一致していてほしい。

**この優先度の理由**: RequestResponseRecordの手動構築は最も頻繁に繰り返される
コード重複であり、フィールド名のレガシー命名（node_）が開発者を混乱させている。

**独立テスト**: ファクトリ関数を使ったレコード作成が全テストで正しく動作し、
DB migrationが既存データを正しく変換することで検証可能。

**受け入れシナリオ**:

1. **前提** RequestResponseRecordの手動構築が15箇所以上にある、
   **実行** エラー記録用・成功記録用のファクトリ関数を導入する、
   **結果** 全構築箇所がファクトリ呼び出しに置き換わる
2. **前提** `node_id`/`node_machine_name`/`node_ip`フィールドが存在する、
   **実行** `endpoint_id`/`endpoint_name`/`endpoint_ip`にリネームし、
   DB migrationでカラム名も変更する、
   **結果** DB上のカラム名とRust構造体のフィールド名が一致する

---

### ユーザーストーリー6 - DB操作のテスタビリティ向上 (優先度: P2)

開発者として、DB操作が抽象化されており、テスト時にモック実装に差し替え可能な
状態にしたい。現在、テスト用DBセットアップのボイラープレートが15箇所以上に
重複しており、テスト作成のハードルとなっている。

**この優先度の理由**: Repository化はテスト品質を根本的に改善し、
テスト作成の摩擦を下げる。ただし、型基盤とエラー統一が先行する必要がある。

**独立テスト**: Repository traitのモック実装を使ったユニットテストが
インメモリDB不要で実行できることで検証可能。

**受け入れシナリオ**:

1. **前提** DB操作がSQLxクエリとして各所に散在している、
   **実行** Repository traitでDB操作を抽象化する、
   **結果** テスト時にモック実装への差し替えが可能になる
2. **前提** テスト用DBセットアップが15箇所以上で重複している、
   **実行** テストユーティリティでビルダーパターンを提供する、
   **結果** テスト作成時にカスタマイズ可能な共通ヘルパーが使える

---

### ユーザーストーリー7 - エントリポイントとバランサーの可読性向上 (優先度: P2)

開発者として、`main.rs`がエントリポイントとしての最小限の責任のみを持ち、
バランサーモジュールのファイルが論理的に分割された状態で開発したい。

**この優先度の理由**: main.rs（928行）にマイグレーション互換コードや
初期化ロジックが混在しており、アプリケーションの起動フローの理解を妨げている。
balancer/mod.rs（2,187行）も型定義とロジックが同居して可読性が低い。

**独立テスト**: 分割後に全テストスイートが通過し、サーバーが正常に起動・応答
することで検証可能。

**受け入れシナリオ**:

1. **前提** `main.rs`にチェックサム互換コード約140行がある、
   **実行** 互換コードを削除する、
   **結果** sqlx標準のマイグレーション処理のみが残る
2. **前提** `main.rs`に`run_server()`と初期化ロジックが同居している、
   **実行** `server.rs`と`bootstrap.rs`に分離する、
   **結果** `main.rs`がエントリポイントのみの役割になる
3. **前提** `balancer/mod.rs`に型定義・リース・ロジックが混在している、
   **実行** `types.rs`・`lease.rs`・`mod.rs`にファイル分割する、
   **結果** 各ファイルが単一の関心事を持つ

---

### ユーザーストーリー8 - Dashboard開発体験の改善 (優先度: P2)

Dashboard開発者として、APIクライアントがドメインごとに分割され、
Playgroundの共通基盤が提供された状態でUI機能を追加したい。
現在、`lib/api.ts`が1,027行・9つのAPIオブジェクトを抱えており、
PlaygroundコンポーネントはMessage型やストリーミングロジックが重複している。

**この優先度の理由**: Dashboard UIの開発頻度は高く、API分割と
共通基盤の整備は継続的な開発効率に直結する。

**独立テスト**: ダッシュボードのビルドが成功し、既存のE2Eテストが
全て通過することで検証可能。

**受け入れシナリオ**:

1. **前提** `lib/api.ts`に9つのAPIオブジェクトと30+型定義がある、
   **実行** ドメインごとのファイルに分割する、
   **結果** 各APIファイルが単一ドメインの責任を持つ
2. **前提** LoadBalancerPlaygroundとEndpointPlaygroundで
   Message型・ストリーミングロジック・UIが重複している、
   **実行** 共通基盤コンポーネントとフックを抽出する、
   **結果** 両Playgroundが共通基盤を使用し、差分のみを実装する

---

### エッジケース

- DB migrationでカラムリネーム時に、既存データのnull値はどう扱うか?
  → node_id等のカラムはNOT NULL制約があるため、単純なALTER TABLE RENAMEで対応可能
- auth_disabled廃止後、CI環境でのテストはどうなるか?
  → デバッグビルドの`#[cfg(debug_assertions)]`で認証情報が自動生成されるため、
  CI環境は従来と同じ挙動を維持する
- CloudProvider trait化後、ストリーミングレスポンスの挙動差異はどう吸収するか?
  → トレイトのメソッドでストリーム変換関数を定義し、プロバイダごとの差異を吸収する
- チェックサム互換コード削除後、旧バージョンからのアップグレードはどうなるか?
  → メジャーバージョンアップとして、旧バージョンからの直接アップグレードは
  サポート対象外とする（リリースノートに明記）
- Repository trait化によるパフォーマンスオーバーヘッドはないか?
  → 動的ディスパッチ（dyn trait）を使用する場合のオーバーヘッドは無視できるレベル。
  必要に応じてジェネリクスで静的ディスパッチも選択可能

## 要件 *(必須)*

### 機能要件

**型基盤（Phase 1）:**

- **FR-001**: `common/types.rs`の全型定義が`types/`モジュール配下に移動される必要がある
- **FR-002**: `GpuDeviceInfo`と`GpuDevice`が単一の型に統一される必要がある
- **FR-003**: `HealthMetrics`/`Request`/`RequestStatus`のレガシーフィールド名が
  「エンドポイント」用語にリネームされる必要がある
- **FR-004**: `common/`モジュールには`protocol.rs`と`error.rs`のみが残る必要がある

**エラー基盤（Phase 2）:**

- **FR-005**: `api/models.rs`のAppError重複定義が削除され、
  `api/error.rs`の定義に統一される必要がある
- **FR-006**: 全APIハンドラーがAppErrorを返却する必要がある
  （52箇所のインラインErrorResponseを含む）
- **FR-007**: APIエラーレスポンスに内部IPアドレス等の機密情報が
  含まれない必要がある

**API層（Phase 3）:**

- **FR-008**: クラウドプロバイダプロキシが共通インターフェースで
  統一される必要がある
- **FR-009**: `api/openai.rs`が責任ごとのファイルに分割される必要がある
- **FR-010**: `auth_disabled`フラグが廃止され、デバッグビルドでは
  `#[cfg(debug_assertions)]`で認証情報が提供される必要がある
- **FR-011**: ルーター構築の認証レイヤー適用が共通ヘルパーで
  宣言的に記述される必要がある
- **FR-012**: RequestResponseRecordの構築にファクトリ関数が
  使用される必要がある

**DB層（Phase 4）:**

- **FR-013**: DB操作がRepository traitで抽象化される必要がある
- **FR-014**: DB上の`node_`プレフィクスカラムが`endpoint_`に
  リネームされる必要がある（migration経由）
- **FR-015**: コードベース全体の「ノード」レガシー命名が
  「エンドポイント」に統一される必要がある

**バランサー（Phase 5）:**

- **FR-016**: `balancer/mod.rs`が`types.rs`・`lease.rs`・`mod.rs`に
  ファイル分割される必要がある
- **FR-017**: LoadManager structの公開インターフェースは維持される必要がある

**エントリポイント（Phase 6）:**

- **FR-018**: main.rsのマイグレーションチェックサム互換コードが
  削除される必要がある
- **FR-019**: サーバー起動ロジックと初期化ロジックが
  適切なモジュールに分離される必要がある

**テスト基盤（Phase 7）:**

- **FR-020**: テスト用AppState構築にビルダーパターンが使用される必要がある
- **FR-021**: テスト用DB poolの取得が共通ユーティリティで
  提供される必要がある
- **FR-022**: `create_local_state()`の重複定義が解消される必要がある

**Dashboard（Phase 8）:**

- **FR-023**: `lib/api.ts`がドメインごとのファイルに分割される必要がある
- **FR-024**: Playground共通基盤コンポーネントが提供される必要がある
- **FR-025**: LoadBalancerPlaygroundとEndpointPlayground間の
  型・ロジック重複が解消される必要がある

**仕上げ（Phase 9）:**

- **FR-026**: 全品質チェック（fmt/clippy/test/markdownlint）が通過する必要がある
- **FR-027**: 破壊的変更がドキュメントに明記される必要がある

### 主要エンティティ

- **Endpoint（旧Node）**: llmlbが管理する推論サービスの接続先。
  ID・名前・IPアドレス・種別・ヘルスステータスを持つ。
  リネーム対象のコアエンティティ。
- **RequestResponseRecord**: API呼び出しの履歴記録。
  リクエスト元・転送先エンドポイント・レスポンス・計測値を保持。
  ファクトリ関数とフィールドリネームの対象。
- **AppError**: API層の統一エラー型。LbErrorをラップし、
  外部向けにはサニタイズされたメッセージのみを返す。
- **CloudProvider**: クラウドプロバイダプロキシの共通インターフェース。
  ヘッダー変換・ペイロード変換・エラーマッピングを抽象化する。
- **Repository**: DB操作の抽象インターフェース。
  テスト時にモック実装への差し替えを可能にする。

## 成功基準 *(必須)*

### 測定可能な結果

- **SC-001**: コードベースに`node_id`/`node_name`/`node_ip`（変数名・フィールド名）
  がゼロになる（grep検索で確認）
- **SC-002**: AppErrorの定義が1箇所のみになり、APIエラーレスポンスに
  内部IPが含まれないことをテストで検証
- **SC-003**: `api/openai.rs`が500行以内のファイル群に分割され、
  新規クラウドプロバイダの追加がインターフェース実装のみで完了する
- **SC-004**: `auth_disabled`フラグの使用がコードベースからゼロになる
- **SC-005**: RequestResponseRecordの手動構築がゼロになり、
  全てファクトリ関数経由になる
- **SC-006**: テスト用DB poolとAppState構築の重複定義がゼロになる
- **SC-007**: `main.rs`が200行以内になる
- **SC-008**: ダッシュボードのPlayground間でMessage型・
  ストリーミングロジックの重複がゼロになる
- **SC-009**: 全265テストが通過し、品質チェック（fmt/clippy/test/markdownlint）
  がゼロエラーで完了する
- **SC-010**: SemVerリリースフローの`feat!:`によるメジャーバージョンアップとして
  正しくタグ付けされる
