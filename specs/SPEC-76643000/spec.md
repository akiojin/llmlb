# 機能仕様書: エンドポイント単位リクエスト統計

**機能ID**: `SPEC-76643000`
**作成日**: 2026-02-10
**ステータス**: 下書き
**入力**: ダッシュボードでエンドポイント単位のリクエスト数・成功率・エラー率を確認可能にする

## ユーザーシナリオ＆テスト

### ユーザーストーリー1 - エンドポイント一覧でリクエスト数を確認する (優先度: P1)

管理者として、エンドポイント一覧テーブルで各エンドポイントの累計リクエスト数と
成功率を一目で確認したい。
障害が発生しているエンドポイントを素早く特定し、対処の優先度を判断するため。

**この優先度の理由**: 一覧画面は管理者が最も頻繁に目にする画面であり、
全エンドポイントの健全性を瞬時に比較できることが運用上最も価値が高い。

**独立テスト**: エンドポイント一覧テーブルにRequestsカラムが存在し、
リクエスト数と成功率が正しく表示されることを確認するだけで完全にテスト可能。
これだけで「どのエンドポイントに問題があるか」を一目で把握する価値を提供する。

**受け入れシナリオ**:

1. **前提** エンドポイントAに100件の成功リクエストと5件の失敗リクエストがある、
   **実行** ダッシュボードのエンドポイント一覧を表示する、
   **結果** Requestsカラムに「105 (95.2%)」と表示される
2. **前提** エンドポイントBのエラー率が8%である、
   **実行** ダッシュボードのエンドポイント一覧を表示する、
   **結果** Requestsカラムの成功率が黄色（警告）でハイライトされる
3. **前提** エンドポイントCのエラー率が25%である、
   **実行** ダッシュボードのエンドポイント一覧を表示する、
   **結果** Requestsカラムの成功率が赤色（危険）でハイライトされる
4. **前提** エンドポイント一覧が表示されている、
   **実行** Requestsカラムのヘッダーをクリックする、
   **結果** リクエスト数の昇順/降順でソートされる

---

### ユーザーストーリー2 - リクエスト数の永続的な記録 (優先度: P1)

管理者として、各エンドポイントのリクエスト数が永続的に保存されてほしい。
リクエスト履歴の保持期間（デフォルト7日）に関わらず、長期的な利用統計を
追跡するため。

**この優先度の理由**: データの永続化はすべての表示機能の基盤となるため、
最優先で実装する必要がある。永続化なしには他のストーリーが成立しない。

**独立テスト**: リクエスト送信後にエンドポイントのカウンタが正しく増加し、
リクエスト履歴がクリーンアップされた後もカウンタが維持されることを確認する。

**受け入れシナリオ**:

1. **前提** エンドポイントAのリクエスト数が0件である、
   **実行** エンドポイントAに成功リクエストを3件送信する、
   **結果** エンドポイントAの累計リクエスト数が3、成功数が3、失敗数が0になる
2. **前提** エンドポイントAのリクエスト数が100件である、
   **実行** リクエスト履歴の自動クリーンアップが実行される、
   **結果** エンドポイントAの累計リクエスト数は100のまま減らない
3. **前提** エンドポイントAに対してモデルXで5件、モデルYで3件のリクエストがある、
   **実行** 日次集計データを確認する、
   **結果** エンドポイントA×モデルXで5件、エンドポイントA×モデルYで3件が記録される
4. **前提** 日付が変わりサーバーのローカル時間が0:00になった、
   **実行** 日次バッチ集計が実行される、
   **結果** 前日分の日次集計データが確定保存される

---

### ユーザーストーリー3 - エンドポイント詳細で統計カードを確認する (優先度: P2)

管理者として、エンドポイント詳細モーダルで累計リクエスト数・今日のリクエスト数・
成功率・平均レスポンス時間を数値カードとして確認したい。
個別エンドポイントのパフォーマンスを定量的に評価するため。

**この優先度の理由**: 一覧で異常を検知した後、詳細を掘り下げる次のアクション
として不可欠。一覧の情報だけでは判断できない場面で追加の判断材料を提供する。

**独立テスト**: エンドポイント詳細モーダルを開き、4枚の数値カードが正しい値で
表示されることを確認するだけでテスト可能。

**受け入れシナリオ**:

1. **前提** エンドポイントAの累計が500件・今日が20件・成功率97%・
   平均レスポンス150msである、
   **実行** エンドポイントAの詳細モーダルを開く、
   **結果** 4枚のカードにそれぞれ「500」「20」「97.0%」「150ms」と表示される
2. **前提** エンドポイントBの成功率が93%（エラー率7%）である、
   **実行** エンドポイントBの詳細モーダルを開く、
   **結果** 成功率カードが黄色（警告色）で表示される
3. **前提** エンドポイントCの成功率が78%（エラー率22%）である、
   **実行** エンドポイントCの詳細モーダルを開く、
   **結果** 成功率カードが赤色（危険色）で表示される

---

### ユーザーストーリー4 - 日次トレンドチャートで利用傾向を把握する (優先度: P2)

管理者として、エンドポイント詳細モーダルで日次リクエスト数の推移を
チャートで確認したい。利用傾向の変化やスパイク/ドロップを視覚的に
把握するため。

**この優先度の理由**: 数値カードが「現在の状態」を示すのに対し、
チャートは「傾向」を示す。両者が揃うことで運用判断の精度が大幅に向上する。

**独立テスト**: エンドポイント詳細モーダルのチャートセクションで、
積み上げ棒グラフが正しいデータで描画されることを確認する。

**受け入れシナリオ**:

1. **前提** エンドポイントAに過去7日分の日次集計データがある、
   **実行** エンドポイントAの詳細モーダルを開く、
   **結果** 成功（緑）と失敗（赤）の積み上げ棒グラフが7日分表示される
2. **前提** チャートがデフォルト（7日）表示されている、
   **実行** 「30日」タブをクリックする、
   **結果** 表示期間が過去30日間に切り替わる
3. **前提** チャートが表示されている、
   **実行** 「90日」タブをクリックする、
   **結果** 表示期間が過去90日間に切り替わる
4. **前提** エンドポイントAにまだ日次集計データがない（新規登録直後）、
   **実行** エンドポイントAの詳細モーダルを開く、
   **結果** チャートエリアに「データがありません」等の適切なメッセージが表示される

---

### ユーザーストーリー5 - モデル別リクエスト内訳を確認する (優先度: P3)

管理者として、エンドポイント詳細モーダルでモデル別のリクエスト数内訳を
確認したい。どのモデルが最も使われているか、どのモデルでエラーが多いかを
把握するため。

**この優先度の理由**: モデル別の内訳は高度な分析機能であり、基本的な統計表示
（P1/P2）が完成した上での付加価値。ただし日次集計テーブルの設計にモデル粒度を
含めるため、データ基盤はP1で整備済みとなる。

**独立テスト**: エンドポイント詳細モーダルのモデル別テーブルに、
各モデルのリクエスト数と成功/失敗の内訳が正しく表示されることを確認する。

**受け入れシナリオ**:

1. **前提** エンドポイントAでモデルXに200件（成功190/失敗10）、
   モデルYに50件（成功50/失敗0）のリクエストがある、
   **実行** エンドポイントAの詳細モーダルを開く、
   **結果** モデル別テーブルにモデルXが200件（成功190/失敗10）、
   モデルYが50件（成功50/失敗0）と表示される
2. **前提** エンドポイントAにモデルが3つ登録されているがリクエストは1つもない、
   **実行** エンドポイントAの詳細モーダルを開く、
   **結果** モデル別テーブルは空またはすべて0件で表示される

---

### エッジケース

- リクエスト数が0件のエンドポイントではエラー率をどう表示するか?
  → 成功率は「-」（ハイフン）で表示し、ハイライトなし
- エンドポイントが削除された場合、日次集計データはどうなるか?
  → 削除されたエンドポイントの集計データは保持される（孤児データ許容）
- 同時に多数のリクエストが処理された場合のカウンタ整合性は?
  → リアルタイムカウンタはアトミックな更新で整合性を保証する
- 日次バッチ実行中（0:00前後）のリクエストはどちらの日に計上されるか?
  → リクエスト完了時のサーバーローカル日付に基づいて計上される
- 日次集計テーブルが肥大化した場合の対策は?
  → 当面は保持期限を設けない。将来的に必要に応じて別SPECで対応
- 非常に大きなリクエスト数（数百万件超）の表示フォーマットは?
  → 数値はカンマ区切り（例: 1,234,567）で表示

## 要件

### 機能要件

- **FR-001**: システムはエンドポイントごとの累計リクエスト数（合計・成功・失敗）
  を永続的に記録する必要がある
- **FR-002**: システムはリクエスト処理完了時にリアルタイムでカウンタを更新する
  必要がある
- **FR-003**: システムはエンドポイント×モデル×日付の粒度で日次集計データを
  永続的に保存する必要がある
- **FR-004**: システムはサーバーローカル時間0:00に日次バッチ集計を実行し、
  前日分のデータを確定する必要がある
- **FR-005**: エンドポイント一覧テーブルにRequestsカラムを追加し、
  累計リクエスト数と成功率を「N (XX.X%)」形式で表示する必要がある
- **FR-006**: エラー率が5%以上のエンドポイントは黄色（警告）、
  20%以上は赤色（危険）でハイライト表示する必要がある
- **FR-007**: Requestsカラムはリクエスト数による昇順/降順ソートに対応する
  必要がある
- **FR-008**: エンドポイント詳細モーダルに累計リクエスト数・今日のリクエスト数・
  成功率・平均レスポンス時間の4枚の数値カードを表示する必要がある
- **FR-009**: エンドポイント詳細モーダルに成功/失敗の日次積み上げ棒グラフを
  表示する必要がある
- **FR-010**: 日次チャートは7日/30日/90日の表示期間をタブで切り替えられる
  必要がある
- **FR-011**: エンドポイント詳細モーダルにモデル別リクエスト数の内訳テーブルを
  表示する必要がある
- **FR-012**: エンドポイント削除時、日次集計データは削除せず保持する必要がある
- **FR-013**: リクエスト履歴の自動クリーンアップ（デフォルト7日）がカウンタ値に
  影響を与えてはならない
- **FR-014**: バックフィルは行わず、機能導入後のリクエストからゼロスタートとする

### 主要エンティティ

- **エンドポイントリクエストカウンタ**: エンドポイントに紐づく累計リクエスト数。
  合計・成功数・失敗数の3つのカウンタで構成される。リクエスト履歴の保持期間に
  依存せず永続的に保存される
- **日次集計レコード**: エンドポイント×モデル×日付の粒度で集計された
  リクエスト統計。合計数・成功数・失敗数を持つ。永続的に保存され、
  トレンド分析とモデル別分析の基盤となる

## 成功基準

### 測定可能な結果

- **SC-001**: 管理者がエンドポイント一覧を見るだけで、エラー率が高い
  エンドポイントを3秒以内に特定できる
- **SC-002**: エンドポイント詳細モーダルで、過去7日間のリクエスト傾向を
  チャートとして確認できる
- **SC-003**: リクエスト数の永続カウンタがリクエスト履歴のクリーンアップに
  影響されないことが検証可能である
- **SC-004**: エンドポイント×モデルの粒度で日次リクエスト数が記録され、
  モデル別の利用傾向を把握できる
- **SC-005**: 日次チャートの表示期間切替（7/30/90日）が1秒以内に完了する
