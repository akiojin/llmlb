# 機能仕様書: llmlb serveコマンドのシングル実行制約

**機能ID**: `SPEC-787a0b27`
**作成日**: 2026-01-30
**ステータス**: 下書き
**入力**: ユーザー説明: "llmlb serveコマンドのシングル実行制約機能"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 重複起動の防止 (優先度: P1)

運用者として、同一ポートで複数のllmlbサーバーが起動することを防ぎたい。
これにより、ポート競合やデータ破損、予期しない動作を回避できる。

**この優先度の理由**: シングル実行制約の中核機能であり、
これがなければ複数インスタンスが同時に起動し、システムの安定性が損なわれる。

**独立テスト**: 同一ポートで2つ目のserveコマンドを実行し、
即座にエラー終了（終了コード1）することで検証可能。

**受け入れシナリオ**:

1. **前提** llmlbが起動していない状態、
   **実行** `llmlb serve --port 8000`を実行、
   **結果** サーバーが正常に起動し、ロックが取得される
2. **前提** ポート8000でllmlbが起動中、
   **実行** 別ターミナルで`llmlb serve --port 8000`を実行、
   **結果** エラーメッセージが表示され、終了コード1で即座に終了する
3. **前提** ポート8000でllmlbが起動中、
   **実行** `llmlb serve --port 9000`を実行、
   **結果** 異なるポートのため正常に起動できる

---

### ユーザーストーリー2 - 既存プロセスの停止 (優先度: P1)

運用者として、起動中のllmlbサーバーをコマンドで停止したい。
これにより、プロセスIDを調べてkillする手間が省ける。

**この優先度の理由**: シングル実行制約と連携する重要な運用機能。
ロックファイルからPIDを読み取り、安全に停止できる。

**独立テスト**: 起動中のサーバーに対して`llmlb stop`を実行し、
グレースフルシャットダウンとロック解除を確認できる。

**受け入れシナリオ**:

1. **前提** ポート8000でllmlbが起動中、
   **実行** `llmlb stop --port 8000`を実行、
   **結果** サーバーがグレースフルシャットダウンし、ロックが解除される
2. **前提** llmlbが起動していない状態、
   **実行** `llmlb stop --port 8000`を実行、
   **結果** 「起動中のサーバーがありません」というメッセージが表示される

---

### ユーザーストーリー3 - サーバー状態の確認 (優先度: P2)

運用者として、現在起動中のllmlbサーバーの状態を確認したい。
これにより、どのポートでサーバーが動作しているか、いつ起動したかを把握できる。

**この優先度の理由**: 運用監視に必要な補助機能。
ロック状態の確認により、問題発生時のトラブルシューティングが容易になる。

**独立テスト**: `llmlb status`を実行し、
起動中のサーバー情報（PID、起動時刻、ポート）が表示されることで検証可能。

**受け入れシナリオ**:

1. **前提** ポート8000でllmlbが起動中、
   **実行** `llmlb status`を実行、
   **結果** PID、起動時刻、ポート番号が表示される
2. **前提** llmlbが起動していない状態、
   **実行** `llmlb status`を実行、
   **結果** 「起動中のサーバーはありません」と表示される

---

### ユーザーストーリー4 - クラッシュ後の自動復旧 (優先度: P2)

運用者として、サーバーがクラッシュした後でも新しいサーバーを起動できるようにしたい。
クラッシュによりロックファイルが残留しても、システムが自動的に検出して復旧できる。

**この優先度の理由**: システムの可用性を確保するために重要。
手動でのロックファイル削除を不要にする。

**独立テスト**: プロセスを強制終了（kill -9）した後、
新しいサーバーを起動できることで検証可能。

**受け入れシナリオ**:

1. **前提** llmlbがクラッシュしてロックファイルが残留している状態、
   **実行** `llmlb serve --port 8000`を実行、
   **結果** 残留ロックのPIDが存在しないことを検出し、ロックを取得して起動する

---

### ユーザーストーリー5 - グレースフルシャットダウン (優先度: P2)

運用者として、SIGTERMやSIGINTを送信した際にサーバーが安全に終了することを期待する。
終了時にはロックが確実に解除され、次回起動時に問題が発生しない。

**この優先度の理由**: 運用の安全性を確保するために必要。
シグナル受信時のクリーンアップが不完全だと、ロック残留の原因となる。

**独立テスト**: Ctrl+CまたはSIGTERMを送信し、
サーバーが正常終了してロックファイルが削除されることで検証可能。

**受け入れシナリオ**:

1. **前提** llmlbが起動中、
   **実行** Ctrl+Cを押す、
   **結果** サーバーがグレースフルシャットダウンし、ロックファイルが削除される
2. **前提** llmlbが起動中、
   **実行** `kill -TERM <pid>`を実行、
   **結果** サーバーがグレースフルシャットダウンし、ロックファイルが削除される

---

### エッジケース

- 同一マシン上で異なるユーザーが同じポートでserveを起動した場合、どう処理するか?
  → OSのポートバインドで拒否されるため、ロック以前にエラーとなる
- ロックファイルのあるディレクトリへの書き込み権限がない場合、どう処理するか?
  → 明確なエラーメッセージを表示して終了する
- NFSなどのネットワークファイルシステム上でロックを使用する場合、どう処理するか?
  → fcntlベースのロックを使用してNFS対応を実現する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは同一ポート番号でのserveコマンドの重複起動を検知して拒否する必要がある
- **FR-002**: システムは重複起動検知時に既存プロセスのPID、起動時刻、
  停止方法のヒントを含むエラーメッセージを表示する必要がある
- **FR-003**: システムは重複起動検知時に終了コード1で即座に終了する必要がある
- **FR-004**: システムはサーバー起動時にロックを取得し、
  ロック取得/解除をdebugレベルでログ出力する必要がある
- **FR-005**: システムはSIGTERM/SIGINT受信時にグレースフルシャットダウンし、
  ロックを解除する必要がある
- **FR-006**: システムはクラッシュ後の残留ロックを検出し、
  PID検証により自動解除する必要がある
- **FR-007**: `llmlb stop --port <port>`コマンドは対象ポートのサーバーを停止する必要がある
- **FR-008**: `llmlb status`コマンドは起動中のサーバー情報を表示する必要がある
- **FR-009**: ロックファイルはJSON形式（PID、起動時刻、ポート）で保存される必要がある
- **FR-010**: ロックファイルのパーミッションは600（オーナーのみ読み書き可能）である必要がある
- **FR-011**: システムはmacOS、Linux、Windowsで動作する必要がある

### 主要エンティティ

- **ロックファイル**: サーバーインスタンスの排他制御情報を保持。
  PID、起動時刻、ポート番号を含むJSON形式のファイル
- **サーバーインスタンス**: 特定のポートで動作するllmlbサーバー。
  起動時にロックを取得し、終了時に解除する

## 成功基準 *(必須)*

### 測定可能な結果

- **SC-001**: 同一ポートでの2つ目のserve起動は100%検知され、即座にエラー終了する
- **SC-002**: クラッシュ後の残留ロックは100%自動解除され、新規起動が可能となる
- **SC-003**: SIGTERM/SIGINT受信時は100%グレースフルシャットダウンが実行される
- **SC-004**: エラーメッセージにはPID、起動時刻、停止方法のヒントが必ず含まれる
- **SC-005**: macOS、Linux、Windowsの全プラットフォームでロック機能が正常に動作する
