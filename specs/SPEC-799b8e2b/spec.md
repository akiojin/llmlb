# 共通ログシステム

## 概要

Router（Rust）とNode（C++）で統一された構造化ログシステムを提供する。
ログは標準出力（人間が読みやすい形式）とファイル（JSONL形式）の両方に出力する。

## ビジネス価値

- 運用時のトラブルシューティングを容易にする
- ログの一元管理により、システム全体の状態を把握しやすくする
- 構造化ログにより、ログ解析ツールとの連携を容易にする

## ユーザーストーリー

### US-1: 運用者としてログファイルを確認したい

運用者として、`~/.llm-router/logs/`配下のログファイルを確認することで、
RouterとNodeの動作状況を把握できる。

**受け入れ条件**:

- Routerのログは`llm-router.jsonl.YYYY-MM-DD`形式でファイル出力される
- Nodeのログは`llm-node.jsonl.YYYY-MM-DD`形式でファイル出力される
- 標準出力にも人間が読みやすい形式でログが出力される
- ファイル出力はJSONL形式で構造化されている

### US-2: 運用者として古いログが自動削除されることを期待する

運用者として、ログファイルが無限に増加しないよう、
7日経過したログファイルが自動的に削除される。

**受け入れ条件**:

- 7日より古いログファイルは起動時に自動削除される
- 保持日数は環境変数で変更可能

### US-3: 開発者としてログカテゴリで絞り込みたい

開発者として、ログをカテゴリで絞り込むことで、
特定の機能に関するログのみを確認できる。

**受け入れ条件**:

- 各ログエントリにカテゴリが含まれる
- カテゴリは`system`/`api`/`model`/`inference`/`sync`/`repair`/`health`のいずれか

## 機能要件

### FR-1: ログ出力先

- ファイル出力ディレクトリ: `~/.llm-router/logs/`
- Routerファイル名: `llm-router.jsonl.YYYY-MM-DD`
- Nodeファイル名: `llm-node.jsonl.YYYY-MM-DD`
- 標準出力: 人間が読みやすいテキスト形式で出力

### FR-2: ログ形式

JSONL形式で以下のフィールドを含む:

```json
{"ts":"2025-11-28T12:00:00.000Z","level":"info","category":"api","msg":"Request received"}
```

必須フィールド:

- `ts`: ISO 8601形式のタイムスタンプ
- `level`: `trace`/`debug`/`info`/`warn`/`error`のいずれか
- `category`: ログカテゴリ
- `msg`: ログメッセージ

オプションフィールド:

- 追加のコンテキスト情報（リクエストID、モデル名など）

### FR-3: ログローテーション

- 日付単位でファイルを分割
- 7日間保持（デフォルト）
- 起動時に古いファイルを削除

### FR-4: 環境変数による設定

| 変数名 | 説明 | デフォルト値 |
|--------|------|-------------|
| `LLM_LOG_DIR` | ログディレクトリ | `~/.llm-router/logs` |
| `LLM_LOG_LEVEL` | ログレベル | `info` |
| `LLM_LOG_RETENTION_DAYS` | 保持日数 | `7` |

### FR-5: ログカテゴリ

| カテゴリ | 説明 |
|----------|------|
| `system` | 起動/終了/設定 |
| `api` | HTTPリクエスト/レスポンス |
| `model` | モデルロード/アンロード |
| `inference` | 推論処理 |
| `sync` | モデル同期 |
| `repair` | 自動修復 |
| `health` | ヘルスチェック/ハートビート |

## 非機能要件

### NFR-1: 既存APIとの互換性

- 既存のログ出力API（`tracing::info!`、`spdlog::info`等）はそのまま使用可能
- ログ取得エンドポイントは `/v0/logs` に統一する

### NFR-2: パフォーマンス

- ログ出力がアプリケーションのパフォーマンスに影響を与えない
- 非同期書き込みを使用

## スコープ外

- ログ収集サーバーへの送信
- ログ圧縮
- リモートログ設定

---

## Clarifications

### Session 2025-12-24

仕様を精査した結果、重大な曖昧さは検出されませんでした。

**確認済み事項**:

- ログディレクトリ: ~/.llm-router/logs/（FR-1で明記）
- ログ形式: JSONL（FR-2で明記）
- 必須フィールド: ts, level, category, msg（FR-2で明記）
- ログレベル: trace/debug/info/warn/error（FR-2で明記）
- カテゴリ: system/api/model/inference/sync/repair/health（FR-5で明記）
- ローテーション: 日付単位、7日保持（FR-3で明記）

**環境変数の確認**:

- LLM_LOG_DIR: ログディレクトリ
- LLM_LOG_LEVEL: ログレベル
- LLM_LOG_RETENTION_DAYS: 保持日数

**依存関係の確認**:

- SPEC-1970e39f（構造化ロギング強化）と連携
