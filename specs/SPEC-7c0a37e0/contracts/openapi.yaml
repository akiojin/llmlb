openapi: 3.0.3
info:
  title: API Key Permissions
  version: 2.0.0
  description: APIキー（permissions）管理API

paths:
  /api/api-keys:
    get:
      summary: APIキー一覧取得
      operationId: listApiKeys
      description: |
        Requires JWT (admin) or an API key with `api_keys.manage`.
      security:
        - JwtAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListApiKeysResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      summary: APIキー発行
      operationId: createApiKey
      description: |
        Requires JWT (admin) or an API key with `api_keys.manage`.

        Notes:
        - `permissions` is required and must be non-empty.
        - Legacy `scopes` is deprecated and rejected (400).
      security:
        - JwtAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
      responses:
        '201':
          description: 発行成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateApiKeyResponse'
        '400':
          description: リクエスト不正
          content:
            text/plain:
              schema:
                type: string
                example: "Permissions are required"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/api-keys/{id}:
    put:
      summary: APIキー更新
      operationId: updateApiKey
      description: |
        Requires JWT (admin) or an API key with `api_keys.manage`.
      security:
        - JwtAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateApiKeyRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyInfo'
        '400':
          description: リクエスト不正
          content:
            text/plain:
              schema:
                type: string
                example: "Invalid expires_at format"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: APIキーが見つからない

    delete:
      summary: APIキー削除
      operationId: deleteApiKey
      description: |
        Requires JWT (admin) or an API key with `api_keys.manage`.
      security:
        - JwtAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: 削除成功
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: APIキーが見つからない

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        API key (sk_...).
        Alternatively, clients may send `Authorization: Bearer sk_...`.

    JwtAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT認証（Authorization: Bearer <jwt> または Cookie）

  schemas:
    ApiKeyPermission:
      type: string
      description: |
        API key permissions (string IDs).
      enum:
        - openai.inference
        - openai.models.read
        - endpoints.read
        - endpoints.manage
        - api_keys.manage
        - users.manage
        - invitations.manage
        - models.manage
        - registry.read
        - logs.read
        - metrics.read

    CreateApiKeyRequest:
      type: object
      required:
        - name
        - permissions
      properties:
        name:
          type: string
          description: APIキー名
          example: "my-client"
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: 有効期限（RFC3339、未指定なら無期限）
          example: "2026-12-31T23:59:59Z"
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/ApiKeyPermission'
          minItems: 1
          description: 付与する権限（複数選択）
          example: ["openai.inference", "openai.models.read"]

    UpdateApiKeyRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: APIキー名
          example: "my-client"
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: 有効期限（RFC3339、nullで無期限）
          example: "2026-12-31T23:59:59Z"

    ApiKeyInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        key_prefix:
          type: string
          nullable: true
          description: 表示用のキー先頭部分
          example: "sk_live_abc123"
        name:
          type: string
        created_by:
          type: string
          format: uuid
          description: 作成者のユーザーID
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          nullable: true
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/ApiKeyPermission'

    CreateApiKeyResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        key:
          type: string
          description: APIキー（この応答でのみ表示）
          example: "sk_live_abc123..."
        key_prefix:
          type: string
          description: 表示用のキー先頭部分
          example: "sk_live_abc123"
        name:
          type: string
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          nullable: true
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/ApiKeyPermission'

    ListApiKeysResponse:
      type: object
      properties:
        api_keys:
          type: array
          items:
            $ref: '#/components/schemas/ApiKeyInfo'

  responses:
    Unauthorized:
      description: 認証エラー
      content:
        text/plain:
          schema:
            type: string
            example: "Invalid API key"

    Forbidden:
      description: 権限エラー
      content:
        text/plain:
          schema:
            type: string
            example: "Missing required permission: api_keys.manage"

