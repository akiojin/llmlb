# 実装計画: APIキースコープ & /v0 認証強化

**機能ID**: `SPEC-k5mdhprl` ｜ **作成日**: 2025-12-20  
**参照仕様**: [spec.md](./spec.md)

## 概要
- APIキーにスコープを持たせ、推論・ノード登録・管理操作を分離する。
- `/v0` 管理系エンドポイントは `admin` または `admin` に限定する。
- ノード登録/モデル配信は `node` スコープのAPIキーで実施する。
- `/v0/health` は `node` スコープのAPIキー + ノードトークンを要求する。
- 既存APIキーは後方互換として全スコープ扱い。

## 技術コンテキスト
- **対象領域**:
  - `common/src/auth.rs`: APIキー/ユーザーのデータモデル拡張。
  - `router/src/db/api_keys.rs`: スコープの永続化。
  - `router/src/auth/middleware.rs`: スコープ判定・APIキー認証。
  - `router/src/api/mod.rs`: `/v0`/`/v1` の認証ルート整理。
  - `router/src/web/dashboard`: APIキー作成UI。
  - `node/`: ノード登録/モデル配信でAPIキーを使用。
- **制約**:
  - 認証スキップのフラグは禁止（CLAUDE.md）。
  - 既存仕様（GPU必須/ノードトークン）と矛盾しない。

## 憲章チェック（初期）
- **シンプルさ**: 既存の認証/DBに最小拡張。新規サービス追加なし。
- **TDD**: Contract/Integration/E2E → 実装 → リファクタの順。
- **開発体験**: 管理者UIからスコープ選択可能にする。

## Phase 0: リサーチ
- 既存の認証経路（JWT/APIキー/ノードトークン）の確認。
- `/v0` エンドポイントと利用者（管理者/ノード/外部クライアント）整理。

## Phase 1: 設計
- データモデル: APIキーに `scopes` を追加。
- 認証設計: スコープによるアクセス制御を middleware で一元化。
- ノード設計: `ALLM_API_KEY` を導入し、登録/配信に利用。
- ヘルス設計: ノードのハートビートに APIキーを必須化。

## Phase 2: タスク分解方針
- **Contract/Integration**: APIキー・スコープの拒否/許可、`/v0` 認証必須化。
- **Backend**: DBマイグレーション、認証ミドルウェア、ルーティング更新。
- **Frontend**: APIキー作成UIでスコープ選択。
- **Node**: APIキー送信とモデル配信の認証。
- **Docs**: README/README.ja で権限マトリクスと新規環境変数を更新。

## リスクと対応
- **ノード登録失敗**: APIキー未設定時のエラーを明確化。
- **権限混乱**: スコープの用途を README に明記。
- **既存キー互換**: `scopes` 未設定時の全権限扱いを維持。

## 次アクション
- `/speckit.tasks` 相当のタスクリスト作成。
- Contract/Integration/E2E テストの追加と更新。
- 実装・検証を進行。
