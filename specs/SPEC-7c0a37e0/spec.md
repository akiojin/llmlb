# 機能仕様書: APIキー権限（Permissions）システム

**機能ID**: `SPEC-7c0a37e0`
**作成日**: 2025-12-19
**ステータス**: ✅ 実装完了（`scopes` → `permissions` へ移行）
**依存SPEC**: SPEC-d4eb8796（認証・アクセス制御）
**入力**: ユーザー説明: "APIキーに複数の権限（permissions）を設定し、最小権限で外部APIと運用APIを制御する"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 管理者がAPIキーを発行する (優先度: P1)

管理者として、ダッシュボードからAPIキーを発行し、そのキーに適切な権限（permissions）を
複数選択（チェックボックス）して設定できる。これにより、外部API利用者や運用自動化に
必要最小限の権限のみを付与できる。

**この優先度の理由**: スコープ付きAPIキーの発行は、システム全体のセキュリティ基盤となる
最も重要な機能。これがないと他のストーリーが成立しない。

**独立テスト**: ダッシュボードのAPIキー管理画面で権限を選択してキーを発行し、
発行されたキーに権限が正しく紐付いていることを確認できる。

**受け入れシナリオ**:

1. **前提** 管理者としてダッシュボードにログイン済み、
   **実行** APIキー発行画面で`endpoints.read`権限を選択してキーを発行、
   **結果** 発行されたAPIキーに`endpoints.read`権限が紐付く
2. **前提** 管理者としてダッシュボードにログイン済み、
   **実行** APIキー発行画面で複数権限（`endpoints.manage`, `metrics.read`）を選択、
   **結果** 発行されたAPIキーに両方の権限が紐付く
3. **前提** 管理者としてダッシュボードにログイン済み、
   **実行** `users.manage`と`api_keys.manage`を選択してキーを発行、
   **結果** 発行されたAPIキーでユーザー管理とAPIキー管理が可能

---

### ユーザーストーリー2 - 管理者がAPIキーでエンドポイントを管理する (優先度: P1)

管理者として、適切な権限を持つAPIキーを使用してエンドポイントを登録・管理できる。
適切な権限がないAPIキーでは操作が拒否される。

**この優先度の理由**: エンドポイント管理の認証は、不正なエンドポイント登録や
設定変更を防ぐための重要なセキュリティ機能。

**独立テスト**: `endpoints.manage`権限を持つAPIキーでエンドポイントを登録し、
登録が成功することを確認。権限のないキーでは拒否されることを確認。

**受け入れシナリオ**:

1. **前提** `endpoints.manage`権限付きAPIキーを所持、
   **実行** そのキーでPOST /api/endpoints を呼び出す、
   **結果** エンドポイントが正常に登録される
2. **前提** `endpoints.read`のみの権限付きAPIキーを所持、
   **実行** そのキーでエンドポイント登録を試みる、
   **結果** 403 Forbiddenエラーで登録が拒否される
3. **前提** APIキーなし、
   **実行** エンドポイント登録を試みる、
   **結果** 401 Unauthorizedエラーで登録が拒否される

---

### ユーザーストーリー3 - API利用者がAPIキーで推論APIを利用する (優先度: P1)

API利用者として、管理者から発行されたAPIキーを使用してOpenAI互換APIを利用できる。
適切な権限がないAPIキーではAPIアクセスが拒否される。

**この優先度の理由**: 推論APIの認証は、リソースの不正利用を防ぎ、
利用状況を追跡するために必要。

**独立テスト**: `openai.inference`権限を持つAPIキーでchat completions APIを呼び出し、
正常にレスポンスが返ることを確認。権限のないキーでは拒否されることを確認。

**受け入れシナリオ**:

1. **前提** `openai.inference`権限付きAPIキーを所持、
   **実行** `Authorization: Bearer {api_key}`ヘッダーでchat completions APIを呼び出す、
   **結果** 正常にレスポンスが返る
2. **前提** `openai.models.read`のみの権限付きAPIキーを所持、
   **実行** そのキーでchat completions APIを呼び出す、
   **結果** 403 Forbiddenエラーでアクセスが拒否される
3. **前提** APIキーなし、
   **実行** chat completions APIを呼び出す、
   **結果** 401 Unauthorizedエラーでアクセスが拒否される

---

### ユーザーストーリー4 - 開発者がデバッグ用APIキーでテストする (優先度: P2)

開発者として、デバッグビルドで事前定義されたAPIキーを使用して各機能をテストできる。
リリースビルドではこれらのキーは無効化される。

**この優先度の理由**: 開発効率とセキュリティのバランスを取るために必要。
本番環境の安全性を損なわずに開発をスムーズに進められる。

**独立テスト**: デバッグビルドで各デバッグAPIキーが対応する権限で動作し、
リリースビルドでは無効化されることを確認。

**受け入れシナリオ**:

1. **前提** デバッグビルドのロードバランサーを起動、
   **実行** `sk_debug_admin`でエンドポイント登録を試みる、
   **結果** 登録が成功する
2. **前提** デバッグビルドのロードバランサーを起動、
   **実行** `sk_debug_api`でchat completions APIを呼び出す、
   **結果** 正常にレスポンスが返る
3. **前提** デバッグビルドのロードバランサーを起動、
   **実行** `sk_debug_admin`でダッシュボードAPIを呼び出す、
   **結果** 正常にアクセスできる
4. **前提** デバッグビルドのロードバランサーを起動、
   **実行** `sk_debug`で任意のAPIを呼び出す、
   **結果** すべてのAPIにアクセスできる（後方互換性）
5. **前提** リリースビルドのロードバランサーを起動、
   **実行** `sk_debug_*`のいずれかでAPIを呼び出す、
   **結果** 401 Unauthorizedエラーで拒否される

---

### ユーザーストーリー5 - 閲覧者ユーザーは管理APIにアクセスできない (優先度: P2)

閲覧者（`viewer`）として、ログインはできるが管理系APIにはアクセスできない。
これにより、管理操作と閲覧権限が明確に分離される。

**この優先度の理由**: 誤操作や権限逸脱を防ぐため、最低限のロール分離が必要。

**独立テスト**: `viewer` ロールで `/api/auth/me` は成功するが、
`/api/users` など管理APIは 403 になることを確認。

**受け入れシナリオ**:

1. **前提** `viewer` ロールのユーザーでログイン済み、
   **実行** `/api/auth/me` を呼び出す、
   **結果** 200 OK でユーザー情報が返る
2. **前提** `viewer` ロールのユーザーでログイン済み、
   **実行** `/api/users` へアクセスする、
   **結果** 403 Forbidden で拒否される

---

### エッジケース

- 有効期限切れのAPIキーで認証を試みた場合、401エラーが返される
- 削除されたAPIキーで認証を試みた場合、401エラーが返される
- 必要な権限を持たないAPIキーでのアクセスは403が返される
- APIキー発行時に`permissions`が空の場合は400が返される
- セキュリティ要件: APIキーの平文は**発行時のみ**返され、以降は復元できない（ダッシュボード一覧では`key_prefix`のみ表示・コピー可能）
- 旧互換: APIキー発行リクエストの`scopes`フィールドは廃止され、送信された場合は400が返される
- 旧互換: DB上に`scopes`のみが存在する既存キーは、マイグレーションで`permissions`へ移行される

## Clarifications

### Session 2025-12-23

- Q: APIキー発行時のデフォルト有効期限は？ → A: デフォルトは無期限（`expires_at` 未指定）

---

## 要件 *(必須)*

### 機能要件

- **FR-001**: APIキーに権限（`permissions`）を紐付けて発行できる
- **FR-002**: 権限IDは以下の固定セットとする（カスタム定義はスコープ外）
  - `openai.inference`
  - `openai.models.read`
  - `endpoints.read`
  - `endpoints.manage`
  - `api_keys.manage`
  - `users.manage`
  - `invitations.manage`
  - `models.manage`
  - `registry.read`
  - `logs.read`
  - `metrics.read`
- **FR-003**: OpenAI互換推論API（`POST /v1/*`）は`openai.inference`権限を要求する
- **FR-004**: OpenAI互換モデル一覧（`GET /v1/models*`）は`openai.models.read`権限を要求する
- **FR-005**: エンドポイント管理API（`/api/endpoints*`）はREADに`endpoints.read`、WRITEに`endpoints.manage`権限を要求する（JWTの場合、WRITEはadminのみ）
- **FR-006**: ダッシュボードAPI（`/api/dashboard/*`）は **JWTのみ** で認可し、APIキーを受け付けない（SPEC-d4eb8796）
- **FR-007**: デバッグビルドでは事前定義されたAPIキーが権限に応じて利用可能
- **FR-008**: リリースビルドではデバッグAPIキーは無効化される
- **FR-009**: APIキー発行時に権限（チェックボックス）を選択できるUIをダッシュボードに提供する
- **FR-010**: 管理系APIは最小権限で分割され、各APIは必要な権限を要求する
  - `/api/users*` は `users.manage`
  - `/api/api-keys*` は `api_keys.manage`
  - `/api/invitations*` は `invitations.manage`
  - `/api/models/register` / `DELETE /api/models/*` は `models.manage`
  - `/api/models/registry/*` は `registry.read`
  - `/api/nodes/:node_id/logs` は `logs.read`
  - `/api/metrics/cloud` は `metrics.read`
- **FR-011**: `viewer`ロールのユーザーは管理系APIへアクセスできない（403）
- **FR-012**: APIキー発行時に`permissions`は必須とする（空の配列は許可しない）
- **FR-013**: 旧データ互換として、DBの旧`scopes`から`permissions`へ移行するマイグレーションを提供する

### 主要エンティティ

- **ユーザー**: ユーザー名、パスワードハッシュ、ロール（`admin`/`viewer`）を持つ
- **APIキー**: ハッシュ化されたキー、名前、作成者、有効期限、権限リスト（`permissions`）を持つ
- **権限（permissions）**: APIキーに紐付く権限IDの配列（`openai.inference`等）

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- より細かい権限設定（モデル単位、エンドポイント単位のアクセス制御）
- APIキー使用量のレート制限
- APIキー使用統計のダッシュボード表示
- 権限セットのカスタム定義（権限IDの追加/削除の管理UI）

---

## 技術制約 *(該当する場合)*

- 既存の`api_keys`テーブルに`permissions`列を追加し、旧`scopes`から移行する必要がある
- デバッグAPIキーは`#[cfg(debug_assertions)]`で保護される
- 既存のAPIキー認証ミドルウェアを拡張する

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- ダッシュボードのJWT認証システムは既に実装済み
- APIキーの基本的な発行・管理機能は既に実装済み

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- 既存のAPIキー管理システム（`llmlb/src/db/api_keys.rs`）
- 既存の認証ミドルウェア（`llmlb/src/auth/middleware.rs`）
- ダッシュボードのAPIキー管理UI

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. 管理者は30秒以内にpermissions付きAPIキーを発行できる
2. 適切な権限を持たないAPIキーでのアクセスは100%拒否される
3. デバッグビルドでの開発テストが認証設定なしで実行できる
4. リリースビルドではデバッグAPIキーが100%無効化される
5. 旧`scopes`のみの既存APIキーは後方互換性のため`permissions`へ移行される
