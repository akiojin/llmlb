# 機能仕様書: APIキースコープシステム

**機能ID**: `SPEC-7c0a37e0`
**作成日**: 2025-12-19
**ステータス**: ✅ 実装完了
**依存SPEC**: SPEC-d4eb8796（認証・アクセス制御）
**入力**: ユーザー説明: "APIキーに権限（スコープ）を設定し、エンドポイント管理・API利用・管理操作を制御する"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 管理者がAPIキーを発行する (優先度: P1)

管理者として、ダッシュボードからAPIキーを発行し、そのキーに適切な権限（スコープ）を
設定できる。これにより、ノード提供者やAPI利用者に必要最小限の権限のみを付与できる。

**この優先度の理由**: スコープ付きAPIキーの発行は、システム全体のセキュリティ基盤となる
最も重要な機能。これがないと他のストーリーが成立しない。

**独立テスト**: ダッシュボードのAPIキー管理画面でスコープを選択してキーを発行し、
発行されたキーにスコープが正しく紐付いていることを確認できる。

**受け入れシナリオ**:

1. **前提** 管理者としてダッシュボードにログイン済み、
   **実行** APIキー発行画面で`endpoints`スコープを選択してキーを発行、
   **結果** 発行されたAPIキーに`endpoints`スコープが紐付く
2. **前提** 管理者としてダッシュボードにログイン済み、
   **実行** APIキー発行画面で複数スコープ（`endpoints`, `api`）を選択、
   **結果** 発行されたAPIキーに両方のスコープが紐付く
3. **前提** 管理者としてダッシュボードにログイン済み、
   **実行** `admin`スコープを選択してキーを発行、
   **結果** 発行されたAPIキーですべての管理操作が可能

---

### ユーザーストーリー2 - 管理者がAPIキーでエンドポイントを管理する (優先度: P1)

管理者として、適切なスコープを持つAPIキーを使用してエンドポイントを登録・管理できる。
適切な権限がないAPIキーでは操作が拒否される。

**この優先度の理由**: エンドポイント管理の認証は、不正なエンドポイント登録や
設定変更を防ぐための重要なセキュリティ機能。

**独立テスト**: `endpoints`スコープを持つAPIキーでエンドポイントを登録し、
登録が成功することを確認。権限のないキーでは拒否されることを確認。

**受け入れシナリオ**:

1. **前提** `endpoints`スコープ付きAPIキーを所持、
   **実行** そのキーでPOST /v0/endpoints を呼び出す、
   **結果** エンドポイントが正常に登録される
2. **前提** `api`のみのスコープ付きAPIキーを所持、
   **実行** そのキーでエンドポイント登録を試みる、
   **結果** 403 Forbiddenエラーで登録が拒否される
3. **前提** APIキーなし、
   **実行** エンドポイント登録を試みる、
   **結果** 401 Unauthorizedエラーで登録が拒否される

---

### ユーザーストーリー3 - API利用者がAPIキーで推論APIを利用する (優先度: P1)

API利用者として、管理者から発行されたAPIキーを使用してOpenAI互換APIを利用できる。
適切な権限がないAPIキーではAPIアクセスが拒否される。

**この優先度の理由**: 推論APIの認証は、リソースの不正利用を防ぎ、
利用状況を追跡するために必要。

**独立テスト**: `api`スコープを持つAPIキーでchat completions APIを呼び出し、
正常にレスポンスが返ることを確認。権限のないキーでは拒否されることを確認。

**受け入れシナリオ**:

1. **前提** `api`スコープ付きAPIキーを所持、
   **実行** `Authorization: Bearer {api_key}`ヘッダーでchat completions APIを呼び出す、
   **結果** 正常にレスポンスが返る
2. **前提** `endpoints`のみのスコープ付きAPIキーを所持、
   **実行** そのキーでchat completions APIを呼び出す、
   **結果** 403 Forbiddenエラーでアクセスが拒否される
3. **前提** APIキーなし、
   **実行** chat completions APIを呼び出す、
   **結果** 401 Unauthorizedエラーでアクセスが拒否される

---

### ユーザーストーリー4 - 開発者がデバッグ用APIキーでテストする (優先度: P2)

開発者として、デバッグビルドで事前定義されたAPIキーを使用して各機能をテストできる。
リリースビルドではこれらのキーは無効化される。

**この優先度の理由**: 開発効率とセキュリティのバランスを取るために必要。
本番環境の安全性を損なわずに開発をスムーズに進められる。

**独立テスト**: デバッグビルドで各デバッグAPIキーが対応するスコープで動作し、
リリースビルドでは無効化されることを確認。

**受け入れシナリオ**:

1. **前提** デバッグビルドのルーターを起動、
   **実行** `sk_debug_endpoints`でエンドポイント登録を試みる、
   **結果** 登録が成功する
2. **前提** デバッグビルドのルーターを起動、
   **実行** `sk_debug_api`でchat completions APIを呼び出す、
   **結果** 正常にレスポンスが返る
3. **前提** デバッグビルドのルーターを起動、
   **実行** `sk_debug_admin`でダッシュボードAPIを呼び出す、
   **結果** 正常にアクセスできる
4. **前提** デバッグビルドのルーターを起動、
   **実行** `sk_debug`で任意のAPIを呼び出す、
   **結果** すべてのAPIにアクセスできる（後方互換性）
5. **前提** リリースビルドのルーターを起動、
   **実行** `sk_debug_*`のいずれかでAPIを呼び出す、
   **結果** 401 Unauthorizedエラーで拒否される

---

### ユーザーストーリー5 - 閲覧者ユーザーは管理APIにアクセスできない (優先度: P2)

閲覧者（`viewer`）として、ログインはできるが管理系APIにはアクセスできない。
これにより、管理操作と閲覧権限が明確に分離される。

**この優先度の理由**: 誤操作や権限逸脱を防ぐため、最低限のロール分離が必要。

**独立テスト**: `viewer` ロールで `/v0/auth/me` は成功するが、
`/v0/users` など管理APIは 403 になることを確認。

**受け入れシナリオ**:

1. **前提** `viewer` ロールのユーザーでログイン済み、
   **実行** `/v0/auth/me` を呼び出す、
   **結果** 200 OK でユーザー情報が返る
2. **前提** `viewer` ロールのユーザーでログイン済み、
   **実行** `/v0/users` へアクセスする、
   **結果** 403 Forbidden で拒否される

---

### エッジケース

- 有効期限切れのAPIキーで認証を試みた場合、401エラーが返される
- 削除されたAPIキーで認証を試みた場合、401エラーが返される
- 複数スコープを持つAPIキーは、いずれかのスコープで許可される操作すべてにアクセスできる
- `admin`スコープは他のすべてのスコープを包含する

## Clarifications

### Session 2025-12-23

- Q: APIキー発行時のデフォルト有効期限は？ → A: 90日

---

## 要件 *(必須)*

### 機能要件

- **FR-001**: APIキーにスコープ（権限）を紐付けて発行できる
- **FR-002**: スコープは`endpoints`、`api`、`admin`の3種類
- **FR-003**: エンドポイント管理API（`/v0/endpoints`）は`endpoints`スコープを要求する
- **FR-004**: 推論API（`/v1/chat/completions`等）は`api`スコープを要求する
- **FR-005**: ダッシュボードAPI（`/v0/dashboard/*`）は`admin`スコープまたはJWT認証を要求する
- **FR-006**: デバッグビルドでは事前定義されたAPIキーが各スコープで利用可能
- **FR-007**: リリースビルドではデバッグAPIキーは無効化される
- **FR-008**: APIキー発行時にスコープを選択できるUIをダッシュボードに提供する
- **FR-009**: `admin`スコープは他のすべてのスコープの権限を包含する
- **FR-010**: `/v0`の管理系エンドポイント（`/v0/users`, `/v0/api-keys`, `/v0/endpoints`の管理操作, `/v0/metrics/*`）および`/v1/models`の管理操作（`POST /v1/models/register`, `DELETE /v1/models/:name`）は`admin`スコープまたはJWT認証を要求する
- **FR-011**: モデル同期用エンドポイント（`/v0/models/registry/:model_name/manifest.json`）は`endpoints`スコープを要求する
- **FR-012**: `viewer`ロールのユーザーは管理系APIへアクセスできない（403）
- **FR-013**: APIキー発行時のデフォルト有効期限は90日とする

### 主要エンティティ

- **ユーザー**: ユーザー名、パスワードハッシュ、ロール（`admin`/`viewer`）を持つ
- **APIキー**: ハッシュ化されたキー、名前、作成者、有効期限、スコープリストを持つ
- **スコープ**: APIキーに紐付く権限。`endpoints`、`api`、`admin`のいずれか

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- より細かい権限設定（モデル単位、ノード単位のアクセス制御）
- APIキー使用量のレート制限
- APIキー使用統計のダッシュボード表示
- スコープのカスタム定義

---

## 技術制約 *(該当する場合)*

- 既存の`api_keys`テーブルにスコープ列を追加する必要がある
- デバッグAPIキーは`#[cfg(debug_assertions)]`で保護される
- 既存のAPIキー認証ミドルウェアを拡張する

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- ダッシュボードのJWT認証システムは既に実装済み
- APIキーの基本的な発行・管理機能は既に実装済み

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- 既存のAPIキー管理システム（`router/src/db/api_keys.rs`）
- 既存の認証ミドルウェア（`router/src/auth/middleware.rs`）
- ダッシュボードのAPIキー管理UI

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. 管理者は30秒以内にスコープ付きAPIキーを発行できる
2. 適切なスコープを持たないAPIキーでのアクセスは100%拒否される
3. デバッグビルドでの開発テストが認証設定なしで実行できる
4. リリースビルドではデバッグAPIキーが100%無効化される
5. 既存のAPIキー（スコープなし）は後方互換性のため全スコープとして扱われる
