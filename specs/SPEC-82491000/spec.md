# 機能仕様書: クラウドプロバイダーモデル一覧統合

**機能ID**: `SPEC-82491000`
**作成日**: 2025-12-25
**ステータス**: 下書き
**依存SPEC**: SPEC-4b6e9f2a（クラウドモデルプレフィックスルーティング）
**入力**: ユーザー説明: "/v1/modelsエンドポイントでクラウドプロバイダー（OpenAI、Google、Anthropic）のモデル一覧を取得・マージして返却する機能。キャッシュTTLは24時間。SPEC-4b6e9f2aを依存関係としてリンク。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 利用可能なモデル一覧の確認 (優先度: P1)

ユーザーがアプリケーションでAIモデルを選択する際、ローカルにデプロイされたモデルだけでなく、
OpenAI、Google、Anthropicの各クラウドプロバイダーで利用可能なモデルも含めた統合されたリストを
一度のリクエストで取得したい。これにより、ユーザーは利用可能な全てのオプションを把握し、
最適なモデルを選択できる。

**この優先度の理由**: コア機能であり、ユーザーがクラウドモデルを発見・選択するための基本的な
エントリーポイント。この機能なしではクラウドモデルの存在がユーザーに見えない。

**独立テスト**: `/v1/models`エンドポイントを呼び出すことで完全にテスト可能。
レスポンスにローカルモデルとクラウドモデル（設定済みプロバイダー分）が
プレフィックス付きで含まれることを確認できる。

**受け入れシナリオ**:

1. **前提** OpenAI APIキーが設定されている、**実行** ユーザーがモデル一覧を取得する、
   **結果** OpenAIのモデル（gpt-4o等）が`openai:`プレフィックス付きでリストに表示される
2. **前提** 複数のクラウドプロバイダーのAPIキーが設定されている、
   **実行** ユーザーがモデル一覧を取得する、
   **結果** 各プロバイダーのモデルがそれぞれのプレフィックス
   （`openai:`, `google:`, `anthropic:`）付きでマージされて表示される
3. **前提** いずれのクラウドプロバイダーのAPIキーも設定されていない、
   **実行** ユーザーがモデル一覧を取得する、
   **結果** ローカルモデルのみが表示される（エラーにならない）

---

### ユーザーストーリー2 - 高速なモデル一覧取得 (優先度: P2)

ユーザーがモデル一覧を取得する際、毎回クラウドプロバイダーのAPIを呼び出すのではなく、
キャッシュされた情報を使用することで、素早いレスポンスを得たい。
モデル一覧は頻繁に変更されないため、24時間ごとの更新で十分である。

**この優先度の理由**: ユーザー体験とコスト効率の両方に影響。APIレート制限の回避と
レスポンス速度の向上に貢献する。

**独立テスト**: 連続して2回モデル一覧を取得し、2回目のレスポンスがキャッシュから
提供されること（レスポンス時間の短縮）を確認できる。

**受け入れシナリオ**:

1. **前提** キャッシュが存在しない初回リクエスト、**実行** ユーザーがモデル一覧を取得する、
   **結果** クラウドプロバイダーから最新のモデル一覧が取得され、キャッシュに保存される
2. **前提** キャッシュが有効期限内（24時間以内）、**実行** ユーザーがモデル一覧を取得する、
   **結果** キャッシュから即座にモデル一覧が返却される
3. **前提** キャッシュが24時間以上経過している、**実行** ユーザーがモデル一覧を取得する、
   **結果** クラウドプロバイダーから新しいモデル一覧が取得され、キャッシュが更新される

---

### ユーザーストーリー3 - 障害時の継続的な利用 (優先度: P3)

クラウドプロバイダーのAPIが一時的に利用できない場合でも、ユーザーは可能な限り
モデル一覧を取得できるようにしたい。特定のプロバイダーで障害が発生しても、
他のプロバイダーやローカルモデルの情報は影響を受けずに取得できる。

**この優先度の理由**: システムの堅牢性に関わる。部分的な障害がシステム全体の
機能停止を招かないようにするため重要。

**独立テスト**: 特定のプロバイダーへのアクセスを遮断した状態でモデル一覧を取得し、
他のプロバイダーのモデルは正常に表示されることを確認できる。

**受け入れシナリオ**:

1. **前提** OpenAI APIがタイムアウトする状況、**実行** ユーザーがモデル一覧を取得する、
   **結果** OpenAIモデルは表示されないが、Google/Anthropicモデルとローカルモデルは表示される
2. **前提** キャッシュ更新中にAPIエラーが発生、**実行** ユーザーがモデル一覧を取得する、
   **結果** 古いキャッシュがフォールバックとして使用され、モデル一覧が返却される

---

### エッジケース

- APIキーが無効（認証エラー）の場合、該当プロバイダーはスキップされログに記録される
- 全てのクラウドプロバイダーで障害が発生した場合、ローカルモデルのみが返却される
- モデルIDが重複する場合（異なるプロバイダーで同名モデル）、プレフィックスにより区別される

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは`/v1/models`エンドポイントでローカルモデルとクラウドモデルを
  統合した一覧を返却する必要がある
- **FR-002**: システムはクラウドモデルにプロバイダー識別プレフィックス
  （`openai:`, `google:`, `anthropic:`）を付与する必要がある
- **FR-003**: システムはAPIキーが設定されているプロバイダーのみから
  モデル一覧を取得する必要がある
- **FR-004**: システムはモデル一覧を24時間キャッシュする必要がある
- **FR-005**: システムは特定プロバイダーの障害時も他のプロバイダーと
  ローカルモデルの情報を返却する必要がある
- **FR-006**: システムはキャッシュ更新失敗時に古いキャッシュを
  フォールバックとして使用する必要がある

### 主要エンティティ

- **モデル情報**: モデルID、所有者（プロバイダー）、作成日時などの属性を持つ
- **プロバイダー設定**: APIキーの有無、ベースURLなどの接続情報を持つ
- **キャッシュエントリ**: モデル一覧データ、取得時刻、有効期限を持つ

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- モデルの詳細情報（コンテキスト長、価格など）の取得
- モデル一覧の手動リフレッシュ機能
- プロバイダーごとのキャッシュTTLカスタマイズ

---

## 技術制約 *(該当する場合)*

- 各プロバイダーのAPIレート制限を遵守する必要がある
- タイムアウトは10秒を上限とし、応答がない場合はスキップする

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- 既存の`/v1/models`エンドポイントがローカルモデルを返却する機能を持つ
- クラウドプロバイダーへのルーティング機能（SPEC-4b6e9f2a）が実装済みである

---

## 依存関係 *(該当する場合)*

### 前提条件（このSPECが依存するもの）

- **SPEC-4b6e9f2a**: クラウドモデルプレフィックスルーティング ✅ 実装済み
  - プレフィックス形式（`openai:`, `google:`, `anthropic:`）とプロバイダー設定の仕様を共有

### 依存元（このSPECに依存するもの）

- なし

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. ユーザーは1回のリクエストで全プロバイダーのモデル一覧を取得できる
2. キャッシュ有効時のモデル一覧取得は100ミリ秒以内に完了する
3. 特定プロバイダーの障害時も、システムは他のモデル情報を正常に返却する
4. クラウドモデルは明確なプレフィックスにより識別可能である
