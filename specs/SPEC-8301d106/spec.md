# 機能仕様書: 監査ログ（Audit Log）

**機能ID**: `SPEC-8301d106`
**作成日**: 2026-02-20
**ステータス**: 下書き
**入力**: ユーザー説明: "監査ログ（Audit Log）機能。llmlbロードバランサーにおける全ユーザー操作の監査ログ記録システム。"

## 背景と動機

llmlbロードバランサーは複数ユーザーによる共同運用を前提としているが、
現在は推論リクエスト履歴（request\_history）のみが記録されており、
管理操作（ユーザー作成・削除、エンドポイント追加・変更、APIキー発行・失効、認証操作等）は
一切記録されていない。

セキュリティインシデント発生時の原因調査、運用上の変更追跡、
コンプライアンス対応のために、全ユーザー操作を統一的に記録する
監査ログシステムが必要である。

加えて、既存の推論リクエスト履歴（request\_history）も監査ログに統合し、
単一の統一ログとして管理することで、運用の一貫性とデータ管理の効率性を向上させる。

## ユーザーシナリオ＆テスト

### ユーザーストーリー1 - 全操作の自動記録 (優先度: P1)

管理者として、誰がいつ何をしたかを後から確認できるようにするため、
ユーザーが行うすべての操作（ダッシュボード操作、API経由の推論リクエスト、
管理操作、認証操作）が自動的に記録される。

**この優先度の理由**: 監査ログの根幹機能。これがなければ後続のすべての機能が成立しない。

**独立テスト**: ダッシュボードでエンドポイントを追加・変更し、
監査ログテーブルにその操作が記録されていることをDBクエリで確認できる。

**受け入れシナリオ**:

1. **前提** llmlbが稼働中、**実行** 管理者がダッシュボードからエンドポイントを追加、
   **結果** 監査ログに操作者・操作内容・タイムスタンプ・ステータスが記録される
2. **前提** llmlbが稼働中、**実行** APIキー経由で推論リクエストを送信、
   **結果** 監査ログにAPIキーID・発行者ユーザーID・リクエストパス・トークン数が記録される
3. **前提** llmlbが稼働中、**実行** 無効なパスワードでログインを試行、
   **結果** 監査ログに認証失敗として入力ユーザー名・クライアントIPが記録される
4. **前提** llmlbが稼働中、**実行** 管理者がモデル一覧を閲覧（GET）、
   **結果** 監査ログにHTTPメソッド・パス・ステータスコード・操作者が記録される
5. **前提** llmlbが稼働中、WebSocket接続が確立済み、
   **実行** ダッシュボードのリアルタイム更新が発生、
   **結果** WebSocketフレームは監査ログに記録されない（除外対象）

---

### ユーザーストーリー2 - 監査ログの検索・閲覧 (優先度: P1)

管理者として、セキュリティインシデントの調査や運用変更の追跡のために、
ダッシュボード上の専用ページで監査ログを検索・フィルタ・閲覧できる。

**この優先度の理由**: 記録された監査ログを活用するための必須機能。
ログが記録されても閲覧手段がなければ実用性がない。

**独立テスト**: ダッシュボードの監査ログページで、
特定のユーザーの操作履歴をフィルタ検索し、結果が正しく表示される。

**受け入れシナリオ**:

1. **前提** 監査ログにデータが蓄積済み、**実行** 管理者が監査ログページを開く、
   **結果** 最新の監査ログが時系列降順でページネーション付きで表示される
2. **前提** 監査ログにデータが蓄積済み、
   **実行** 管理者が特定ユーザー名でフィルタ、
   **結果** そのユーザーの操作のみが表示される
3. **前提** 監査ログにデータが蓄積済み、
   **実行** 管理者が日付範囲とHTTPメソッドで絞り込み、
   **結果** 条件に一致するログのみが表示される
4. **前提** 監査ログにデータが蓄積済み、
   **実行** 管理者がフリーテキストでパスの一部を検索、
   **結果** パスに部分一致するログが表示される
5. **前提** viewerロールのユーザーがログイン済み、
   **実行** 監査ログページにアクセスを試みる、
   **結果** アクセスが拒否される（adminロールのみ利用可能）

---

### ユーザーストーリー3 - 改ざん検知（ハッシュチェーン検証） (優先度: P2)

管理者として、監査ログデータが改ざんされていないことを検証するため、
ハッシュチェーンによる整合性検証を実行できる。

**この優先度の理由**: 監査ログの信頼性を保証する機能。
記録と検索が動作した後に、データの完全性を検証する機能が必要。

**独立テスト**: ダッシュボードの検証ボタンを押下し、
ハッシュチェーンの検証結果（正常/異常）が表示される。

**受け入れシナリオ**:

1. **前提** 監査ログが正常に蓄積済み、**実行** 管理者が検証を実行、
   **結果** 「検証成功: 全バッチの整合性が確認されました」と表示される
2. **前提** 監査ログの一部レコードがDB直接操作で改ざんされている、
   **実行** 管理者が検証を実行、
   **結果** 「検証失敗: バッチN（日時）で改ざんが検出されました」と表示される
3. **前提** サーバーが起動した直後、
   **実行** なし（自動実行）、
   **結果** 起動ログにハッシュチェーン検証の結果が出力される
4. **前提** サーバーが24時間以上稼働中、
   **実行** なし（定期実行）、
   **結果** 24時間ごとにバックグラウンドで検証が実行され、結果がログに出力される

---

### ユーザーストーリー4 - request\_history統合とトークン統計の継続 (優先度: P1)

管理者として、推論リクエストの履歴とトークン統計を引き続き利用できるようにするため、
既存のrequest\_history機能が監査ログに統合され、
ダッシュボードのトークン統計・日次/月次レポートが従来通り機能する。

**この優先度の理由**: 既存機能の継続性を保証する必須要件。
request\_historyの廃止に伴い、既存の統計機能が破壊されないことが重要。

**独立テスト**: 推論リクエストを実行し、ダッシュボードの統計ページで
トークン集計・日次レポートが従来通り表示される。

**受け入れシナリオ**:

1. **前提** request\_historyに既存データが存在、
   **実行** マイグレーションを実行、
   **結果** 既存データが監査ログテーブルに移行され、
   移行前データとしてマークされる（ハッシュチェーン対象外）
2. **前提** 推論リクエストを実行済み、
   **実行** ダッシュボードのトークン統計ページを閲覧、
   **結果** 入力/出力/合計トークン数が正しく集計・表示される
3. **前提** 推論リクエストを実行済み、
   **実行** 日次/月次トークンレポートを閲覧、
   **結果** 日次/月次でのトークン使用量が正しく表示される

---

### ユーザーストーリー5 - 監査ログのアーカイブとライフサイクル管理 (優先度: P2)

管理者として、ストレージを効率的に管理しつつ過去のデータにもアクセスできるよう、
90日以上経過した監査ログデータが自動的にアーカイブに移動され、
アーカイブデータも検索可能である。

**この優先度の理由**: 長期運用に必要な機能。
初期段階ではデータ量が少ないが、運用が継続するにつれ不可欠になる。

**独立テスト**: 90日以上前のテストデータを作成し、
アーカイブ処理を実行後、アーカイブDBにデータが移動し、
APIから検索可能であることを確認できる。

**受け入れシナリオ**:

1. **前提** 90日以上前の監査ログが存在、
   **実行** アーカイブ処理が自動実行、
   **結果** 古いデータがアーカイブDBに移動し、メインDBから削除される
2. **前提** アーカイブDBにデータが存在、
   **実行** 管理者が1年前の監査ログを検索、
   **結果** アーカイブDBのデータも含めて検索結果が返される
3. **前提** アーカイブ処理が実行された後、
   **実行** ハッシュチェーン検証を実行、
   **結果** アーカイブ移動によりハッシュチェーンが破壊されない
   （アーカイブDBにもハッシュチェーン情報が保持される）

---

### ユーザーストーリー6 - 監査ログAPI（プログラマティックアクセス） (優先度: P2)

外部システム管理者として、監査ログデータをプログラマティックに取得するため、
REST APIで監査ログを検索・取得・統計を閲覧できる。

**この優先度の理由**: UIだけでなくAPI経由でのアクセスにより、
外部ツール（Grafana、SIEMなど）との連携や自動化が可能になる。

**独立テスト**: curlコマンドで監査ログAPIにリクエストし、
フィルタ付きのJSON結果が返される。

**受け入れシナリオ**:

1. **前提** 監査ログにデータが蓄積済み、
   **実行** admin権限でGET /api/dashboard/audit-logsにリクエスト、
   **結果** ページネーション付きのJSON監査ログ一覧が返される
2. **前提** 監査ログにデータが蓄積済み、
   **実行** アクターとアクションでフィルタして検索APIを呼び出し、
   **結果** 条件に合致するログのみが返される
3. **前提** admin権限でない（viewer/APIキー）、
   **実行** 監査ログAPIにアクセス、
   **結果** 403 Forbiddenが返される

---

### エッジケース

- 監査ログDB書き込みが失敗した場合、元のHTTPリクエスト処理は正常に継続し、
  サーバーログに警告が出力される（可用性優先）
- サーバーがクラッシュした場合、非同期バッファ内の未フラッシュデータは損失する
  （許容される）
- 非常に高頻度のリクエスト（負荷テスト等）時でも、
  非同期バッファリングにより推論リクエストのレイテンシに影響を与えない
- バッファが上限（10,000件）に達した場合、最古のエントリを破棄して
  最新データを優先保持する（サーバーログに警告を出力）
- アーカイブDBファイルが存在しない場合、自動的に作成される
- アーカイブDBが破損している場合、エラーをログに記録し、
  オンラインデータの検索は正常に動作する
- マイグレーション時にrequest\_historyが空の場合、
  マイグレーションはスキップされ正常終了する
- 認証失敗の監査ログでは、アクターを「anonymous」とし、
  入力されたユーザー名（存在しない場合もある）とクライアントIPで追跡可能にする
- ハッシュチェーンの最初のバッチ（genesis batch）には
  前バッチハッシュとしてゼロハッシュ（all zeros）を使用する

## 要件

### 機能要件

#### 記録

- **FR-001**: システムは全HTTP操作（GET/POST/PUT/DELETE/PATCH）の
  メタデータを自動的に記録する必要がある
- **FR-002**: システムはWebSocket接続、ヘルスチェック、静的アセット配信、
  自動ポーリングを記録対象から除外する必要がある
- **FR-003**: システムは認証失敗（ログイン失敗、無効APIキー、期限切れJWT）を
  匿名アクターとして記録する必要がある
- **FR-004**: 各監査ログレコードは以下のメタデータを含む必要がある:
  タイムスタンプ、HTTPメソッド、リクエストパス、ステータスコード、
  アクター種別、アクターID、クライアントIP、処理時間
- **FR-005**: APIキー経由のアクセスでは、APIキーIDと
  そのキーを発行したユーザーIDの両方を記録する必要がある
- **FR-006**: 推論リクエスト（chat/completions、embeddings等）の監査ログには、
  トークン数（入力・出力・合計）を追加で記録する必要がある
- **FR-007**: 監査ログの書き込みはリクエスト処理のレイテンシに影響を与えてはならない
  （非同期バッファリング、30秒間隔でDBへフラッシュ、
  バッファ上限10,000件・超過時は最古エントリを破棄）
- **FR-008**: 監査ログ書き込みが失敗した場合、
  リクエスト処理は正常に継続する必要がある（可用性優先）

#### 改ざん防止

- **FR-009**: システムはSHA-256によるバッチ単位ハッシュチェーンで
  監査ログの改ざんを検出できる必要がある
- **FR-010**: ハッシュチェーンのバッチ間隔はデフォルト5分とし、
  環境変数で変更可能とする必要がある
- **FR-011**: システムはサーバー起動時にハッシュチェーンの整合性を
  自動検証する必要がある
- **FR-012**: システムは24時間ごとにバックグラウンドで
  ハッシュチェーンの整合性検証を実行する必要がある
- **FR-012a**: ハッシュチェーン検証で改ざんが検出された場合、
  システムはアラートをログに出力し、新しいバッチチェーンを開始して
  記録を続行する必要がある（記録停止は行わない）

#### ストレージ・ライフサイクル

- **FR-013**: オンラインデータは既存のSQLiteデータベースに保存される必要がある
- **FR-014**: 90日以上経過したデータは自動的にアーカイブDBに移動する必要がある
- **FR-015**: アーカイブDBのデータも検索可能である必要がある
- **FR-016**: アーカイブ処理はハッシュチェーンの整合性を破壊してはならない

#### request\_history統合

- **FR-017**: 既存のrequest\_historyテーブルは廃止し、
  監査ログテーブルに統合する必要がある
- **FR-018**: 既存のrequest\_historyデータは監査ログに移行し、
  移行前データとしてマークする必要がある（ハッシュチェーン対象外）
- **FR-019**: トークン統計（累計、日次、月次、モデル別、ノード別）は
  監査ログテーブルから集計可能である必要がある

#### 閲覧・検索

- **FR-020**: ダッシュボードに監査ログ専用ページを設ける必要がある
- **FR-021**: 監査ログページはadminロールのみがアクセス可能である必要がある
- **FR-022**: 構造化フィルタ（アクター、アクション、ターゲット、
  日時範囲、ステータス）で検索可能である必要がある
- **FR-023**: フリーテキスト検索（パスやメタデータの部分一致）が
  可能である必要がある
- **FR-024**: 検索結果はページネーション付きで返される必要がある
  （デフォルト50件/ページ）

#### API

- **FR-025**: REST APIで監査ログの一覧取得・フィルタ検索が
  可能である必要がある
- **FR-026**: REST APIでハッシュチェーン検証を
  トリガーできる必要がある（admin専用）
- **FR-027**: REST APIで監査ログの統計情報を
  取得できる必要がある

### 主要エンティティ

- **AuditLogEntry（監査ログエントリ）**: 1つのHTTP操作に対応するレコード。
  タイムスタンプ、HTTPメソッド、パス、ステータスコード、アクター情報、
  クライアントIP、処理時間、推論リクエストの場合はトークン数を含む。
  移行前データフラグを持つ。
- **AuditBatchHash（バッチハッシュ）**: 5分間隔のバッチに対するSHA-256ハッシュ。
  バッチ開始時刻、終了時刻、含まれるレコード数、ハッシュ値、
  前バッチのハッシュ値を含む。チェーン構造を形成する。
- **AuditArchive（アーカイブ）**: 90日以上経過したデータの保管先。
  オンラインデータと同一の構造を持ち、検索可能。

## Clarifications

### Session 2026-02-20

- Q: 非同期バッファからDBへのフラッシュ間隔は? → A: 30秒ごとにフラッシュ
- Q: ページネーションのデフォルト表示件数は? → A: 50件/ページ
- Q: 非同期バッファのメモリ上限と超過時の動作は? → A: 上限10,000件、超過時は最古エントリを破棄
- Q: ハッシュチェーン検証で改ざん検出時の動作は? → A: アラート出力して記録続行（新バッチチェーン開始）

## 成功基準

### 測定可能な結果

- **SC-001**: 全HTTP操作（除外対象を除く）の100%が監査ログに記録される
- **SC-002**: 監査ログの書き込みが推論リクエストのレイテンシを1ms以上増加させない
- **SC-003**: 管理者がダッシュボードで監査ログの検索・フィルタを10秒以内に完了できる
  （10万件のデータに対して）
- **SC-004**: ハッシュチェーン検証により、1レコードでも改ざんされた場合に
  100%検出できる
- **SC-005**: request\_history廃止後も、トークン統計（累計、日次、月次）が
  従来と同一の結果を返す
- **SC-006**: 90日分のデータ（推定100万レコード）に対して、
  構造化フィルタ検索が3秒以内に結果を返す
- **SC-007**: サーバーが予期せずクラッシュした場合でも、
  直前のバッファフラッシュまでのデータは保全される
