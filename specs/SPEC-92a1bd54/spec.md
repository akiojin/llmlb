# 機能仕様書: Open Responses API対応

**機能ID**: `SPEC-92a1bd54`
**作成日**: 2026-01-16
**ステータス**: 完了
**入力**: ユーザー説明: "Open Responses API対応 - llmlbにOpen Responses API
（OpenAI Responses APIベースのオープン仕様）のパススルー機能を追加する。ロードバランサーは
ロードバランサーとして機能し、/v1/responsesエンドポイントへのリクエストを
Responses API対応バックエンド（Ollama、vLLM、xLLM等）にそのまま転送する。
ストリーミングイベントの完全パススルー、バックエンド対応状況の自動検出、
/v1/modelsへの対応API情報追加を含む。非対応バックエンドへのリクエストは
501 Not Implementedを返す。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - Responses APIリクエストの送信 (優先度: P1)

APIクライアント（Claude Code、Codex等のエージェント型アプリケーション）は、
Open Responses API形式でリクエストを送信し、対応バックエンドから応答を受け取りたい。
これにより、業界標準のResponses API仕様を使用して会話型AIとやり取りできる。

**この優先度の理由**: これが本機能の中核であり、Responses APIを使用するクライアントが
ロードバランサーを経由してバックエンドと通信するための基本機能。
この機能なしでは他の機能は意味を持たない。

**独立テスト**: `/v1/responses`エンドポイントにリクエストを送信し、バックエンドからの
応答が正しく返されることを確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** Responses API対応バックエンドが1台以上登録されている、
   **実行** クライアントが`/v1/responses`にリクエストを送信する、
   **結果** バックエンドからの応答がそのままクライアントに返される
2. **前提** 複数のResponses API対応バックエンドが登録されている、
   **実行** クライアントが`/v1/responses`にリクエストを送信する、
   **結果** 負荷分散に従って適切なバックエンドが選択され応答が返される

---

### ユーザーストーリー2 - ストリーミング応答の受信 (優先度: P1)

APIクライアントは、長い応答をリアルタイムで受信したい。
ストリーミングを有効にすることで、応答が生成されるにつれて
トークン単位でデータを受け取ることができる。

**この優先度の理由**: ストリーミングはResponses APIの重要な機能であり、
ユーザー体験に直接影響する。長い応答を待たずにリアルタイムで表示できるため、
エージェントアプリケーションにとって必須機能。

**独立テスト**: `stream=true`でリクエストを送信し、イベントストリームとして
応答が受信されることを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提** Responses API対応バックエンドが登録されている、
   **実行** クライアントが`stream=true`で`/v1/responses`にリクエストを送信する、
   **結果** Open Responses仕様のストリーミングイベントがそのまま転送される
2. **前提** ストリーミング中にバックエンドがエラーを返す、
   **実行** エラーイベントが発生する、
   **結果** エラーイベントがそのままクライアントに転送される

---

### ユーザーストーリー3 - バックエンドのAPI対応状況確認 (優先度: P2)

システム管理者またはAPIクライアントは、どのバックエンドがResponses APIに
対応しているかを事前に確認したい。これにより、適切なAPIを選択して利用できる。

**この優先度の理由**: クライアントが事前に対応状況を把握できることで、
非対応エンドポイントへのリクエストを避け、エラーを未然に防止できる。
ただし、P1機能が動作すれば最低限の利用は可能。

**独立テスト**: `/v1/models`エンドポイントを呼び出し、各バックエンドの
対応API情報が含まれていることを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提** Responses API対応バックエンドと非対応バックエンドが混在している、
   **実行** クライアントが`/v1/models`を呼び出す、
   **結果** 各バックエンドの対応API情報（chat_completions、responses等）が返される
2. **前提** 新しいバックエンドが登録される、
   **実行** ヘルスチェックが実行される、
   **結果** バックエンドのResponses API対応状況が自動検出される

---

### ユーザーストーリー4 - 非対応バックエンドへのエラー応答 (優先度: P2)

APIクライアントは、Responses APIに対応していないバックエンドへリクエストを
送信した場合、明確なエラーメッセージを受け取りたい。これにより、
問題の原因を特定し、適切な対応を取ることができる。

**この優先度の理由**: エラーハンドリングは堅牢なシステムに必須であり、
クライアントが問題を理解し対処するために重要。
ただし、正常系が動作すれば基本的な利用は可能。

**独立テスト**: Responses API非対応のバックエンドのみが登録された状態で
`/v1/responses`にリクエストを送信し、501エラーが返されることを確認。

**受け入れシナリオ**:

1. **前提** Responses API対応バックエンドが存在しない、
   **実行** クライアントが`/v1/responses`にリクエストを送信する、
   **結果** 501 Not Implementedエラーが返される
2. **前提** Responses API対応バックエンドが存在しない、
   **実行** クライアントが`/v1/responses`にリクエストを送信する、
   **結果** エラーメッセージに「Responses API対応バックエンドがない」旨が含まれる

---

### エッジケース

- バックエンドがリクエスト処理中にダウンした場合、適切なエラーが返される
- ストリーミング中に接続が切断された場合、リソースが適切に解放される
- 非常に長いリクエストボディが送信された場合、既存の制限に従って処理される
- 認証情報が無効な場合、既存の認証エラーが返される

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは`/v1/responses`エンドポイントでResponses APIリクエストを
  受け付ける必要がある
- **FR-002**: システムはResponses APIリクエストを対応バックエンドにそのまま転送する
  必要がある（変換なし）
- **FR-003**: システムはバックエンドからの応答をクライアントにそのまま返す必要がある
  （変換なし）
- **FR-004**: システムは`stream=true`のリクエストに対してストリーミングイベントを
  パススルーする必要がある
- **FR-005**: システムはバックエンドのResponses API対応状況をヘルスチェック時に
  自動検出する必要がある
- **FR-006**: システムは`/v1/models`レスポンスに各バックエンドの対応API情報を
  含める必要がある
- **FR-007**: システムはResponses API非対応バックエンドへのリクエストに対して
  501 Not Implementedを返す必要がある
- **FR-008**: システムは既存のAPIキー認証を`/v1/responses`エンドポイントに
  適用する必要がある

### 主要エンティティ

- **Responses APIリクエスト**: クライアントから送信されるOpen Responses仕様の
  リクエスト。`model`、`input`、`instructions`等の属性を含む
- **Responses API応答**: バックエンドから返されるOpen Responses仕様の応答。
  `id`、`output`、`usage`等の属性を含む
- **ストリーミングイベント**: リアルタイム応答のためのサーバー送信イベント。
  `response.created`、`response.output_item.added`、`response.done`等のイベントタイプ
- **バックエンドAPI対応情報**: 各バックエンドがサポートするAPIの一覧。
  `chat_completions`、`responses`等の値を含む

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- **ステートフル機能の実装**: `previous_response_id`による会話継続はバックエンド責務
- **ツール実行**: `web_search`、`file_search`、`code_interpreter`等のツール実行は
  クライアント責務
- **API変換**: Chat Completions APIからResponses APIへの変換機能
- **MCP対応**: Model Context Protocolとの統合

---

## 技術制約 *(該当する場合)*

- ロードバランサーはパススルーのみを行い、リクエスト/レスポンスの変換は行わない
- ステートフル機能（previous_response_id）はバックエンドが実装する必要がある
- 既存の認証・認可機構をそのまま使用する

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- バックエンド（Ollama、vLLM、xLLM等）がOpen Responses APIを実装している
- 既存のエンドポイント登録・ヘルスチェック機構が動作している
- 既存のストリーミングプロキシ機能が利用可能である

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- **SPEC-e8e9326e**: ロードバランサー主導エンドポイント登録システム（エンドポイント管理）
- 既存のAPIキー認証機構
- 既存のHTTPプロキシ/ストリーミング機能

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. Responses API対応バックエンドへのリクエストが正常に処理され、応答が返される
2. ストリーミングリクエストでイベントがリアルタイムに転送される
3. `/v1/models`で各バックエンドのAPI対応状況が確認できる
4. 非対応バックエンドへのリクエストで501エラーが返される
5. 既存のChat Completions APIが引き続き正常に動作する（回帰なし）
