# 機能仕様書: ノードベースモデル管理とモデル対応ルーティング

**機能ID**: `SPEC-93536000`
**作成日**: 2026-01-03
**ステータス**: 下書き

## ユーザーシナリオ&テスト

### ユーザーストーリー1 - モデル対応ノードへの正確なルーティング (優先度: P1)

ユーザーがOpenAI互換APIでチャットリクエストを送信すると、システムは指定されたモデルを
実行可能なノードにのみリクエストをルーティングする。これにより、Metal専用モデルが
CUDAノードに送られたり、CUDA専用モデルがmacOSノードに送られるといった問題を防ぐ。

**この優先度の理由**: ルーティングの正確性はシステムの根幹機能であり、誤ったルーティングは
推論失敗を引き起こす致命的な問題となる。

**独立テスト**: Metal専用モデルへのリクエストがmacOSノードにのみルーティングされ、
CUDAノードには決して送られないことをテストできる。

**受け入れシナリオ**:

1. **前提** macOSノード（Metal）とLinuxノード（CUDA）が登録されている、
   **実行** Metal専用モデルへのリクエストを送信、
   **結果** リクエストはmacOSノードにのみルーティングされる

2. **前提** CUDAノードのみがオンラインでMetal専用モデルをリクエスト、
   **実行** チャットリクエストを送信、
   **結果** 503 Service Unavailableエラーが返される（対応ノードなし）

3. **前提** 複数のmacOSノードがオンライン、
   **実行** Metal専用モデルへのリクエストを送信、
   **結果** 負荷分散ロジックに従い、対応ノードの中から1つが選択される

---

### ユーザーストーリー2 - 利用可能モデル一覧の動的取得 (優先度: P1)

ユーザーが`/v1/models`エンドポイントを呼び出すと、現在オンラインのノードが
実行可能なモデルのみが返される。オフラインのノードが持つモデルは含まれない。

**この優先度の理由**: ユーザーは利用可能なモデルを事前に確認し、存在しないモデルへの
リクエストを避ける必要がある。

**独立テスト**: ノードのオンライン/オフライン状態を変更し、`/v1/models`の
レスポンスが動的に変化することをテストできる。

**受け入れシナリオ**:

1. **前提** ノードAとノードBがオンラインで異なるモデルセットを持つ、
   **実行** `/v1/models`を呼び出す、
   **結果** 両ノードの実行可能モデルが統合されて返される

2. **前提** ノードAがオフラインになった、
   **実行** `/v1/models`を呼び出す、
   **結果** ノードAのモデルはリストに含まれない

3. **前提** すべてのノードがオフライン、
   **実行** `/v1/models`を呼び出す、
   **結果** 空のモデルリストが返される

---

### ユーザーストーリー3 - 存在しないモデルへの明確なエラー (優先度: P2)

ユーザーが`/v1/models`に含まれていないモデルを指定してリクエストを送信すると、
明確な404 Model Not Foundエラーが返される。

**この優先度の理由**: ユーザーが誤ったモデル名を指定した場合、即座にフィードバックを
得られることで、デバッグ時間を短縮できる。

**独立テスト**: 存在しないモデル名でリクエストを送信し、404エラーが返ることをテストできる。

**受け入れシナリオ**:

1. **前提** オンラインノードが存在する、
   **実行** 存在しないモデル名でリクエストを送信、
   **結果** 404 Model Not Foundエラーが返される

2. **前提** モデル"llama2-7b"がオンラインノードで利用可能、
   **実行** "llama2-7b"でリクエストを送信、
   **結果** 正常にルーティングされる

---

### ユーザーストーリー4 - ノード側でのGPU互換モデル報告 (優先度: P1)

ノードは起動時に自身のGPUバックエンド（Metal/CUDA/DirectML/ROCm）を検出し、
そのGPUで実行可能なモデル一覧をルーターに報告する。

**この優先度の理由**: これがシステム全体の基盤となる。ノードが正確にモデル対応を
報告しなければ、ルーティングの正確性は保証できない。

**独立テスト**: macOSノードを起動し、Metal対応モデルのみがルーターに報告されることを
テストできる。

**受け入れシナリオ**:

1. **前提** macOSノードが起動、
   **実行** ルーターに登録、
   **結果** ノードはMetal対応モデルのみをexecutable_modelsとして報告

2. **前提** LinuxノードがNVIDIA GPUを検出、
   **実行** ルーターに登録、
   **結果** ノードはCUDA対応モデルをexecutable_modelsとして報告

3. **前提** GPU非搭載ノード、
   **実行** ルーターに登録を試みる、
   **結果** 登録が拒否される（既存の仕様通り）

---

### エッジケース

- モデルが複数のGPUバックエンドに対応している場合、すべての対応ノードが候補となる
- ノードがハートビート中にexecutable_modelsを更新した場合、ルーターは即座に反映する
- ノードが応答しなくなった場合、そのノードのモデルは`/v1/models`から除外される

## 要件

### 機能要件

- **FR-001**: ノードは起動時にGPUバックエンド（Metal/CUDA/DirectML/ROCm/CPU）を自動検出する
- **FR-002**: ノードはGPU互換性に基づいて実行可能なモデル一覧を決定する
- **FR-003**: ノードは`/v1/models`エンドポイントで実行可能モデルとGPUバックエンドを返す
- **FR-004**: ノードはハートビートで実行可能モデル一覧をルーターに送信する
- **FR-005**: ルーターはオンラインノードの実行可能モデルを集約して`/v1/models`で返す
- **FR-006**: ルーターはリクエスト受信時、指定モデルを実行可能なノードにのみルーティングする
- **FR-007**: 対応ノードがない場合、503 Service Unavailableを返す
- **FR-008**: `/v1/models`にないモデル指定時は404 Model Not Foundを返す
- **FR-009**: ノードはsupported_models.jsonをビルド時に埋め込み、GPU互換性判定に使用する
- **FR-010**: ルーター側のsupported_models.json（REGISTERED_MODELS）は完全に削除する

### 廃止要件

- **DEPRECATED-001**: SPEC-dcaeaec4のFR-9「全ノード全モデル対応の原則」を完全廃止する
- **DEPRECATED-002**: ルーターの中央集権的なモデル管理（supported_models.json）を廃止する

### 主要エンティティ

- **GpuBackend**: ノードのGPU種別（Metal, CUDA, DirectML, ROCm, CPU）
- **Node.executable_models**: ノードが実行可能なモデルID一覧
- **Node.gpu_backend**: ノードのGPUバックエンド種別

## スコープ外

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- VRAMサイズに基づく動的モデルフィルタリング
- モデルの動的ダウンロード・アンロード連携
- 複数GPUを持つノードの個別GPU指定

## 技術制約

- ノードがexecutable_modelsを報告しない場合、そのノードはルーティング対象外となる
- 後方互換性は不要（旧バージョンノードはサポートしない）

## 前提条件

この機能は以下を前提とします:

- ノードはビルド時にsupported_models.jsonを組み込み済み
- 各モデルにはplatforms属性（対応GPUバックエンドリスト）が定義されている

## 依存関係

この機能は以下に依存します:

- SPEC-dcaeaec4: LLM-Router独自モデルストレージ（FR-9を廃止）
- SPEC-05098000: リクエストキューイングシステム（ルーティングロジック拡張）

## 成功基準

以下の成功基準を満たす必要があります:

1. Metal専用モデルへのリクエストがCUDAノードにルーティングされることは決してない
2. CUDA専用モデルへのリクエストがmacOSノードにルーティングされることは決してない
3. `/v1/models`はオンラインノードの実行可能モデルのみを返す
4. 対応ノードがないモデルへのリクエストは503エラーで即座に拒否される
5. 存在しないモデルへのリクエストは404エラーで即座に拒否される
6. ノードのオンライン/オフライン変更は10秒以内に`/v1/models`に反映される
