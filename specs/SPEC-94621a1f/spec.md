# 機能仕様書: ノード自己登録システム

**機能ID**: `SPEC-94621a1f`
**作成日**: 2025-10-30
**ステータス**: ⚠️ 廃止予定 (Deprecated)
**元のSPEC**: SPEC-32e2b31a から分割
**後継SPEC**: SPEC-66555000（ルーター主導エンドポイント登録システム）

> **⚠️ 廃止予定**
>
> このSPECは **SPEC-66555000（ルーター主導エンドポイント登録システム）** により廃止されます。
>
> **廃止理由**:
>
> - ノード主導の自己登録からルーター主導のエンドポイント登録に移行
> - 自社ノードだけでなく、Ollama/vLLM/OpenAI互換APIも統一管理
> - プッシュ型ハートビートからプル型ヘルスチェックに変更
>
> **影響を受けるAPI**:
>
> - `POST /v0/nodes` → 廃止（`POST /v0/endpoints` に置換）
> - `POST /v0/health` → 廃止（ルーター側からのプル型ヘルスチェックに変更）
> - `X-Node-Token` → 廃止

## 概要

各マシンでノードアプリケーションを起動し、ルーターに自動的に登録される機能。
ノードはルーターとの接続状態を管理し、ハートビートを送信する。
登録されたノードは管理者の承認を経て運用対象になる。

## ユーザーシナリオ＆テスト

### ユーザーストーリー - ノードの自己登録と接続管理

ユーザーは各マシンでノードアプリケーションを起動し、ルーターに自動的に登録される。Windows / macOS 環境ではノードがシステムトレイに常駐し、ルーターとの接続状態をリアルタイムで表示する。Linux では従来通り CLI 常駐プロセスとして動作する。

**この優先度の理由**: ノード登録はシステムの基盤機能であり、これがなければ他のすべての機能が動作しない。最小限の機能で動作確認が可能。

**独立テスト**: ノードを起動してルーターのURLを設定し、登録が成功することで完全にテスト可能。ルーター側で登録されたノード一覧を確認できれば価値を提供する。

**受け入れシナリオ**:

1. **前提** ノードアプリがインストールされていない、**実行** ノードをインストールして起動する、**結果** システムトレイにアイコンが表示され、設定ウィンドウが自動的に開く
2. **前提** ノードが起動している、**実行** 設定ウィンドウでルーターのURL（例: `http://192.168.1.10:32768`）を入力して「接続」をクリックする、**結果** ノードがルーターに登録され、接続状態が「接続済み」と表示される
3. **前提** ノードが登録されている、**実行** ルーターのダッシュボードを開く、**結果** 登録されたノードが「pending」として一覧に表示され、マシン名、IPアドレス、LLM runtimeのバージョンが確認できる
4. **前提** 管理者がダッシュボードにログインしている、**実行** pending のノードを承認する、**結果** ノードが Registering/Online に遷移し、運用対象になる
5. **前提** ノードが登録されている、**実行** ノードアプリを終了する、**結果** ルーターのダッシュボードで該当ノードが「オフライン」状態になる
6. **前提** ルーターをホストするマシンである、**実行** そのマシンでノードを起動する、**結果** 同一マシン上のルーターに正常に登録され、localhostとして認識される
7. **前提** WindowsまたはmacOS上でノードを起動している、**実行** システムトレイアイコンをダブルクリックする、**結果** ローカル設定パネルがブラウザで開き、ルーターURLやポートなどを入力・保存できる（保存内容は次回起動時に反映）
8. **前提** CLI からノードを起動する、**実行** `LLM_ROUTER_URL=http://router:32768 ./allm` のように環境変数を指定する、**結果** 保存済み設定より優先して該当URLで登録が行われる
9. **前提** 既存ノードが再起動する、**実行** ノードが再登録される、**結果** 毎回 pending に戻り、再承認が必要になる

## エッジケース

- ノードが複数のネットワークインターフェースを持つ場合、どのIPアドレスを登録に使用するか？
- ルーターが再起動された際、以前に登録されていたノードの情報は保持されるか？それとも再登録が必要か？
- ノードとルーター間のネットワークが不安定な場合、どのくらいの頻度で再接続を試みるか？

## 機能要件

### FR-001: ノード登録API

ルーターは、ノードからの登録リクエストを受け付けるREST APIを提供する。

- エンドポイント: `POST /v0/nodes`
- リクエストボディ: マシン名、IPアドレス、LLM runtimeバージョン、ポート番号
- レスポンス: 登録成功/失敗のステータス、ノードID、`node_token`（`POST /v0/health` 用）
- 登録直後のノード状態は常に `pending`（既存ノードの再登録も含む）

### FR-002: ノード一覧API

登録されたノードの一覧を取得するAPIを提供する。

- エンドポイント: `GET /v0/nodes`
- レスポンス: ノードID、マシン名、IPアドレス、ステータス、最終確認時刻

### FR-003: ハートビート送信

ノードは定期的にルーターにヘルスチェック（ハートビート＋メトリクス）を送信し、稼働状態を通知する。

- 送信間隔: 30秒ごと
- エンドポイント: `POST /v0/health`（`X-Node-Token` 必須）
- タイムアウト: 60秒以内に応答がない場合はオフラインとみなす

### FR-004: データ永続化

ルーターは登録されたノード情報を永続化し、再起動後も情報を保持する。

- ストレージ: SQLite（`DATABASE_URL`、SQLx migrations）
- 起動時にデータを読み込み、メモリ上で管理（DBと同期）

### FR-005: Windows/macOSシステムトレイ統合

- Windows 10 以降と macOS 12 以降では、ノード起動と同時にシステムトレイ（メニューバー）へ常駐し、アイコンを表示する。
- トレイアイコンのダブルクリック、またはコンテキストメニューの「設定パネルを開く」を選択すると、ローカルでホストしている設定パネル (`http://127.0.0.1:<dynamic>/`) が開き、ルーターURLや監視間隔を編集できる。
- 「Dashboardを開く」から `ROUTER_URL/dashboard` に遷移でき、コンテキストメニューの「ノードを終了」で常駐プロセスを停止できる。
- Linux など非対応プラットフォームでは従来のCLI常駐プロセス（トレイなし）として動作する。

### FR-006: 環境変数／設定パネルによる上書き

- ノードのエントリーポイントは `LLM_ROUTER_URL`, `ALLM_PORT`, `ALLM_HEARTBEAT_SECS` などの環境変数で設定を上書きできる。
- 同じ設定項目はローカル設定ファイル（デフォルト: `~/.llm-router/config.json`、または `ALLM_CONFIG`）からも読み込まれ、環境変数が未指定のときに適用される。

### FR-007: ノード承認フロー

管理者が承認したノードのみ運用対象となる。

- ノード登録時は常に `pending` として保存する（再登録も含む）
- `pending` 中のハートビートは受け付け、メトリクスは更新するが状態は遷移しない
- 承認 API で `pending` を `registering` または `online` に遷移させる
- ready_models が揃っている場合は即時 `online`、揃っていない場合は `registering`
- `pending` のノードはルーティング対象外

## 非機能要件

### NFR-001: パフォーマンス

- ノード登録APIは100ms以内にレスポンスを返す
- 最大1000台のノードを同時に管理可能

### NFR-002: 可用性

- ルーターの再起動時、ノード情報は失われない
- ノードは接続失敗時、指数バックオフで再接続を試みる

### NFR-003: セキュリティ

- 登録/一覧は認証なし（プライベートネットワーク前提）
- 承認APIは管理者認証（JWT）を必須とする
- ノード→ルーターのヘルスチェックは `X-Node-Token` による認証を必須とする

## 実装状態

🔄 **更新中**

- ノード承認フローの追加

---

## Clarifications

### Session 2025-12-24

仕様を精査した結果、重大な曖昧さは検出されませんでした。

**確認済み事項**:

- 登録API: POST /v0/nodes（FR-001で明記）
- 一覧API: GET /v0/nodes（FR-002で明記）
- ハートビート: POST /v0/health、30秒間隔、X-Node-Token必須（FR-003で明記）
- 永続化: SQLite（FR-004で明記）
- 初期状態: 常にpending（再登録含む）（FR-001, FR-007で明記）
- 承認フロー: pending → registering/online（FR-007で明記）

**プラットフォーム対応**:

- Windows/macOS: システムトレイ統合（FR-005で明記）
- Linux: CLI常駐プロセス

**環境変数の確認**:

- LLM_ROUTER_URL, ALLM_PORT, ALLM_HEARTBEAT_SECS

### Session 2025-12-30

インタビューにより以下が確定:

**ノード独立動作**:

- **完全独立動作可能**: ノードはルーターなしでも単独で動作可能
  - ローカルAPIエンドポイントで直接推論リクエストを受付
  - モデル管理もローカルで完結
- **オフライン時の挙動**: ルーターとの接続が切断されても推論機能は継続
  - ルーティング対象外になるのみ
  - ローカルアクセス（localhost）は影響なし
- **ユースケース**:
  - 開発・テスト環境でのスタンドアロン利用
  - ネットワーク障害時の継続運用
  - 簡易構成でのデプロイ

**localhost接続の認証**:

- **認証スキップ**: ノードへのlocalhost接続は認証不要
  - `127.0.0.1` / `::1` からのアクセスのみ
- **理由**: 開発・デバッグの利便性確保

---

## 依存関係 *(該当する場合)*

### 前提条件（このSPECが依存するもの）

- なし（基盤機能）

### 依存元（このSPECに依存するもの）

- **SPEC-63acef08**: 統一APIプロキシ
- **SPEC-443acc8c**: ヘルスチェック機構
- **SPEC-712c20cf**: 管理ダッシュボード
