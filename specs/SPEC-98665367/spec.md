# 機能仕様書: CI/CD パイプライン

**機能ID**: `SPEC-98665367`
**作成日**: 2026-01-09
**ステータス**: ✅ 実装完了
**統合元SPEC**: SPEC-47c6f44c（自動マージ）, SPEC-ee2aa3ef（自動リリース）

## 概要

本仕様は、llmlb プロジェクトの継続的インテグレーション/継続的デリバリー
（CI/CD）パイプラインを定義する。品質チェック、自動マージ、自動リリース、
マルチプラットフォームバイナリビルドを統合し、開発からリリースまでの
ワークフローを完全自動化する。

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - PR作成後の自動品質チェック (優先度: P1)

開発者として、PRを作成したら自動的に品質チェックが実行され、
結果を確認するだけで品質基準を把握したい。

**受け入れシナリオ**:

1. **前提** PRを作成、**実行** GitHub Actionsが起動、
   **結果** 以下のチェックが並列実行される:
   tasks-check、cargo test、cargo fmt --check、cargo clippy、commitlint、markdownlint
2. **前提** 未完了タスクが存在、**実行** PR作成、
   **結果** tasks-checkジョブが失敗し、失敗理由が表示される
3. **前提** すべてのチェックが合格、**実行** PR作成、
   **結果** 全ジョブが成功し、緑のチェックマークが表示される

---

### ユーザーストーリー2 - 品質チェック合格後の自動マージ (優先度: P1)

メンテナとして、品質チェックが合格したPRは自動的にマージされることで、
手動操作を最小化したい。

**受け入れシナリオ**:

1. **前提** PRがReady for review、**実行** Auto Mergeワークフロー起動、
   **結果** 「Auto-merge enabled (MERGE)」が表示される
2. **前提** Auto-merge有効でRequiredチェック合格、**実行** 追加操作なし、
   **結果** GitHubが自動的にMERGEコミットを追加する
3. **前提** PRがドラフト状態、**実行** ワークフロー実行、
   **結果** Auto-mergeは有効化されずスキップされる

---

### ユーザーストーリー3 - alpha版自動リリース (優先度: P1)

開発者として、developブランチへのマージ完了後、
alpha版が自動リリースされることで、早期フィードバックを得たい。

**受け入れシナリオ**:

1. **前提** developブランチへのマージ完了、**実行** マージ後の自動処理、
   **結果** alpha版番号（例: v1.2.3-alpha.1）でリリースが自動作成される
2. **前提** alpha版リリース作成、**実行** リリースページを確認、
   **結果** バージョン番号、変更履歴、リリースタグが正しく記録されている

---

### ユーザーストーリー4 - 正式版リリース (優先度: P1)

リリースリーダーとして、コマンド一つで正式リリースプロセスを開始し、
品質チェックから本番マージ、バイナリ公開まで完全自動で実行したい。

**受け入れシナリオ**:

1. **前提** developブランチの準備完了、**実行** リリースコマンド実行、
   **結果** develop→mainへのPRが自動作成される
2. **前提** mainブランチへのマージ完了、**実行** リリース処理の自動実行、
   **結果** 正式版番号（例: v1.3.0）でリリースが作成され、
   すべてのプラットフォームのバイナリが公開される

---

### ユーザーストーリー5 - ホットフィックス (優先度: P2)

開発者として、本番で重大なバグを発見したら、
ホットフィックスコマンドで迅速にパッチリリースしたい。

**受け入れシナリオ**:

1. **前提** 本番環境で問題を発見、**実行** ホットフィックスコマンド実行、
   **結果** ホットフィックスブランチが作成される
2. **前提** 修正完了、**実行** main→PRを作成、
   **結果** 品質チェック合格後にパッチ版（例: v1.2.4）でリリース作成

---

### エッジケース

- 同時に複数のPRが作成された場合、各PRは独立して品質チェックと自動マージが実行される
- 品質チェック実行中にPRが更新された場合、新しいチェックが再実行される
- ネットワーク障害でリリースプロセスが中断された場合、適切なエラーメッセージを表示する
- バージョン番号の衝突が発生した場合、自動的に次の適切なバージョンを計算する

## 要件 *(必須)*

### 機能要件

#### 品質チェック

- **FR-001**: PR作成時に自動的にGitHub Actionsワークフローを起動する
- **FR-002**: tasks.mdの全タスク完了（`- [x]`形式）をチェックする
- **FR-003**: Rustテスト（`cargo test --all-features --workspace`）を実行する
- **FR-004**: Rust lint（`cargo fmt --check`, `cargo clippy -D warnings`）を実行する
- **FR-005**: コミットメッセージがConventional Commits準拠であることを検証する
- **FR-006**: markdownlintを実行してマークダウンファイルの形式を検証する
- **FR-007**: 品質チェックジョブを並列実行し、実行時間を最小化する

#### 自動マージ

- **FR-008**: `pull_request_target`イベントでDraftでないPRを対象に自動マージを有効化する
- **FR-009**: `mergeable`が`MERGEABLE`のときのみ自動マージを有効化する
- **FR-010**: MERGE方式でマージし、コミット履歴を保持する
- **FR-011**: 既にAuto-merge有効化済みのPRは冪等的にスキップする
- **FR-012**: ドラフトPRではAuto-mergeを有効化しない

#### リリース

- **FR-013**: コミットメッセージから次のバージョン番号を自動計算する（semantic-release）
- **FR-014**: developブランチへのマージ時にalpha版リリースを自動作成する
- **FR-015**: mainブランチへのマージ時に正式版リリースとバイナリを自動作成する
- **FR-016**: リリースごとに変更履歴（CHANGELOG）を自動更新する
- **FR-017**: リリースごとにGitタグとGitHubリリースを自動作成する
- **FR-018**: 正式版リリース時に主要プラットフォームのバイナリを自動ビルドする

### 非機能要件

#### パフォーマンス

- **NFR-001**: 品質チェック（lint + test）は5分以内に完了する
- **NFR-002**: Rustビルド（debug）は3分以内に完了する
- **NFR-003**: Rustビルド（release、単一プラットフォーム）は10分以内に完了する
- **NFR-004**: 全プラットフォームバイナリビルドは30分以内に完了する
- **NFR-005**: alpha版リリース（マージからリリース作成まで）は5分以内に完了する
- **NFR-006**: 正式版リリース（コマンド実行からバイナリ公開まで）は30分以内に完了する

#### 可用性

- **NFR-007**: GitHub Actions実行環境の可用性はGitHub SLAに依存する（99.9%）
- **NFR-008**: 単一ジョブの失敗が他のジョブに影響しない（独立実行）
- **NFR-009**: 失敗時は明確なエラーメッセージを表示し、再実行可能である

#### キャッシュ

- **NFR-010**: Cargoの依存関係はキャッシュされ、2回目以降のビルドは高速化される
- **NFR-011**: キャッシュヒット時、依存関係解決は30秒以内に完了する

#### 並列性

- **NFR-012**: 品質チェックの各ジョブ（tasks-check, test, lint, commitlint, markdownlint）は
  並列実行される
- **NFR-013**: マルチプラットフォームビルドは並列実行される
  （Linux, Windows, macOS x86_64, macOS ARM64）

#### セキュリティ

- **NFR-014**: GitHub ActionsのGITHUB_TOKENは最小権限で使用する
- **NFR-015**: シークレット情報はログに出力しない
- **NFR-016**: 外部依存のバージョンは固定し、サプライチェーン攻撃を防止する

### 主要エンティティ

- **品質チェックワークフロー**: 5つの独立したジョブを並列実行し、全体の成功/失敗を判定
- **自動マージワークフロー**: PRの状態を検証し、GitHub自動マージを有効化
- **リリースワークフロー**: バージョン計算、タグ作成、バイナリビルド、公開を実行
- **commitlint設定**: `.commitlintrc.json`でConventional Commits準拠を強制

---

## スコープ外 *(オプション)*

- PRへの自動コメント投稿（失敗理由の詳細な説明）
- PRラベルの自動付与
- Slackやメールによる通知
- ベータ版・リリース候補版などの追加プレリリース形式
- リリース後のロールバック機能
- バイナリの署名・検証機能
- Unity C#テストの統合
- TypeScriptコンパイルチェックの統合

---

## 技術制約 *(該当する場合)*

- GitHub Actions環境での実行が前提
- GitHub Actionsの実行時間制限（デフォルト6時間）内に完了する必要がある
- Rustプロジェクトのワークスペース構成に対応
- semantic-releaseを使用したバージョン管理
- Conventional Commits形式のコミットメッセージが必須
- tasks.mdは`- [ ]` / `- [x]`形式を維持する必要がある

---

## 前提条件 *(該当する場合)*

- GitHub CLIが認証済みである
- `.specify/scripts/checks/`以下のチェックスクリプトが正常に動作する
- Rustプロジェクトのビルド環境が正常に構成されている
- mainブランチへのpush権限がGitHub Actionsに付与されている
- 開発者がConventional Commits形式でコミットメッセージを記述する

---

## 依存関係 *(該当する場合)*

- `.specify/scripts/checks/check-tasks.sh`: tasks.md完了チェック
- `.specify/scripts/checks/check-commits.sh`: commitlintチェック
- GitHub Actions: ワークフロー実行プラットフォーム
- GitHub GraphQL API: 自動マージ有効化API
- semantic-release: バージョン管理・リリース自動化
- commitlint: コミットメッセージ検証ツール
- markdownlint: マークダウンファイルlintツール

---

## GitHub Actions ワークフロー構成

| ワークフロー | トリガー | 役割 |
|-------------|---------|------|
| `ci.yml` | push, pull_request | メインCI（ビルド・テスト） |
| `lint.yml` | push, pull_request | Lint検証（fmt, clippy, markdownlint） |
| `test.yml` | push, pull_request | テスト実行 |
| `auto-merge.yml` | pull_request_target | 自動マージ有効化 |
| `prepare-release.yml` | workflow_dispatch | リリース準備（develop→main PR作成） |
| `release.yml` | push to main | 正式版リリース処理 |
| `publish.yml` | release | バイナリビルド・公開 |

---

## 成功基準 *(必須)*

1. **品質チェック自動実行**: PR作成から5分以内に全ての品質チェックが完了する
2. **自動マージ設定成功率**: オープンなPRの95%以上で自動マージが有効化される
3. **TDD履歴保持**: マージ後、featureブランチのコミット履歴がmainで完全に保持される
4. **ドラフトPR除外**: ドラフトPRが100%自動マージから除外される
5. **commitlint準拠**: 規約違反のコミットを含むPRが100%品質チェックで失敗する
6. **alpha版リリース**: developへのマージから5分以内にalpha版リリースが確認できる
7. **正式版リリース**: コマンド実行から30分以内にバイナリ公開が完了する
8. **バージョン計算精度**: コミットメッセージから正しいバージョンが100%計算される

---

## Clarifications

### Session 2026-01-09

SPEC-47c6f44c（自動マージ）とSPEC-ee2aa3ef（自動リリース）を統合し、
非機能要件（ビルド時間、可用性、キャッシュ、並列性、セキュリティ）を追加。

**確認済み事項**:

- 品質チェック項目: tasks-check, cargo test, cargo fmt/clippy, commitlint, markdownlint
- マージ方式: MERGE方式（履歴保持）
- 自動マージ条件: mergeable=MERGEABLEかつDraftでないPR
- alpha版リリース: develop→マージ時に自動作成
- 正式版リリース: main→マージ時に自動作成 + バイナリ公開
- バージョン計算: コミットメッセージから自動計算（semantic-release）
- 対応プラットフォーム: Linux x86_64, Windows x86_64, macOS x86_64/ARM64
- ビルド時間目標: 品質チェック5分、全バイナリビルド30分
