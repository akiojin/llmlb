# 機能仕様書: ノード登録承認フロー

**機能ID**: `SPEC-98934000`
**作成日**: 2026-01-09
**ステータス**: 実装完了
**入力**: ユーザー説明: "ノード登録承認フロー: ノードがルーターに登録リクエストを送信（Push型）し、管理者が手動で承認/拒否する機能。承認前のノードには推論リクエストがルーティングされない。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - ノード登録と承認待ち状態 (優先度: P1)

ノード運用者として、LLM推論ノードをルーターに登録したい。登録後、ノードは「承認待ち」状態となり、管理者の承認を待つ。

**この優先度の理由**: ノード登録はシステムの基盤機能であり、これがないと分散推論ができない。

**独立テスト**: ノードを起動してルーターに登録リクエストを送信し、ダッシュボードで「Pending」状態として表示されることを確認する。

**受け入れシナリオ**:

1. **前提** ルーターが稼働中で、新規ノードが未登録の状態、**実行** ノードを起動してルーターに登録リクエストを送信、**結果** ノードは「Pending」状態でルーターに登録され、ダッシュボードに表示される
2. **前提** ノードがGPUを搭載していない状態、**実行** ノードを起動して登録リクエストを送信、**結果** 登録は拒否され、「GPU必須」エラーが返される
3. **前提** ルーターが到達不能な状態、**実行** ノードを起動して登録リクエストを送信、**結果** ノードはスタンドアロンモードで動作を継続する

---

### ユーザーストーリー2 - 管理者によるノード承認 (優先度: P1)

管理者として、承認待ちノードを確認し、信頼できるノードを承認したい。承認後、そのノードは推論リクエストを受け付けるようになる。

**この優先度の理由**: 承認フローはセキュリティの要であり、不正ノードの参加を防ぐために必須。

**独立テスト**: ダッシュボードからPending状態のノードを承認し、そのノードに推論リクエストがルーティングされることを確認する。

**受け入れシナリオ**:

1. **前提** Pending状態のノードが1台存在、**実行** 管理者がダッシュボードで「承認」ボタンをクリック、**結果** ノードは「Online」または「Registering」状態に遷移し、推論リクエストの受付が開始される
2. **前提** ノードのモデル同期が未完了の状態で承認、**実行** 管理者が承認、**結果** ノードは「Registering」状態となり、モデル同期完了後に「Online」に遷移する
3. **前提** 管理者以外のユーザーがログイン中、**実行** 承認操作を試みる、**結果** 権限不足エラーで操作が拒否される

---

### ユーザーストーリー3 - 管理者によるノード拒否 (優先度: P2)

管理者として、不審なノードや誤って登録されたノードを拒否（削除）したい。拒否されたノードはシステムから完全に削除される。

**この優先度の理由**: 不正ノードや誤登録ノードを排除する手段が必要。承認機能の補完として重要。

**独立テスト**: ダッシュボードからPending状態のノードを拒否し、ノード一覧から削除されることを確認する。

**受け入れシナリオ**:

1. **前提** Pending状態のノードが1台存在、**実行** 管理者がダッシュボードで「拒否」ボタンをクリック、**結果** ノードはシステムから削除され、ダッシュボードに表示されなくなる
2. **前提** Online状態のノードが存在、**実行** 管理者が削除操作を試みる、**結果** 確認ダイアログが表示され、確認後に削除される
3. **前提** 管理者以外のユーザーがログイン中、**実行** 拒否操作を試みる、**結果** 権限不足エラーで操作が拒否される

---

### ユーザーストーリー4 - 承認前ノードへのリクエスト遮断 (優先度: P1)

エンドユーザーとして、推論リクエストを送信した際、承認済みのノードにのみリクエストがルーティングされることを期待する。

**この優先度の理由**: セキュリティ上、未承認ノードへのリクエストルーティングは許可されない。これはシステムの信頼性に直結する。

**独立テスト**: Pending状態のノードのみが存在する状態で推論リクエストを送信し、「利用可能なノードがない」エラーが返されることを確認する。

**受け入れシナリオ**:

1. **前提** Pending状態のノード1台とOnline状態のノード1台が存在、**実行** 推論リクエストを送信、**結果** Online状態のノードにのみリクエストがルーティングされる
2. **前提** Pending状態のノードのみが存在、**実行** 推論リクエストを送信、**結果** 「利用可能なノードがありません」エラーが返される
3. **前提** Registering状態のノードのみが存在、**実行** 推論リクエストを送信、**結果** 「利用可能なノードがありません」エラーが返される（モデル同期完了まで待機が必要）

---

### エッジケース

- ノード登録中にルーターが再起動した場合、登録状態は永続化されており、再起動後も維持される
- 同一ノード（同一ID）から再登録リクエストが来た場合、既存情報が更新される（重複登録されない）
- ノードがOffline状態から復帰した場合、以前の承認状態は維持され、Registering状態から再開する
- 複数の管理者が同時に同じノードを承認/拒否しようとした場合、先に処理された操作が優先される

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはノードからの登録リクエストを受け付け、初期状態を「Pending」として保存する必要がある
- **FR-002**: システムはGPUを搭載していないノードの登録を拒否する必要がある
- **FR-003**: 管理者はPending状態のノードを承認し、推論リクエストの受付を開始させることができる必要がある
- **FR-004**: 管理者はPending状態のノードを拒否（削除）できる必要がある
- **FR-005**: システムはPending状態およびRegistering状態のノードに推論リクエストをルーティングしてはならない
- **FR-006**: システムは承認/拒否操作を管理者権限を持つユーザーのみに制限する必要がある
- **FR-007**: システムはノードの状態（Pending/Registering/Online/Offline）をダッシュボードに表示する必要がある
- **FR-008**: システムはルーター到達不能時、ノードがスタンドアロンモードで動作を継続できる必要がある

### 主要エンティティ

- **ノード (Node)**: LLM推論を実行するコンピューティングリソース。ID、IPアドレス、ポート、GPU情報、状態（Pending/Registering/Online/Offline）を持つ
- **ノード状態 (NodeStatus)**: ノードのライフサイクル状態。Pending（承認待ち）→ Registering（モデル同期中）→ Online（稼働中）⇔ Offline（オフライン）の遷移を持つ
- **管理者 (Admin)**: ノードの承認/拒否権限を持つユーザー

---

## スコープ外 *(オプション)*

以下の機能は本仕様のスコープ外とし、将来のバージョンで対応予定:

- 自動承認機能（IPアドレスベース、トークンベース等）
- 承認待ちノードの通知機能（Slack/Email等）
- 承認タイムアウト（一定時間後の自動削除）
- バッチ承認/拒否機能

---

## 前提条件 *(該当する場合)*

この機能は以下を前提とします:

- ルーターとノードは同一ネットワーク内、または相互に到達可能なネットワークに配置されている
- ノードはルーターのAPIエンドポイントに対してHTTPリクエストを送信できる
- 管理者はダッシュボードにログインしてノード管理操作を行う

---

## 依存関係 *(該当する場合)*

この機能は以下に依存します:

- ルーターの認証・認可機能（Admin権限の判定）
- ダッシュボードUI（ノード一覧表示、承認/拒否ボタン）
- ノード側の登録クライアント（RouterClient）

---

## 成功基準 *(必須)*

以下の成功基準を満たす必要があります:

1. 新規ノードの登録から承認完了まで、管理者が3クリック以内で完了できる
2. 承認前のノードに推論リクエストがルーティングされる確率が0%である
3. GPU未搭載ノードの登録拒否率が100%である
4. ルーター到達不能時、ノードが5秒以内にスタンドアロンモードに切り替わる
5. ノード状態の変更がダッシュボードに5秒以内に反映される
