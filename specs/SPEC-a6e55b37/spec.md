# 機能仕様書: llmlb 自動アップデート（承認後に更新して再起動）

**機能ID**: `SPEC-a6e55b37`  
**作成日**: 2026-02-10  
**ステータス**: ✅ 実装完了（手動検証待ち） (2026-02-10)  
**入力**: ユーザー説明: "llmlbの自動アップデートに対応したい。アップデート通知→承認したら更新して再起動。リクエスト処理中はペンディングし、完了後に更新。Ollamaの方式に合わせたい。"

## ユーザーシナリオ＆テスト *(必須)*

### ユーザーストーリー1 - 更新の検知と通知 (優先度: P1)

運用者として、llmlb に新しいバージョンが公開されたら、それを検知してダッシュボードやトレイで通知してほしい。更新の存在に気付けないと、セキュリティ/機能改善を取り逃がすため。

**独立テスト**: GitHub Releases を模擬し、最新タグが現行より新しい場合に `update available` 状態になること。

**受け入れシナリオ**:

1. **前提** 現行 `vA.B.C`、最新 `vX.Y.Z`（X.Y.Z > A.B.C）、**実行** llmlb を起動、**結果** ダッシュボード/トレイに「Update available: vX.Y.Z」が表示される
2. **前提** 最新が現行以下、**実行** llmlb を起動、**結果** 更新通知は表示されない（Up to date）
3. **前提** 更新有無にかかわらず、**実行** ダッシュボードを開く、**結果** ヘッダーに `Current vA.B.C` が常時表示される

---

### ユーザーストーリー2 - 承認したら更新して再起動 (優先度: P1)

運用者として、更新を承認したら、llmlb が自動で更新を適用し再起動してほしい。手動更新は手順ミスや停止時間増につながるため。

**独立テスト**: 承認 API を呼ぶと更新状態が「ドレイン開始」へ遷移すること、適用フェーズで内部アップデータを起動すること。

**受け入れシナリオ**:

1. **前提** 更新が利用可能、**実行** 「Restart to update」を押す、**結果** ドレイン開始→適用→再起動する

---

### ユーザーストーリー3 - リクエスト処理中はペンディング（ドレイン） (優先度: P1)

運用者として、更新承認後に処理中の推論リクエストがある場合は、それらが完了するまで更新を待ってほしい。途中で落ちるとクライアントに障害を与えるため。

**独立テスト**: 推論リクエストが処理中の間は更新が「Draining」のままで、完了した瞬間に適用へ進むこと。

**受け入れシナリオ**:

1. **前提** 推論リクエストが処理中（ストリーミング含む）、**実行** 更新を承認、**結果** 既存リクエストは完走し、完了後に更新が適用される
2. **前提** 更新承認後、**実行** 新規の推論リクエストを送る、**結果** 503（Retry-After付き）で拒否される

---

### ユーザーストーリー4 - OS/インストール形態に応じて適用方法が変わる (優先度: P2)

運用者として、macOS/Windows/Linux の違いや、`.pkg/.msi` インストールと `tar.gz/zip` 展開の違いを意識せずに、可能な範囲で自動更新してほしい。Ollama のように OS ごとに更新方法が変わることは許容する。

**独立テスト**: アセット選定が OS/arch に一致するファイルを選べること。書き込み不可の場合にインストーラ方式へフォールバックすること。

**受け入れシナリオ**:

1. **前提** `tar.gz/zip` 展開で実行中、**実行** 更新承認、**結果** バイナリ置換で更新→再起動する
2. **前提** macOS `.pkg` で `/usr/local/bin/llmlb` 実行中、**実行** 更新承認、**結果** `.pkg` を実行して更新→再起動する（権限が必要ならプロンプトが出る）
3. **前提** Windows `.msi` で Program Files 実行中、**実行** 更新承認、**結果** `.msi` を実行して更新→再起動する（UACが出る）
4. **前提** Linux で書き込み不可のパスに配置、**実行** 更新承認、**結果** 自動適用は失敗し、手動更新の手順が表示される（サービス自体は継続）

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは GitHub Releases の最新バージョンを検知できる
- **FR-002**: システムは更新が利用可能な場合に、ダッシュボードと（macOS/Windows）トレイで通知する
- **FR-003**: ユーザーが更新を承認した場合、システムは新規推論リクエストを 503 で拒否し、処理中リクエストが完了するまで待機する
- **FR-004**: 処理中リクエストが完了した時点で、システムは更新を適用し再起動する
- **FR-005**: OS/インストール形態に応じて適用方式を切り替える（ポータブル置換 / インストーラ実行 / 手動誘導）
- **FR-006**: システムはダッシュボードヘッダーに、現在実行中バージョン（`/api/system` の `version`）を更新有無に関係なく常時表示する

### 非機能要件

- **NFR-001**: 更新チェック/ダウンロードは通常の推論処理をブロックしない（バックグラウンド）
- **NFR-002**: 更新失敗時にサービスを停止させない（状態表示 + 手動誘導）
- **NFR-003**: 更新承認後のドレイン状態は API で観測できる

## スコープ外 *(オプション)*

- 自動でのモデル更新
- 更新ファイルの署名検証・完全なサプライチェーン保証（将来拡張）
- Linux の systemd サービス定義の自動更新（運用者手動）
