# 機能仕様書: ダッシュボードメトリクスの永続化と復元

**機能ID**: `SPEC-ba72f693`
**作成日**: 2026-02-24
**ステータス**: 下書き
**入力**: ユーザー説明: "ダッシュボードメトリクスの永続化と復元 — ダッシュボードが表示するメトリクス値（リクエストカウンタ、レイテンシ、TPS、リクエスト履歴タイムライン、平均レスポンス時間）がサーバー再起動後も正しく表示され、リアルタイムでも正確に更新されることを保証する。根本課題はインメモリキャッシュとDB間の同期不足およびDB永続化データの起動時復元ロジックの欠如。"

## ユーザーシナリオ＆テスト

### ユーザーストーリー1 - リクエストカウンタのリアルタイム反映 (優先度: P1)

管理者として、ダッシュボードのエンドポイント一覧テーブルに表示される
リクエスト数が、リクエスト処理のたびにリアルタイムで更新されてほしい。
画面をリロードしなくても最新のリクエスト数を確認し、
エンドポイントの稼働状況を即座に把握するため。

**この優先度の理由**: リクエスト数はダッシュボードで最も頻繁に参照される
基本指標であり、リアルタイム性が欠けるとシステム監視の信頼性が損なわれる。

**独立テスト**: エンドポイントにリクエストを送信した直後に
ダッシュボードAPIを呼び出し、返却されるリクエスト数が即座に
増加していることを確認するだけで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** エンドポイントAのリクエスト数が10件である、
   **実行** エンドポイントAに成功リクエストを1件送信する、
   **結果** ダッシュボードAPIのエンドポイント一覧でAのリクエスト数が
   即座に11件と返却される（ページリロード不要）
2. **前提** エンドポイントAのリクエスト数が10件（成功8・失敗2）である、
   **実行** エンドポイントAに失敗リクエストを1件送信する、
   **結果** リクエスト数が11件（成功8・失敗3）と即座に反映される
3. **前提** エンドポイントAのリクエスト数が50件である、
   **実行** サーバーを再起動する、
   **結果** 再起動後もリクエスト数が50件のまま維持される

---

### ユーザーストーリー2 - オフラインエンドポイントのレイテンシ保持 (優先度: P1)

管理者として、一時的にオフラインになったエンドポイントの
最後に計測されたレイテンシ値がダッシュボードに表示され続けてほしい。
オフラインになっただけでレイテンシが消えると、復帰後の比較や
パフォーマンス傾向の把握ができなくなるため。

**この優先度の理由**: レイテンシはエンドポイント選択の根拠となる
重要指標であり、一時的な接続断でデータが失われることは
運用判断を妨げる深刻な問題。

**独立テスト**: オンラインのエンドポイントをオフラインに遷移させ、
その後ダッシュボードAPIでレイテンシ値が保持されていることを
確認するだけでテスト可能。

**受け入れシナリオ**:

1. **前提** エンドポイントAがオンラインでレイテンシが120msである、
   **実行** エンドポイントAがヘルスチェック失敗でオフラインになる、
   **結果** ダッシュボードでエンドポイントAのレイテンシが
   120msのまま表示される（"-"にならない）
2. **前提** エンドポイントAがオフラインでレイテンシ120msが保持されている、
   **実行** エンドポイントAが再度オンラインになりレイテンシ95msが計測される、
   **結果** レイテンシが95msに更新される

---

### ユーザーストーリー3 - 平均レスポンス時間の再起動後復元 (優先度: P1)

管理者として、サーバー再起動後もダッシュボードの
平均レスポンス時間（Avg Response Time）カードに
有意な値が表示されてほしい。再起動のたびに"-"にリセットされると、
サービスの応答性能を継続的に監視できないため。

**この優先度の理由**: 平均レスポンス時間はサービス品質の代表指標であり、
再起動のたびに失われるとSLA監視が途切れる。

**独立テスト**: リクエスト処理後にサーバーを再起動し、
ダッシュボードAPIの概要情報で平均レスポンス時間が
"-"ではなく有意な数値として返却されることを確認する。

**受け入れシナリオ**:

1. **前提** 複数のエンドポイントがオンラインでレイテンシが計測済みである、
   **実行** サーバーを再起動してダッシュボード概要を取得する、
   **結果** 平均レスポンス時間カードにオンラインエンドポイントの
   レイテンシから算出された値が表示される（"-"ではない）
2. **前提** 全エンドポイントがオフラインである、
   **実行** ダッシュボード概要を取得する、
   **結果** 平均レスポンス時間は"-"と表示される（計算不能のため）

---

### ユーザーストーリー4 - TPSの再起動後復元 (優先度: P2)

管理者として、サーバー再起動後もダッシュボードの
TPS（秒間生成トークン数）カラムに当日の実績値が
表示されてほしい。再起動のたびにTPSが全て"—"に
リセットされると、推論性能の監視が途切れるため。

**この優先度の理由**: TPSは推論性能の定量的指標として重要だが、
再起動前に蓄積されたEMA値の厳密な復元は困難であり、
日次集計からの近似値で実用上十分。

**独立テスト**: リクエスト処理後にサーバーを再起動し、
ダッシュボードAPIでTPS値が"—"ではなく
当日の集計データから復元された値として返却されることを確認する。

**受け入れシナリオ**:

1. **前提** エンドポイントAで当日100トークン/2000msの処理実績がある、
   **実行** サーバーを再起動してTPS情報を取得する、
   **結果** エンドポイントAのTPS値が約50 tok/sとして復元される
2. **前提** 当日の処理実績がない新規登録エンドポイントである、
   **実行** サーバーを再起動してTPS情報を取得する、
   **結果** TPS値は"—"（未計測）として表示される

---

### ユーザーストーリー5 - リクエスト履歴タイムラインの再起動後復元 (優先度: P2)

管理者として、サーバー再起動後もダッシュボードの
リクエスト履歴タイムライン（直近60分の分単位グラフ）に
再起動前のデータが表示されてほしい。再起動のたびに
全ゼロにリセットされると、直近のトラフィック傾向を見失うため。

**この優先度の理由**: リクエスト履歴はトラフィック傾向の把握に有用だが、
60分のウィンドウは時間経過で自然に更新されるため、
カウンタやレイテンシほど永続性の欠如が致命的ではない。

**独立テスト**: リクエスト送信後にサーバーを再起動し、
ダッシュボードAPIのリクエスト履歴が全ゼロではなく
再起動前のデータを含むことを確認する。

**受け入れシナリオ**:

1. **前提** 直近30分間にリクエスト処理が行われた、
   **実行** サーバーを再起動してリクエスト履歴を取得する、
   **結果** 再起動前の分単位データが復元され、全ゼロではない
2. **前提** 60分以上前のリクエストデータのみ存在する、
   **実行** サーバーを再起動してリクエスト履歴を取得する、
   **結果** 60分ウィンドウ外のデータは表示されず、全ゼロとなる

---

### エッジケース

- サーバー再起動が極めて短時間（数秒）で完了した場合、
  メトリクスの重複カウントは発生しないか?
  → DB永続化データからの復元であり、インメモリ累積との重複は生じない
- DBが破損または空の状態でサーバーが起動した場合はどうなるか?
  → 全メトリクスがゼロ/未計測として表示され、
  エラーにはならない（グレースフルデグラデーション）
- 日付変更（0:00）をまたいでサーバーが再起動した場合、
  TPS復元は正しく動作するか?
  → 当日の日次集計データのみを参照するため、
  前日分は含まれず当日実績がなければ未計測となる
- レイテンシ値がNULLのまま一度もヘルスチェックに成功していない
  エンドポイントがオフラインになった場合は?
  → 保持すべき値がないため、レイテンシは引き続きNULL（"-"表示）

## 要件

### 機能要件

- **FR-001**: システムはリクエスト処理完了時に、DB上のリクエストカウンタと
  インメモリキャッシュのカウンタを同時に更新する必要がある
- **FR-002**: システムはエンドポイントがオフラインに遷移した際、
  最後に計測されたレイテンシ値をDBおよびキャッシュ上で保持する必要がある
- **FR-003**: システムはダッシュボード概要の平均レスポンス時間について、
  インメモリ計算値がない場合にオンラインエンドポイントの
  永続化済みレイテンシから算出するフォールバックを提供する必要がある
- **FR-004**: システムは起動時に当日の日次集計データからTPS状態を
  復元する必要がある
- **FR-005**: システムは起動時にDBから直近60分のリクエスト履歴を
  読み込み、インメモリのタイムライン構造に投入する必要がある
- **FR-006**: 復元処理が失敗した場合でも、システムは正常に起動し
  メトリクスをゼロ/未計測状態から開始できる必要がある
  （グレースフルデグラデーション）

### 主要エンティティ

- **リクエストカウンタ**: エンドポイントに紐づく累計リクエスト数
  （合計・成功・失敗）。DBとインメモリキャッシュの両方に保持され、
  リクエスト処理のたびに同期更新される
- **レイテンシ値**: エンドポイントのヘルスチェックで計測された
  応答時間（ミリ秒）。オフライン遷移時も既存値を保持する
- **TPS状態**: エンドポイント×モデル単位の秒間トークン生成速度。
  インメモリのEMA値と、日次集計テーブルの累積値の2層で管理される
- **リクエスト履歴**: 分単位の成功/失敗リクエスト数。
  インメモリのリングバッファ（60分ウィンドウ）と
  DB上の個別リクエストレコードの2層で管理される

## 成功基準

### 測定可能な結果

- **SC-001**: リクエスト送信後、ダッシュボードAPIの次回ポーリング
  （5秒以内）でリクエストカウンタが更新されている
- **SC-002**: エンドポイントがオフラインに遷移した後も、
  ダッシュボードに直前のレイテンシ値が表示され続ける
- **SC-003**: サーバー再起動後、ダッシュボード概要の
  平均レスポンス時間が"-"ではなく数値で表示される
  （オンラインエンドポイントが1つ以上ある場合）
- **SC-004**: サーバー再起動後、当日に処理実績のある
  エンドポイントのTPS値が"—"ではなく数値で表示される
- **SC-005**: サーバー再起動後、直近60分以内のリクエスト履歴が
  全ゼロではなく復元されている（再起動前にリクエストがあった場合）

## 関連仕様

- [SPEC-712c20cf](../SPEC-712c20cf/spec.md): 管理ダッシュボード
  — ダッシュボードUI全体の統括仕様
- [SPEC-8c32349f](../SPEC-8c32349f/spec.md): エンドポイント単位
  リクエスト統計 — リクエストカウンタと日次集計の基盤
- [SPEC-4bb5b55f](../SPEC-4bb5b55f/spec.md): エンドポイント×モデル
  単位TPS可視化 — TPS計測とダッシュボード表示
- [SPEC-fbc50d97](../SPEC-fbc50d97/spec.md): リクエスト/レスポンス
  履歴保存 — リクエスト履歴の永続化基盤
