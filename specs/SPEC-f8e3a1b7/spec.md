# SPEC-f8e3a1b7: llmlb アーキテクチャ刷新

## 概要

llmlbのコアアーキテクチャを刷新し、設計方針と実装の整合性を確保する。
Node型の完全廃止、負荷分散戦略の明確化、エラーハンドリングの強化を行う。

## ビジネス価値

- **安定性向上**: unwrap()パニックの除去により本番環境での予期せぬクラッシュを防止
- **保守性向上**: Node型廃止とEndpoint型への一本化でコードベースを簡素化
- **柔軟性向上**: CPU推論許容とエンドポイントタイプ廃止で多様なバックエンド対応
- **予測可能性向上**: レイテンシベース負荷分散の明文化で動作を予測可能に

## ユーザーストーリー

### US-001: エンドポイント管理者

```gherkin
As an エンドポイント管理者
I want CPU推論エンドポイントも登録できること
So that GPU非搭載のサーバーも活用できる
```

### US-002: APIユーザー

```gherkin
As an APIユーザー
I want エラー時にOpenAI互換形式でレスポンスを受け取ること
So that 既存のOpenAIクライアントライブラリで正しくエラーハンドリングできる
```

### US-003: 運用担当者

```gherkin
As an 運用担当者
I want 最もレイテンシが低いエンドポイントにリクエストが振り分けられること
So that ユーザーに高速なレスポンスを提供できる
```

### US-004: 開発者

```gherkin
As an 開発者
I want Node型が完全に廃止されEndpoint型に統一されていること
So that コードベースの理解とメンテナンスが容易になる
```

## 機能要件

### FR-001: CPU推論許容

- エンドポイント登録時にGPU必須チェックを行わない
- ダッシュボードの「GPU」欄を「デバイス」に改名
- GPU情報がない場合は「デバイス」欄を非表示または「-」表示

### FR-002: /v0/system API

- xLLM固有のシステム情報APIを`/v0/system`に配置
- エンドポイント登録時に全エンドポイントに対して`/v0/system`を試行
- 応答があればデバイス情報（GPU等）を取得・保存
- 応答がなくても登録を続行（OpenAI互換エンドポイントとして扱う）
- ヘルスチェック時には`/v0/system`を呼び出さない

### FR-003: エンドポイントタイプ廃止

- `endpoint_type`フィールドを廃止
- 全エンドポイントをOpenAI互換APIとして統一的に扱う
- `/v0/system`応答の有無でxLLM判定（UI表示用のみ）

### FR-004: レイテンシベース負荷分散

- 推論リクエスト成功時にレスポンス時間を計測
- 指数移動平均（EMA、α=0.2）でレイテンシを更新
- エンドポイント選択時はレイテンシ昇順でソート
- 同一レイテンシの場合はラウンドロビンでタイブレーク
- 新規エンドポイントはデフォルト値（無限大）で開始
- オフライン時はレイテンシを無限大にリセット
- レイテンシ値はSQLiteに永続化

### FR-005: OpenAI互換エラーレスポンス

- 全APIエラーをOpenAI互換形式で返却

```json
{
  "error": {
    "message": "エラーメッセージ",
    "type": "invalid_request_error",
    "code": "invalid_api_key"
  }
}
```

### FR-006: Node型完全廃止

- `Node`型を削除し`Endpoint`型に統一
- `NodeRegistry`を削除し`EndpointRegistry`に統一
- 関連する16個のignoreテストを有効化・修正

### FR-007: SQLite移行

- エンドポイントデータをJSON形式からSQLite形式に移行
- 起動時に既存JSONファイルがあれば自動マイグレーション
- マイグレーション完了後はJSONファイルを削除
- `endpoints`テーブルに`latency_ms`カラムを追加

### FR-008: unwrap()パニック除去

- models.rs、auth.rsなど全ファイルのunwrap()を除去
- Result型による適切なエラーハンドリングに置換
- expect()も必要に応じてResult型に変更

### FR-009: Visionテスト環境

- LLaVA-1.5-7B-Q4_K_MをCIテスト環境に導入
- 17個のignore中Visionテストを有効化
- Visionモデル用テストプロンプトに100x100テスト画像を使用

### FR-010: ダッシュボードUI更新

- エンドポイント詳細ページにレイテンシ情報を表示
- エンドポイント一覧ページではレイテンシ非表示
- 登録フォームからデバイスタイプ選択を削除（自動取得）

## 非機能要件

### NFR-001: 後方互換性

- 既存のエンドポイント登録APIは動作を維持
- 新規フィールド追加はオプショナルとして対応

### NFR-002: テストカバレッジ

- Node→Endpoint移行で16テスト有効化
- Visionテストで17テスト有効化
- unwrap修正に伴うエラーハンドリングテスト追加

## スコープ外

- 初回推論テストによるレイテンシ計測（登録時テスト廃止）
- エンドポイントタイプの自動検出（廃止）
- ラウンドロビン単独モード（レイテンシ優先に統一）

## 受け入れ基準

1. GPU非搭載エンドポイントが正常に登録できる
2. 全APIエラーがOpenAI互換形式で返却される
3. Node型・NodeRegistryがコードベースから完全削除されている
4. 16個のNode関連テストが有効化され全て成功する
5. unwrap()がクリティカルパスから除去されている
6. エンドポイントデータがSQLiteに保存される
7. レイテンシがリクエスト成功時に更新される
8. ダッシュボードでレイテンシ情報が表示される

## 優先順位

1. **最優先**: Node→Endpoint移行 + SQLite移行（FR-006, FR-007）
2. **高**: unwrap()除去（FR-008）
3. **中**: 負荷分散・レイテンシ（FR-004）
4. **中**: エラー形式統一（FR-005）
5. **低**: Visionテスト環境（FR-009）
6. **低**: UI更新（FR-010）
